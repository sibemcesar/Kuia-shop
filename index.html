<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Kuia+ Shop — Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b;
      --txt:#e5e7eb; --mut:#94a3b8;
      --ac1:#2563eb; --ac2:#22d3ee; --vio:#7c3aed;
      --ok:#10b981; --err:#ef4444;
      --glass: rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--txt);
      min-height:100vh; display:grid; place-items:center; overflow:hidden;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(37,99,235,.25), transparent 60%),
        radial-gradient(1000px 500px at 90% 20%, rgba(34,211,238,.25), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .orb{position:absolute;width:320px;height:320px;border-radius:50%;filter:blur(40px);opacity:.16;pointer-events:none;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.6), transparent 60%);
      animation: float 12s ease-in-out infinite;
    }
    .o1{top:8%;left:6%} .o2{bottom:6%;right:10%;animation-delay:3s} .o3{top:62%;left:18%;animation-delay:6s}
    @keyframes float{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(20px,-30px) scale(1.08)}}

    .card{
      width:380px; max-width:92vw; background:var(--glass); border:1px solid rgba(255,255,255,.12);
      border-radius:16px; backdrop-filter: blur(16px); box-shadow:0 20px 50px rgba(0,0,0,.35);
      overflow:hidden; animation: rise .5s ease-out both;
    }
    @keyframes rise{from{opacity:0; transform:translateY(12px)}to{opacity:1; transform:translateY(0)}}
    .header{padding:18px 20px; border-bottom:1px solid rgba(255,255,255,.1); display:flex; align-items:center; gap:10px}
    .badge{width:30px;height:30px;border-radius:10px;background:linear-gradient(135deg,var(--ac1),var(--ac2));
      display:grid;place-items:center; box-shadow:0 10px 25px rgba(34,211,238,.35);
    }
    .brand{font-weight:800; letter-spacing:.3px}
    .body{padding:18px 20px 8px}
    .subtitle{margin:0 0 12px; font-size:14px; color:var(--mut)}
    .row{display:grid;grid-template-columns:1fr;gap:8px}
    .input{
      width:100%; border-radius:12px; padding:12px; color:var(--txt);
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16);
      outline:none; transition:border-color .2s, transform .06s;
    }
    .input:focus{border-color: rgba(34,211,238,.7); transform: translateY(-1px)}
    .btn{
      width:100%; border:none; border-radius:12px; padding:12px; color:#fff; font-weight:600;
      display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer;
      background:linear-gradient(135deg,var(--ac1),var(--ac2)); box-shadow:0 12px 30px rgba(37,99,235,.35);
      transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn.secondary{background:linear-gradient(135deg,var(--vio),var(--ac2)); box-shadow:0 12px 30px rgba(124,58,237,.35)}
    .btn.neutral{background:linear-gradient(135deg,#334155,#64748b); box-shadow:0 12px 30px rgba(100,116,139,.35)}
    .provider{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px}
    .divider{margin:14px 0 10px; display:flex; align-items:center; gap:10px; color:var(--mut); font-size:12px}
    .divider::before,.divider::after{content:""; height:1px; flex:1; background:rgba(255,255,255,.14)}
    .spinner{width:18px; height:18px; border-radius:50%; border:2px solid rgba(255,255,255,.35); border-top-color:#fff; animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(1turn)}}
    .btn.loading{pointer-events:none; filter:saturate(.8) brightness(.9)}
    .btn.loading .label{opacity:.0} .btn.loading .spinner{opacity:1}
    .label{transition:opacity .2s} .spinner{opacity:0; transition:opacity .2s}

    .profile{padding:14px 20px 18px; border-top:1px solid rgba(255,255,255,.1); display:none; animation:fade .35s ease forwards}
    @keyframes fade{from{opacity:0; transform:translateY(6px)}to{opacity:1; transform:translateY(0)}}
    .userbar{display:grid; grid-template-columns:64px 1fr auto; gap:12px; align-items:center}
    .avatar{width:64px;height:64px;border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.18); box-shadow:0 8px 22px rgba(0,0,0,.25)}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .userinfo{display:flex;flex-direction:column;gap:4px}
    .name{font-weight:800} .email{font-size:12px;color:var(--mut)}
    .logout{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:var(--txt); cursor:pointer; transition:background .2s, transform .08s}
    .logout:hover{background:rgba(255,255,255,.1); transform:translateY(-1px)}
    .note{padding:0 20px 18px; font-size:12px; color:var(--mut)}

    .toast{
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%) translateY(30px);
      background:rgba(16,185,129,.95); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 20px 40px rgba(0,0,0,.35);
      font-size:14px; opacity:0; transition: opacity .25s, transform .25s; z-index:50; min-width:240px; text-align:center
    }
    .toast.error{background:rgba(239,68,68,.95)}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>

  <div class="card">
    <div class="header">
      <div class="badge">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
          <path d="M5 12l4.5 4.5L19 7" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="brand">Kuia+ Shop</div>
    </div>

    <div class="body">
      <p class="subtitle">Entre com sua conta ou teste login anônimo.</p>
      <div class="row">
        <input class="input" id="email" type="email" placeholder="Email">
        <input class="input" id="password" type="password" placeholder="Senha">
        <button class="btn" id="emailLogin">
          <span class="spinner"></span><span class="label">Entrar com Email</span>
        </button>
        <button class="btn neutral" id="emailSignup">
          <span class="spinner"></span><span class="label">Criar Conta com Email</span>
        </button>
      </div>

      <div class="divider">ou</div>

      <div class="provider">
        <button class="btn secondary" id="googleLogin">
          <span class="spinner"></span><span class="label">Entrar com Google</span>
        </button>
        <button class="btn secondary" id="facebookLogin">
          <span class="spinner"></span><span class="label">Entrar com Facebook</span>
        </button>
      </div>

      <button class="btn neutral" id="anonLogin">
        <span class="spinner"></span><span class="label">Entrar como Anônimo</span>
      </button>
    </div>

    <div class="profile" id="profile">
      <div class="userbar">
        <div class="avatar"><img id="userAvatar" src="https://via.placeholder.com/128" alt="Avatar"></div>
        <div class="userinfo">
          <div class="name" id="userName">Usuário</div>
          <div class="email" id="userEmail"></div>
        </div>
        <button class="logout" id="logout">
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M10 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg> Sair
          </span>
        </button>
      </div>
    </div>

    <div class="note">Dica: publique no Vercel ou rode em servidor local. Abrir via file:// não funciona com Auth.</div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, FacebookAuthProvider,
      signInWithPopup, signInWithRedirect, getRedirectResult,
      signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, onAuthStateChanged, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Config Kuia+ Shop
    const firebaseConfig = {
      apiKey: "AIzaSyArmhNnjraGaY017AP5uRcM8w0WWditrIs",
      authDomain: "kuia-shop.firebaseapp.com",
      projectId: "kuia-shop",
      storageBucket: "kuia-shop.appspot.com",
      messagingSenderId: "53786495493",
      appId: "1:53786495493:web:85fa67bd5de1d351b1ea6c",
      measurementId: "G-LTZ8VLN3LN"
    };

    // App/Auth
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    auth.languageCode = 'pt';
    await setPersistence(auth, browserLocalPersistence);

    // Providers (com escopos para email e foto)
    const googleProvider = new GoogleAuthProvider();
    googleProvider.addScope('profile'); googleProvider.addScope('email');

    const facebookProvider = new FacebookAuthProvider();
    facebookProvider.addScope('public_profile'); facebookProvider.addScope('email');

    // UI elements
    const emailEl = document.getElementById("email");
    const passEl  = document.getElementById("password");
    const toastEl = document.getElementById("toast");
    const profile = document.getElementById("profile");
    const userName = document.getElementById("userName");
    const userEmail = document.getElementById("userEmail");
    const userAvatar = document.getElementById("userAvatar");

    const btns = {
      emailLogin: document.getElementById("emailLogin"),
      emailSignup: document.getElementById("emailSignup"),
      googleLogin: document.getElementById("googleLogin"),
      facebookLogin: document.getElementById("facebookLogin"),
      anonLogin: document.getElementById("anonLogin"),
      logout: document.getElementById("logout")
    };

    // Toast
    function toast(msg, type='ok'){
      toastEl.textContent = msg;
      toastEl.classList.toggle('error', type==='error');
      toastEl.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toastEl.classList.remove('show'), 3000);
    }

    // Button loading state
    function setLoading(btn, isLoading){
      btn.classList.toggle('loading', isLoading);
    }

    // Friendly error messages
    function friendlyError(err){
      const code = err?.code || '';
      const map = {
        'auth/invalid-email': 'Email inválido.',
        'auth/missing-email': 'Informe o email.',
        'auth/missing-password': 'Informe a senha.',
        'auth/weak-password': 'Senha muito fraca (mín. 6 caracteres).',
        'auth/email-already-in-use': 'Este email já está em uso.',
        'auth/user-not-found': 'Usuário não encontrado.',
        'auth/wrong-password': 'Senha incorreta.',
        'auth/popup-closed-by-user': 'Popup fechado antes de concluir.',
        'auth/cancelled-popup-request': 'Outra tentativa em andamento.',
        'auth/account-exists-with-different-credential': 'Conta já existe com outro provedor.',
        'auth/operation-not-allowed': 'Operação não permitida (verifique provedores).',
        'auth/unauthorized-domain': 'Domínio não autorizado (verifique Firebase/Meta).'
      };
      return map[code] || (err?.message || 'Algo deu errado. Tente novamente.');
    }

    // Derivar avatar para Facebook se photoURL vier vazio
    function resolveAvatar(user, redirectProfile){
      if (user.photoURL) return user.photoURL;
      const pd = user.providerData?.[0];
      const provider = pd?.providerId || '';
      if (provider.includes('facebook')) {
        const fbId = redirectProfile?.id || pd?.uid;
        if (fbId) return `https://graph.facebook.com/${fbId}/picture?type=large`;
      }
      // fallback
      return "https://via.placeholder.com/128";
    }

    // Atualiza UI do usuário
    function renderUser(user, redirectProfile=null){
      if (user) {
        profile.style.display = "block";
        userName.textContent = user.displayName || redirectProfile?.name || "Usuário";
        userEmail.textContent = user.email || "";
        userAvatar.src = resolveAvatar(user, redirectProfile);
      } else {
        profile.style.display = "none";
        userName.textContent = "Usuário";
        userEmail.textContent = "";
        userAvatar.src = "https://via.placeholder.com/128";
      }
      // persist small hint about provider
      try {
        const p = user?.providerData?.[0]?.providerId || '';
        sessionStorage.setItem('last_provider', p);
      } catch {}
    }

    // Capturar resultado do redirect (Facebook) o mais cedo possível
    let redirectInfo = null;
    try {
      const res = await getRedirectResult(auth);
      if (res?.user) {
        redirectInfo = res.additionalUserInfo?.profile || null;
        toast("Login Facebook OK!");
      }
    } catch (e) {
      toast(friendlyError(e), 'error');
      console.error('Redirect error:', e);
    }

    // Monitorar estado auth
    onAuthStateChanged(auth, (user) => {
      renderUser(user, redirectInfo);
    });

    // Handlers
    btns.emailLogin.onclick = async () => {
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      if (!email) return toast("Informe o email.", 'error');
      if (!pass)  return toast("Informe a senha.", 'error');
      setLoading(btns.emailLogin, true);
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        toast("Login realizado!");
      } catch (e) {
        toast(friendlyError(e), 'error');
        console.error('Email login error:', e);
      } finally {
        setLoading(btns.emailLogin, false);
      }
    };

    btns.emailSignup.onclick = async () => {
      const email = emailEl.value.trim();
      const pass  = passEl.value.trim();
      if (!email) return toast("Informe o email.", 'error');
      if (!pass)  return toast("Informe a senha.", 'error');
      setLoading(btns.emailSignup, true);
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        toast("Conta criada com sucesso!");
      } catch (e) {
        toast(friendlyError(e), 'error');
        console.error('Signup error:', e);
      } finally {
        setLoading(btns.emailSignup, false);
      }
    };

    btns.googleLogin.onclick = async () => {
      setLoading(btns.googleLogin, true);
      try {
        await signInWithPopup(auth, googleProvider);
        toast("Login Google OK!");
      } catch (e) {
        toast(friendlyError(e), 'error');
        console.error('Google error:', e);
      } finally {
        setLoading(btns.googleLogin, false);
      }
    };

    btns.facebookLogin.onclick = async () => {
      setLoading(btns.facebookLogin, true);
      try {
        // Redirect é mais confiável em mobile/in-app
        await signInWithRedirect(auth, facebookProvider);
        // Após redirect, o getRedirectResult acima tratará o retorno.
      } catch (e) {
        toast(friendlyError(e), 'error');
        console.error('Facebook redirect start error:', e);
        setLoading(btns.facebookLogin, false);
      }
    };

    btns.anonLogin.onclick = async () => {
      setLoading(btns.anonLogin, true);
      try {
        await signInAnonymously(auth);
        toast("Sessão anônima iniciada.");
      } catch (e) {
        toast(friendlyError(e), 'error');
        console.error('Anon error:', e);
      } finally {
        setLoading(btns.anonLogin, false);
      }
    };

    btns.logout.onclick = async () => {
      setLoading(btns.logout, true);
      try {
        await signOut(auth);
        toast("Sessão encerrada.");
        redirectInfo = null;
      } catch (e) {
        toast(friendlyError(e), 'error');
        console.error('Logout error:', e);
      } finally {
        setLoading(btns.logout, false);
      }
    };
  </script>
</body>
</html>