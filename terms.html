<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuia+ Admin - Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4845BE',
                        secondary: '#10B981',
                        'secondary-dark': '#059669'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-in': 'bounceIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'progress': 'progress 2s linear'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        bounceIn: { '0%': { transform: 'scale(0.3)', opacity: '0' }, '50%': { transform: 'scale(1.05)' }, '70%': { transform: 'scale(0.9)' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        progress: { '0%': { width: '0%' }, '100%': { width: '100%' } }
                    }
                }
            }
        }
    </script>
    <style>
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        
        .delete-progress {
            position: relative;
            overflow: hidden;
        }
        
        .delete-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--progress, 0%);
            background: linear-gradient(90deg, #ef4444, #dc2626);
            transition: width 0.1s ease;
            z-index: -1;
        }

        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-width: 450px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-300">
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div class="flex justify-between items-center mb-3 border-b border-gray-600 pb-2">
            <strong class="text-yellow-400 flex items-center">
                <span class="mr-2">üêõ</span>Debug Console
            </strong>
            <div class="flex space-x-2">
                <button onclick="clearDebugLogs()" class="text-blue-400 hover:text-blue-300 text-xs">üóëÔ∏è</button>
                <button onclick="exportDebugLogs()" class="text-green-400 hover:text-green-300 text-xs">üìã</button>
                <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">‚ùå</button>
            </div>
        </div>
        <div id="debugContent" class="text-xs space-y-1"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mx-auto mb-6"></div>
            <h2 class="text-2xl font-bold mb-2">üè™ Kuia+ Admin</h2>
            <p id="loadingStatus" class="text-blue-100 mb-4">Verificando acesso...</p>
            <button onclick="toggleDebug()" class="text-xs text-blue-200 hover:text-white px-4 py-2 border border-blue-200 rounded-full transition-all">
                üêõ Debug Mode
            </button>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="fixed inset-0 bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center z-40 hidden">
        <div class="text-center max-w-md text-white animate-scale-in">
            <div class="text-8xl mb-6">üö´</div>
            <h2 class="text-3xl font-bold mb-4">Acesso Negado</h2>
            <p class="text-red-100 mb-8">Voc√™ n√£o tem permiss√£o para acessar o painel administrativo.</p>
            <div class="space-y-4">
                <button onclick="forceAdminAccess()" class="block w-full px-6 py-3 bg-white text-red-600 rounded-lg hover:bg-red-50 transition-all font-semibold">
                    üîì For√ßar Acesso (Super Admin)
                </button>
                <button onclick="location.reload()" class="block w-full px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all border border-red-400">
                    üîÑ Tentar Novamente
                </button>
                <button onclick="toggleDebug()" class="block w-full px-6 py-3 bg-yellow-500 text-yellow-900 rounded-lg hover:bg-yellow-400 transition-all">
                    üêõ Debug Console
                </button>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen">
        <!-- Notification Area -->
        <div id="notificationArea" class="fixed top-4 right-4 z-40 space-y-3 max-w-sm"></div>

        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-primary to-primary-dark rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold text-lg">K+</span>
                            </div>
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-primary to-primary-dark bg-clip-text text-transparent">
                                Kuia+ Admin
                            </h1>
                        </div>
                        <nav class="hidden lg:flex space-x-1">
                            <button id="dashboardBtn" class="nav-btn bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üìä Dashboard
                            </button>
                            <button id="productsBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üì¶ Produtos
                            </button>
                            <button id="categoriesBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üìÇ Categorias
                            </button>
                            <button id="ordersBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üõí Pedidos
                            </button>
                            <button id="chatBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium relative transition-all">
                                üí¨ Chat
                                <span id="chatNotification" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden notification-badge">0</span>
                            </button>
                            <button id="notificationsBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üîî Notifica√ß√µes
                            </button>
                            <button id="usersBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üë• Usu√°rios
                            </button>
                            <button id="reportsBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                üìà Relat√≥rios
                            </button>
                            <button id="settingsBtn" class="nav-btn text-gray-700 hover:bg-gray-100 px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                ‚öôÔ∏è Configura√ß√µes
                            </button>
                        </nav>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleDebug()" class="px-3 py-1 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all">
                            üêõ
                        </button>
                        <div id="connectionIndicator" class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span class="text-xs text-gray-500">Conectando...</span>
                        </div>
                        <div class="relative">
                            <button id="adminMenuBtn" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100 transition-all">
                                <img id="adminAvatar" src="" alt="Admin" class="w-8 h-8 rounded-full border-2 border-primary">
                                <span id="adminName" class="text-sm font-medium text-gray-700 hidden md:block">Admin</span>
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="adminMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-gray-200 z-50 animate-scale-in">
                                <div id="adminMenuContent">
                                    <!-- Content will be populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Mobile Navigation -->
        <div class="lg:hidden bg-white border-b border-gray-200 sticky top-0 z-30">
            <div class="flex overflow-x-auto px-4 py-2 space-x-2">
                <button id="mobileDashboardBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm bg-primary text-white rounded-lg transition-all">üìä Dashboard</button>
                <button id="mobileProductsBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">üì¶ Produtos</button>
                <button id="mobileCategoriesBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">üìÇ Categorias</button>
                <button id="mobileOrdersBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">üõí Pedidos</button>
                <button id="mobileChatBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg relative transition-all">
                    üí¨ Chat
                    <span id="mobileChatNotification" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden notification-badge">0</span>
                </button>
                <button id="mobileNotificationsBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">üîî Notifica√ß√µes</button>
                <button id="mobileUsersBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">üë• Usu√°rios</button>
                <button id="mobileReportsBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">üìà Relat√≥rios</button>
                <button id="mobileSettingsBtn" class="mobile-nav-btn whitespace-nowrap px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-all">‚öôÔ∏è Config</button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Dashboard</h2>
                    <p class="text-gray-600 text-lg">Vis√£o geral completa da sua loja</p>
                </div>

                <!-- Quick Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total de Produtos</p>
                                <p id="totalProducts" class="text-3xl font-bold">0</p>
                                <p id="productsChange" class="text-blue-100 text-xs">+0 hoje</p>
                            </div>
                            <div class="text-4xl opacity-80">üì¶</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Categorias</p>
                                <p id="totalCategories" class="text-3xl font-bold">0</p>
                                <p id="categoriesChange" class="text-green-100 text-xs">+0 hoje</p>
                            </div>
                            <div class="text-4xl opacity-80">üìÇ</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm font-medium">Pedidos Pendentes</p>
                                <p id="pendingOrders" class="text-3xl font-bold">0</p>
                                <p id="pendingChange" class="text-yellow-100 text-xs">Requer aten√ß√£o</p>
                            </div>
                            <div class="text-4xl opacity-80">‚è≥</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Usu√°rios Ativos</p>
                                <p id="totalUsers" class="text-3xl font-bold">0</p>
                                <p id="usersChange" class="text-purple-100 text-xs">Registrados</p>
                            </div>
                            <div class="text-4xl opacity-80">üë•</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-indigo-100 text-sm font-medium">Vendas Hoje</p>
                                <p id="todaySales" class="text-3xl font-bold">0</p>
                                <p id="todaySalesAmount" class="text-indigo-100 text-xs">0 Kz</p>
                            </div>
                            <div class="text-4xl opacity-80">üí∞</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-pink-500 to-rose-500 rounded-xl shadow-lg p-6 text-white transform hover:scale-105 transition-all">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-pink-100 text-sm font-medium">Mensagens</p>
                                <p id="unreadMessages" class="text-3xl font-bold">0</p>
                                <p id="messagesChange" class="text-pink-100 text-xs">N√£o lidas</p>
                            </div>
                            <div class="text-4xl opacity-80">üí¨</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Quick Actions -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">‚ö°</span>A√ß√µes R√°pidas
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <button id="addProductBtn" class="flex flex-col items-center p-6 bg-gradient-to-br from-primary to-primary-dark text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                                <div class="text-3xl mb-2">üì¶</div>
                                <span class="font-medium">Novo Produto</span>
                            </button>
                            <button id="addCategoryBtn" class="flex flex-col items-center p-6 bg-gradient-to-br from-secondary to-secondary-dark text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                                <div class="text-3xl mb-2">üìÇ</div>
                                <span class="font-medium">Nova Categoria</span>
                            </button>
                            <button id="viewOrdersBtn" class="flex flex-col items-center p-6 bg-gradient-to-br from-orange-400 to-orange-500 text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                                <div class="text-3xl mb-2">üõí</div>
                                <span class="font-medium">Ver Pedidos</span>
                            </button>
                            <button id="sendNotificationBtn" class="flex flex-col items-center p-6 bg-gradient-to-br from-purple-400 to-purple-500 text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                                <div class="text-3xl mb-2">üîî</div>
                                <span class="font-medium">Notificar</span>
                            </button>
                            <button id="openChatBtn" class="flex flex-col items-center p-6 bg-gradient-to-br from-pink-400 to-pink-500 text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                                <div class="text-3xl mb-2">üí¨</div>
                                <span class="font-medium">Chat</span>
                            </button>
                            <button id="viewReportsBtn" class="flex flex-col items-center p-6 bg-gradient-to-br from-indigo-400 to-indigo-500 text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105">
                                <div class="text-3xl mb-2">üìà</div>
                                <span class="font-medium">Relat√≥rios</span>
                            </button>
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üîß</span>Status do Sistema
                        </h3>
                        <div class="space-y-4">
                            <div id="connectionStatus" class="flex items-center justify-between p-3 rounded-lg">
                                <span class="text-sm font-medium">Firebase</span>
                                <div class="flex items-center space-x-2">
                                    <div id="firebaseStatus" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                    <span id="firebaseStatusText" class="text-xs text-gray-500">Conectando...</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <span class="text-sm font-medium">Auth</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                    <span class="text-xs text-green-600">Ativo</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                <span class="text-sm font-medium">Admin</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    <span class="text-xs text-blue-600">Verificado</span>
                                </div>
                            </div>
                            <button onclick="runSystemCheck()" class="w-full mt-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all text-sm">
                                üîç Verificar Sistema
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity & Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Recent Orders -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üìã</span>Pedidos Recentes
                        </h3>
                        <div id="recentOrdersList" class="space-y-4 max-h-80 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                <div class="text-3xl mb-2">üì≠</div>
                                <p>Nenhum pedido recente</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Chart -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üìä</span>Vendas da Semana
                        </h3>
                        <div id="salesChart" class="chart-container">
                            <div class="text-center py-20 text-gray-500">
                                <div class="text-3xl mb-2">üìà</div>
                                <p>Gr√°fico de vendas</p>
                                <p class="text-sm">Em desenvolvimento</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 space-y-4 sm:space-y-0">
                    <div>
                        <h2 class="text-4xl font-bold text-gray-800 mb-2">Gest√£o de Produtos</h2>
                        <p class="text-gray-600 text-lg">Gerencie o cat√°logo completo da sua loja</p>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="manageCategoriesBtn" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-dark transition-all flex items-center">
                            <span class="mr-2">üìÇ</span>Categorias
                        </button>
                        <button id="addProductModalBtn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all flex items-center font-semibold shadow-lg">
                            <span class="mr-2">‚ûï</span>Adicionar Produto
                        </button>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Produtos</label>
                            <input type="text" id="productSearch" placeholder="Nome, descri√ß√£o..." 
                                   class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                            <select id="productCategoryFilter" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Todas as categorias</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status do Estoque</label>
                            <select id="productStockFilter" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Todos</option>
                                <option value="in_stock">Em estoque</option>
                                <option value="low_stock">Estoque baixo</option>
                                <option value="out_of_stock">Esgotado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                            <select id="productSortBy" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="name">Nome</option>
                                <option value="price">Pre√ßo</option>
                                <option value="stock">Estoque</option>
                                <option value="created">Data de cria√ß√£o</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Products Grid -->
                <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="col-span-full text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mx-auto mb-4"></div>
                        <p class="text-gray-600">Carregando produtos...</p>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categoriesSection" class="hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 space-y-4 sm:space-y-0">
                    <div>
                        <h2 class="text-4xl font-bold text-gray-800 mb-2">Gest√£o de Categorias</h2>
                        <p class="text-gray-600 text-lg">Organize os produtos por categoria</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="addCategoryModalBtn" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-secondary-dark transition-all flex items-center font-semibold shadow-lg">
                            <span class="mr-2">‚ûï</span>Adicionar Categoria
                        </button>
                    </div>
                </div>

                <!-- Categories Grid -->
                <div id="categoriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="col-span-full text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-secondary border-t-transparent mx-auto mb-4"></div>
                        <p class="text-gray-600">Carregando categorias...</p>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="ordersSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Gest√£o de Pedidos</h2>
                    <p class="text-gray-600 text-lg">Gerencie todos os pedidos dos clientes</p>
                </div>

                <!-- Order Filters -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
                    <div class="flex flex-wrap gap-3 mb-4">
                        <button class="order-filter-btn bg-primary text-white px-4 py-2 rounded-full text-sm font-medium transition-all" data-status="all">
                            Todos os Pedidos
                        </button>
                        <button class="order-filter-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-full text-sm font-medium transition-all" data-status="pending">
                            ‚è≥ Pendentes
                        </button>
                        <button class="order-filter-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-full text-sm font-medium transition-all" data-status="approved">
                            ‚úÖ Aprovados
                        </button>
                        <button class="order-filter-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-full text-sm font-medium transition-all" data-status="delivered">
                            üéâ Entregues
                        </button>
                        <button class="order-filter-btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-full text-sm font-medium transition-all" data-status="rejected">
                            ‚ùå Rejeitados
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="orderSearch" placeholder="Buscar por cliente, email..." 
                               class="px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                        <input type="date" id="orderDateFilter" 
                               class="px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                        <select id="orderSortBy" class="px-4 py-2 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="newest">Mais recentes</option>
                            <option value="oldest">Mais antigos</option>
                            <option value="highest">Maior valor</option>
                            <option value="lowest">Menor valor</option>
                        </select>
                    </div>
                </div>

                <!-- Orders Grid -->
                <div id="ordersGrid" class="space-y-6">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mx-auto mb-4"></div>
                        <p class="text-gray-600">Carregando pedidos...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Central de Chat</h2>
                    <p class="text-gray-600 text-lg">Converse com os clientes em tempo real</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Users List -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Usu√°rios</h3>
                            <p class="text-sm text-gray-500">Clique para iniciar conversa</p>
                        </div>
                        <div id="usersList" class="p-4 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-2 border-primary border-t-transparent mx-auto mb-4"></div>
                                <p>Carregando usu√°rios...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col h-96">
                        <div class="flex items-center justify-between p-6 border-b border-gray-200">
                            <div id="chatHeader" class="flex items-center space-x-3">
                                <div class="text-2xl">üí¨</div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Selecione um usu√°rio</h4>
                                    <p class="text-sm text-gray-500">Para iniciar uma conversa</p>
                                </div>
                            </div>
                            <button id="closeChatBtn" class="text-gray-500 hover:text-gray-700 hidden transition-all">
                                ‚ùå
                            </button>
                        </div>
                        
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 bg-gray-50">
                            <div class="text-center text-gray-500 py-12">
                                <div class="text-6xl mb-4">üí¨</div>
                                <p class="text-lg">Selecione um usu√°rio para come√ßar a conversar</p>
                                <p class="text-sm mt-2">Suporte em tempo real para seus clientes</p>
                            </div>
                        </div>
                        
                        <div id="chatInputContainer" class="p-6 border-t border-gray-200 hidden">
                            <div class="flex space-x-3 mb-3">
                                <input type="text" id="chatInput" placeholder="Digite sua mensagem..." 
                                       class="flex-1 px-4 py-3 text-base border border-gray-300 rounded-xl bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <input type="file" id="chatImageInput" accept="image/*" class="hidden">
                                <button id="chatImageBtn" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all">
                                    üì∑
                                </button>
                                <button id="sendChatBtn" class="px-6 py-3 bg-primary text-white rounded-xl hover:bg-primary-dark transition-all font-semibold">
                                    üì§ Enviar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500">Pressione Enter para enviar ‚Ä¢ Clique em üì∑ para enviar imagem</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notificationsSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Central de Notifica√ß√µes</h2>
                    <p class="text-gray-600 text-lg">Envie notifica√ß√µes e promo√ß√µes para os usu√°rios</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Send Notification Form -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üì§</span>Enviar Notifica√ß√£o
                        </h3>
                        
                        <form id="notificationForm">
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Destinat√°rios</label>
                                        <select id="notificationTarget" class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="all">Todos os usu√°rios</option>
                                            <option value="specific">Usu√°rio espec√≠fico</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Tipo</label>
                                        <select id="notificationType" class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="info">üí° Informa√ß√£o</option>
                                            <option value="success">‚úÖ Sucesso</option>
                                            <option value="warning">‚ö†Ô∏è Aviso</option>
                                            <option value="error">‚ùå Erro</option>
                                            <option value="promotion">üéâ Promo√ß√£o</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="specificUserContainer" class="hidden">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Selecionar Usu√°rio</label>
                                    <select id="specificUser" class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">Carregando usu√°rios...</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">T√≠tulo *</label>
                                    <input type="text" id="notificationTitle" required placeholder="Ex: Nova Promo√ß√£o Especial!" 
                                           class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Mensagem *</label>
                                    <textarea id="notificationMessage" required rows="4" placeholder="Digite sua mensagem detalhada..." 
                                              class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                </div>

                                <button type="submit" id="sendNotificationFormBtn" class="w-full bg-gradient-to-r from-primary to-primary-dark text-white py-4 rounded-xl hover:shadow-lg transition-all font-bold text-lg">
                                    <span id="sendNotificationText">üì§ Enviar Notifica√ß√£o</span>
                                    <span id="sendNotificationLoader" class="hidden">
                                        <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-3"></div>
                                        Enviando...
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Quick Templates -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">‚ö°</span>Templates R√°pidos
                        </h3>
                        
                        <div class="space-y-4">
                            <button onclick="useNotificationTemplate('promotion')" class="w-full text-left p-4 bg-gradient-to-br from-yellow-50 to-orange-50 hover:from-yellow-100 hover:to-orange-100 rounded-xl transition-all transform hover:scale-105">
                                <h4 class="font-bold text-orange-800 flex items-center">
                                    <span class="mr-2">üéâ</span>Promo√ß√£o Especial
                                </h4>
                                <p class="text-sm text-orange-600 mt-1">Anunciar ofertas e descontos</p>
                            </button>

                            <button onclick="useNotificationTemplate('order_update')" class="w-full text-left p-4 bg-gradient-to-br from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 rounded-xl transition-all transform hover:scale-105">
                                <h4 class="font-bold text-blue-800 flex items-center">
                                    <span class="mr-2">üì¶</span>Atualiza√ß√£o de Pedido
                                </h4>
                                <p class="text-sm text-blue-600 mt-1">Status do pedido alterado</p>
                            </button>

                            <button onclick="useNotificationTemplate('new_product')" class="w-full text-left p-4 bg-gradient-to-br from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 rounded-xl transition-all transform hover:scale-105">
                                <h4 class="font-bold text-green-800 flex items-center">
                                    <span class="mr-2">‚ú®</span>Novo Produto
                                </h4>
                                <p class="text-sm text-green-600 mt-1">Lan√ßamento de produtos</p>
                            </button>

                            <button onclick="useNotificationTemplate('maintenance')" class="w-full text-left p-4 bg-gradient-to-br from-red-50 to-pink-50 hover:from-red-100 hover:to-pink-100 rounded-xl transition-all transform hover:scale-105">
                                <h4 class="font-bold text-red-800 flex items-center">
                                    <span class="mr-2">‚ö†Ô∏è</span>Manuten√ß√£o
                                </h4>
                                <p class="text-sm text-red-600 mt-1">Avisos importantes</p>
                            </button>

                            <button onclick="useNotificationTemplate('welcome')" class="w-full text-left p-4 bg-gradient-to-br from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 rounded-xl transition-all transform hover:scale-105">
                                <h4 class="font-bold text-purple-800 flex items-center">
                                    <span class="mr-2">üëã</span>Boas-vindas
                                </h4>
                                <p class="text-sm text-purple-600 mt-1">Dar boas-vindas a novos usu√°rios</p>
                            </button>
                        </div>

                        <!-- Notification History -->
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">üìã</span>Hist√≥rico Recente
                            </h4>
                            <div id="notificationHistory" class="space-y-3 max-h-40 overflow-y-auto">
                                <div class="text-center py-4 text-gray-500">
                                    <p class="text-sm">Nenhuma notifica√ß√£o enviada ainda</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Gest√£o de Usu√°rios</h2>
                    <p class="text-gray-600 text-lg">Gerencie todos os usu√°rios registrados</p>
                </div>

                <!-- Users Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total de Usu√°rios</p>
                                <p id="usersStatsTotal" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üë•</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Ativos Hoje</p>
                                <p id="usersStatsActiveToday" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">‚úÖ</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Novos (7 dias)</p>
                                <p id="usersStatsNewWeek" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üÜï</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">Com Pedidos</p>
                                <p id="usersStatsWithOrders" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="text-4xl opacity-80">üõí</div>
                        </div>
                    </div>
                </div>

                <!-- Users Search and Filter -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="userSearch" placeholder="Buscar por nome, email..." 
                               class="px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                        <select id="userStatusFilter" class="px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Todos os usu√°rios</option>
                            <option value="active">Ativos</option>
                            <option value="inactive">Inativos</option>
                            <option value="new">Novos (7 dias)</option>
                        </select>
                        <select id="userSortBy" class="px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="newest">Mais recentes</option>
                            <option value="oldest">Mais antigos</option>
                            <option value="name">Nome A-Z</option>
                            <option value="email">Email A-Z</option>
                        </select>
                    </div>
                </div>

                <!-- Users Grid -->
                <div id="usersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mx-auto mb-4"></div>
                        <p class="text-gray-600">Carregando usu√°rios...</p>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Relat√≥rios e Analytics</h2>
                    <p class="text-gray-600 text-lg">An√°lise completa do desempenho da sua loja</p>
                </div>

                <!-- Reports Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Sales Report -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üí∞</span>Relat√≥rio de Vendas
                        </h3>
                        <div id="salesReport" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-600">Vendas Hoje</p>
                                    <p id="salesTodayAmount" class="text-2xl font-bold text-green-800">0 Kz</p>
                                </div>
                                <div class="text-center p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-blue-600">Vendas Este M√™s</p>
                                    <p id="salesMonthAmount" class="text-2xl font-bold text-blue-800">0 Kz</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Report -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üìä</span>Produtos Mais Vendidos
                        </h3>
                        <div id="topProductsList" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <p>Sem dados de vendas ainda</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="mr-3">üíæ</span>Backup de Dados
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="createBackup()" class="p-4 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all">
                            <div class="text-2xl mb-2">üíæ</div>
                            <p class="font-medium">Criar Backup</p>
                        </button>
                        <button onclick="showSystemInfo()" class="p-4 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all">
                            <div class="text-2xl mb-2">üìä</div>
                            <p class="font-medium">Info do Sistema</p>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Configura√ß√µes</h2>
                    <p class="text-gray-600 text-lg">Configura√ß√µes do sistema e perfil administrativo</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Profile Settings -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">üë§</span>Perfil Administrativo
                        </h3>
                        <div class="space-y-6">
                            <div class="text-center">
                                <div class="relative inline-block">
                                    <img id="settingsAvatar" src="" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-primary mx-auto">
                                    <button onclick="openProfilePictureModal()" class="absolute bottom-0 right-0 bg-primary text-white rounded-full p-2 hover:bg-primary-dark transition-all">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div id="adminProfileInfo" class="space-y-3">
                                <!-- Content will be populated -->
                            </div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="mr-3">‚öôÔ∏è</span>Configura√ß√µes do Sistema
                        </h3>
                        <div class="space-y-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium text-gray-800">Debug Mode</h4>
                                    <p class="text-sm text-gray-500">Mostrar console de debug</p>
                                </div>
                                <button onclick="toggleDebug()" class="px-4 py-2 bg-yellow-500 text-yellow-900 rounded-lg hover:bg-yellow-400 transition-all">
                                    üêõ Debug
                                </button>
                            </div>

                            <div class="pt-4 border-t border-gray-200">
                                <h4 class="font-medium text-gray-800 mb-4">Backup e Sistema</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="createBackup()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">
                                        üíæ Backup
                                    </button>
                                    <button onclick="runSystemCheck()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                        üîç Verificar
                                    </button>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-gray-200">
                                <button onclick="signOutAdmin()" class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-semibold">
                                    üö™ Sair do Sistema
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto animate-scale-in shadow-2xl">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 id="productModalTitle" class="text-2xl font-bold text-gray-800">Adicionar Produto</h3>
                    <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700 text-2xl transition-all">‚ùå</button>
                </div>
                
                <form id="productForm">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Left Column -->
                        <div class="space-y-6">
                            <!-- Image Upload -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-3">Imagem do Produto</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-primary transition-all">
                                    <input type="file" id="productImage" accept="image/*" class="hidden">
                                    <div id="imagePreview" class="mb-4">
                                        <div class="w-40 h-40 mx-auto bg-gray-200 rounded-xl flex items-center justify-center">
                                            <div class="text-4xl text-gray-400">üì∑</div>
                                        </div>
                                    </div>
                                    <button type="button" onclick="document.getElementById('productImage').click()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all font-semibold">
                                        Escolher Imagem
                                    </button>
                                    <p class="text-xs text-gray-500 mt-3">PNG, JPG, WebP at√© 5MB</p>
                                </div>
                            </div>

                            <!-- Basic Info -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nome do Produto *</label>
                                <input type="text" id="productName" required placeholder="Ex: iPhone 15 Pro Max" 
                                       class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Categoria *</label>
                                <div class="flex space-x-3">
                                    <select id="productCategory" required class="flex-1 px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="">Selecione uma categoria</option>
                                    </select>
                                    <button type="button" onclick="openCategoryModal()" class="px-4 py-3 bg-secondary text-white rounded-lg hover:bg-secondary-dark transition-all" title="Criar categoria">
                                        ‚ûï
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Descri√ß√£o Detalhada</label>
                                <textarea id="productDescription" rows="6" placeholder="Descri√ß√£o completa do produto, caracter√≠sticas, especifica√ß√µes..." 
                                          class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-6">
                            <!-- Pricing -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Pre√ßo Atual *</label>
                                    <div class="relative">
                                        <input type="number" id="productPrice" required min="0" step="0.01" placeholder="0.00" 
                                               class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent pl-12">
                                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">Kz</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Pre√ßo Antigo</label>
                                    <div class="relative">
                                        <input type="number" id="productOldPrice" min="0" step="0.01" placeholder="0.00" 
                                               class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent pl-12">
                                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">Kz</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Quantidade em Estoque *</label>
                                <input type="number" id="productStock" required min="0" value="1" 
                                       class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                        <button type="button" onclick="closeProductModal()" class="px-6 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all font-semibold">
                            Cancelar
                        </button>
                        <button type="submit" id="saveProductBtn" class="px-8 py-3 bg-gradient-to-r from-primary to-primary-dark text-white rounded-lg hover:shadow-lg transition-all font-bold">
                            <span id="saveProductText">üíæ Salvar Produto</span>
                            <span id="saveProductLoader" class="hidden">
                                <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div>
                                Salvando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl max-w-lg w-full animate-scale-in shadow-2xl">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 id="categoryModalTitle" class="text-2xl font-bold text-gray-800">Adicionar Categoria</h3>
                    <button onclick="closeCategoryModal()" class="text-gray-500 hover:text-gray-700 text-2xl transition-all">‚ùå</button>
                </div>
                
                <form id="categoryForm">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Nome da Categoria *</label>
                            <input type="text" id="categoryName" required placeholder="Ex: Eletr√¥nicos, Roupas, Casa..." 
                                   class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">√çcone da Categoria</label>
                            <div class="grid grid-cols-8 gap-3 p-4 border border-gray-300 rounded-lg">
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all bg-primary text-white" data-icon="üìÇ">üìÇ</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üì±">üì±</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üëï">üëï</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üè†">üè†</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üìö">üìö</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="‚öΩ">‚öΩ</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üíÑ">üíÑ</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üíç">üíç</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üëü">üëü</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üçî">üçî</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üíä">üíä</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üöó">üöó</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üß∏">üß∏</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üé∏">üé∏</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üé®">üé®</button>
                                <button type="button" class="icon-btn p-3 text-2xl hover:bg-gray-100 rounded-lg transition-all" data-icon="üê∂">üê∂</button>
                            </div>
                            <input type="hidden" id="categoryIcon" value="üìÇ">
                            <p class="text-sm text-gray-500 mt-2">√çcone selecionado: <span id="selectedIcon" class="text-lg">üìÇ</span></p>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Descri√ß√£o</label>
                            <textarea id="categoryDescription" rows="3" placeholder="Descri√ß√£o opcional da categoria..." 
                                      class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg bg-white text-gray-900 focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-8 pt-6 border-t border-gray-200">
                        <button type="button" onclick="closeCategoryModal()" class="px-6 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all font-semibold">
                            Cancelar
                        </button>
                        <button type="submit" id="saveCategoryBtn" class="px-8 py-3 bg-gradient-to-r from-secondary to-secondary-dark text-white rounded-lg hover:shadow-lg transition-all font-bold">
                            <span id="saveCategoryText">üíæ Salvar Categoria</span>
                            <span id="saveCategoryLoader" class="hidden">
                                <div class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div>
                                Salvando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto animate-scale-in shadow-2xl">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 id="orderDetailTitle" class="text-2xl font-bold text-gray-800">Detalhes do Pedido</h3>
                    <button onclick="closeOrderDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl transition-all">‚ùå</button>
                </div>
                
                <div id="orderDetailContent" class="space-y-8">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Picture Modal -->
    <div id="profilePictureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl max-w-md w-full animate-scale-in shadow-2xl">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-2xl font-bold text-gray-800">Alterar Foto do Perfil</h3>
                    <button onclick="closeProfilePictureModal()" class="text-gray-500 hover:text-gray-700 text-2xl transition-all">‚ùå</button>
                </div>
                
                <div class="text-center">
                    <div class="relative inline-block mb-6">
                        <img id="profilePicturePreview" src="" alt="Preview" class="w-32 h-32 rounded-full object-cover border-4 border-primary">
                        <label for="newProfilePicture" class="absolute bottom-2 right-2 bg-primary text-white rounded-full p-3 cursor-pointer hover:bg-primary-dark transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </label>
                        <input type="file" id="newProfilePicture" accept="image/*" class="hidden">
                    </div>
                    <p class="text-sm text-gray-600 mb-8">Clique no √≠cone da c√¢mera para escolher uma nova foto</p>
                    
                    <div class="flex space-x-4">
                        <button onclick="closeProfilePictureModal()" class="flex-1 px-6 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all font-semibold">
                            Cancelar
                        </button>
                        <button id="saveProfilePictureBtn" class="flex-1 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all font-bold" disabled>
                            <span id="saveProfilePictureText">üíæ Salvar</span>
                            <span id="saveProfilePictureLoader" class="hidden">
                                <div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                                Salvando...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and Main JavaScript -->
    <script type="module">
        console.log('üöÄ Iniciando Kuia+ Admin...');

        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getDatabase, ref, onValue, push, set, remove, update } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArmhNnjraGaY017AP5uRcM8w0WWditrIs",
            authDomain: "kuia-shop.firebaseapp.com",
            projectId: "kuia-shop",
            storageBucket: "kuia-shop.appspot.com",
            messagingSenderId: "53786495493",
            appId: "1:53786495493:web:85fa67bd5de1d351b1ea6c",
            measurementId: "G-LTZ8VLN3LN"
        };

        // Initialize Firebase
        let app, auth, database, firestore;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);
            firestore = getFirestore(app);
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            addDebugLog('Firebase Init Error: ' + error.message);
        }

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let products = {};
        let categories = {};
        let orders = {};
        let users = {};
        let editingCategoryId = null;
        let editingProductId = null;
        let uploadedImageUrl = null;
        let uploadedPhotoURL = null;
        let currentChatId = null;
        let selectedUserId = null;
        let currentOrderFilter = 'all';
        let deleteTimers = new Map();
        let deleteProgressIntervals = new Map();
        let currentSection = 'dashboard';

        // API Key for image upload
        const apiKeyImgBB = 'e073e02267a1f0259cd69c562e780659';

        // Debug system
        let debugLogs = [];
        
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push(logEntry);
            console.log(`üêõ ${message}`);
            
            if (debugLogs.length > 200) {
                debugLogs = debugLogs.slice(-200);
            }
            
            updateDebugPanel();
        }

        function updateDebugPanel() {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugLogs.slice(-30).map(log => 
                    `<div class="text-green-300 mb-1 p-1 hover:bg-gray-800 rounded">${log}</div>`
                ).join('');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('hidden');
        }

        function clearDebugLogs() {
            debugLogs = [];
            updateDebugPanel();
            addDebugLog('Debug logs cleared');
        }

        function exportDebugLogs() {
            const logsText = debugLogs.join('\n');
            navigator.clipboard.writeText(logsText).then(() => {
                addDebugLog('Debug logs copied to clipboard');
                showNotificationToast('Sucesso', 'Logs copiados para a √°rea de transfer√™ncia!', 'success');
            }).catch(err => {
                addDebugLog('Failed to copy logs: ' + err.message);
            });
        }

        // Make functions globally available
        window.toggleDebug = toggleDebug;
        window.clearDebugLogs = clearDebugLogs;
        window.exportDebugLogs = exportDebugLogs;

        addDebugLog('Kuia+ Admin System initialized');

        // Enhanced notification system
        function showNotificationToast(title, message, type = 'info') {
            addDebugLog(`Notification: ${type} - ${title}: ${message}`);
            
            const toast = document.createElement('div');
            const typeColors = {
                info: 'from-blue-500 to-blue-600',
                success: 'from-green-500 to-green-600',
                warning: 'from-yellow-500 to-orange-500',
                error: 'from-red-500 to-red-600'
            };
            
            toast.className = `bg-gradient-to-r ${typeColors[type]} text-white p-4 rounded-xl shadow-xl animate-slide-up border border-white border-opacity-20`;
            toast.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg">${title}</h4>
                        <p class="text-sm opacity-90 mt-1">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:opacity-75 ml-4 text-xl">‚ùå</button>
                </div>
            `;
            
            document.getElementById('notificationArea').appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Connection status monitoring
        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const firebaseStatus = document.getElementById('firebaseStatus');
            const firebaseStatusText = document.getElementById('firebaseStatusText');
            
            try {
                const connectedRef = ref(database, '.info/connected');
                onValue(connectedRef, (snapshot) => {
                    const connected = snapshot.val();
                    addDebugLog(`Firebase connection status: ${connected}`);
                    
                    if (connected) {
                        // Connected
                        if (indicator) {
                            indicator.innerHTML = `
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-xs text-green-600 font-medium">Online</span>
                            `;
                        }
                        if (firebaseStatus) {
                            firebaseStatus.className = 'w-2 h-2 bg-green-500 rounded-full';
                            firebaseStatusText.textContent = 'Conectado';
                            firebaseStatusText.className = 'text-xs text-green-600';
                        }
                    } else {
                        // Disconnected
                        if (indicator) {
                            indicator.innerHTML = `
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                <span class="text-xs text-red-600 font-medium">Offline</span>
                            `;
                        }
                        if (firebaseStatus) {
                            firebaseStatus.className = 'w-2 h-2 bg-red-500 rounded-full';
                            firebaseStatusText.textContent = 'Desconectado';
                            firebaseStatusText.className = 'text-xs text-red-600';
                        }
                    }
                });
            } catch (error) {
                addDebugLog('Connection monitoring error: ' + error.message);
            }
        }

        // Enhanced Long Press Delete System
        function startLongPressDelete(itemId, element, type) {
            addDebugLog(`Starting long press delete for ${type}: ${itemId}`);
            
            if (deleteTimers.has(element)) return;
            
            element.style.position = 'relative';
            element.style.overflow = 'hidden';
            element.classList.add('delete-progress');
            
            const originalContent = element.innerHTML;
            element.innerHTML = 'üóëÔ∏è Mantendo pressionado...';
            element.disabled = true;
            
            let progress = 0;
            const duration = 2000;
            const interval = 50;
            const increment = (interval / duration) * 100;
            
            const progressInterval = setInterval(() => {
                progress += increment;
                element.style.setProperty('--progress', `${progress}%`);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    deleteProgressIntervals.delete(element);
                    executeDelete(itemId, type);
                    resetLongPressElement(element, originalContent);
                }
            }, interval);
            
            const timer = setTimeout(() => {
                executeDelete(itemId, type);
                resetLongPressElement(element, originalContent);
            }, duration);
            
            deleteTimers.set(element, timer);
            deleteProgressIntervals.set(element, progressInterval);
        }

        function cancelLongPressDelete(element) {
            const originalContent = element.getAttribute('data-original') || 'üóëÔ∏è';
            
            if (deleteTimers.has(element)) {
                clearTimeout(deleteTimers.get(element));
                deleteTimers.delete(element);
            }
            
            if (deleteProgressIntervals.has(element)) {
                clearInterval(deleteProgressIntervals.get(element));
                deleteProgressIntervals.delete(element);
            }
            
            resetLongPressElement(element, originalContent);
        }

        function resetLongPressElement(element, originalContent) {
            element.style.removeProperty('--progress');
            element.classList.remove('delete-progress');
            element.style.removeProperty('position');
            element.style.removeProperty('overflow');
            element.innerHTML = originalContent;
            element.disabled = false;
        }

        async function executeDelete(itemId, type) {
            addDebugLog(`Executing delete: ${type} - ${itemId}`);
            
            try {
                switch (type) {
                    case 'product':
                        await deleteProduct(itemId);
                        break;
                    case 'category':
                        await deleteCategory(itemId);
                        break;
                    case 'order':
                        await deleteOrder(itemId);
                        break;
                    default:
                        addDebugLog('Unknown delete type: ' + type);
                }
            } catch (error) {
                addDebugLog('Delete error: ' + error.message);
                showNotificationToast('Erro', 'Erro ao excluir: ' + error.message, 'error');
            }
        }

        // Make long press functions globally available
        window.startLongPressDelete = startLongPressDelete;
        window.cancelLongPressDelete = cancelLongPressDelete;

        // Authentication system
        onAuthStateChanged(auth, async (user) => {
            addDebugLog(`Auth state changed. User: ${user ? user.email : 'null'}`);
            currentUser = user;
            
            if (user) {
                addDebugLog(`User authenticated: ${user.email}, UID: ${user.uid}`);
                await checkAdminAccess();
            } else {
                addDebugLog('No user authenticated, triggering login');
                triggerLogin();
            }
        });

        async function triggerLogin() {
            const provider = new GoogleAuthProvider();
            try {
                addDebugLog('Starting Google sign-in popup');
                const result = await signInWithPopup(auth, provider);
                addDebugLog('Login successful: ' + result.user.email);
            } catch (error) {
                addDebugLog('Login error: ' + error.message);
                showAccessDenied();
            }
        }

        async function checkAdminAccess() {
            try {
                document.getElementById('loadingStatus').textContent = 'Verificando permiss√µes administrativas...';
                addDebugLog('Checking admin access...');
                
                // Check super admin by email
                if (currentUser.email === 'sibemcesar@gmail.com') {
                    addDebugLog('Super admin detected by email');
                    isAdmin = true;
                    await ensureAdminAccess();
                    showAdminPanel();
                    return;
                }
                
                // Check admin documents in both databases
                const [firestoreAdmin, realtimeAdmin] = await Promise.all([
                    checkFirestoreAdmin(),
                    checkRealtimeAdmin()
                ]);
                
                if (firestoreAdmin || realtimeAdmin) {
                    addDebugLog('Admin access confirmed');
                    isAdmin = true;
                    showAdminPanel();
                } else {
                    addDebugLog('No admin access found');
                    showAccessDenied();
                }
                
            } catch (error) {
                addDebugLog('Error checking admin access: ' + error.message);
                showAccessDenied();
            }
        }

        async function checkFirestoreAdmin() {
            try {
                const adminDoc = await getDoc(doc(firestore, 'admins', currentUser.uid));
                const exists = adminDoc.exists();
                addDebugLog(`Firestore admin doc exists: ${exists}`);
                return exists;
            } catch (error) {
                addDebugLog('Firestore admin check error: ' + error.message);
                return false;
            }
        }

        async function checkRealtimeAdmin() {
            return new Promise((resolve) => {
                const adminRef = ref(database, `admins/${currentUser.uid}`);
                onValue(adminRef, (snapshot) => {
                    const exists = snapshot.exists();
                    addDebugLog(`Realtime Database admin doc exists: ${exists}`);
                    resolve(exists);
                }, { onlyOnce: true });
            });
        }

        async function ensureAdminAccess() {
            try {
                addDebugLog('Ensuring admin access...');
                
                const adminData = {
                    email: currentUser.email,
                    name: currentUser.displayName || 'Super Admin',
                    role: 'super_admin',
                    createdAt: Date.now(),
                    lastLogin: Date.now(),
                    permissions: {
                        products: true,
                        categories: true,
                        orders: true,
                        users: true,
                        notifications: true,
                        chat: true,
                        reports: true,
                        settings: true
                    }
                };
                
                await Promise.all([
                    set(ref(database, `admins/${currentUser.uid}`), adminData),
                    setDoc(doc(firestore, 'admins', currentUser.uid), adminData)
                ]);
                
                addDebugLog('Admin access ensured in both databases');
                
            } catch (error) {
                addDebugLog('Error ensuring admin access: ' + error.message);
            }
        }

        async function forceAdminAccess() {
            addDebugLog('Forcing admin access...');
            
            if (!currentUser) {
                addDebugLog('No current user, cannot force access');
                showNotificationToast('Erro', 'Usu√°rio n√£o autenticado', 'error');
                return;
            }
            
            if (currentUser.email !== 'sibemcesar@gmail.com') {
                addDebugLog('User is not super admin, cannot force access');
                showNotificationToast('Erro', 'Apenas sibemcesar@gmail.com pode for√ßar acesso', 'error');
                return;
            }
            
            try {
                await ensureAdminAccess();
                isAdmin = true;
                showAdminPanel();
                showNotificationToast('Sucesso', 'Acesso administrativo for√ßado com sucesso!', 'success');
            } catch (error) {
                addDebugLog('Error forcing admin access: ' + error.message);
                showNotificationToast('Erro', 'Erro ao for√ßar acesso: ' + error.message, 'error');
            }
        }

        window.forceAdminAccess = forceAdminAccess;

        function showAdminPanel() {
            addDebugLog('Showing admin panel...');
            
            updateAdminUI();
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('accessDeniedScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            
            // Initialize all systems
            loadAllData();
            updateConnectionStatus();
            initializeChat();
            setupEventListeners();
            setupFiltersAndSearch();
        }

        function showAccessDenied() {
            addDebugLog('Showing access denied screen');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('accessDeniedScreen').classList.remove('hidden');
        }

        function updateAdminUI() {
            // Update avatar and name
            const avatar = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.email)}&background=5D5CDE&color=fff`;
            document.getElementById('adminAvatar').src = avatar;
            document.getElementById('adminName').textContent = currentUser.displayName || currentUser.email;
            document.getElementById('settingsAvatar').src = avatar;
            
            // Update admin menu
            document.getElementById('adminMenuContent').innerHTML = `
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <img src="${avatar}" alt="Admin" class="w-12 h-12 rounded-full border-2 border-primary">
                        <div>
                            <p class="font-bold text-gray-800">${currentUser.displayName || 'Admin'}</p>
                            <p class="text-sm text-gray-500">${currentUser.email}</p>
                        </div>
                    </div>
                </div>
                <div class="py-2">
                    <button onclick="openProfilePictureModal()" class="w-full text-left px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-all flex items-center">
                        <span class="mr-3">üë§</span>Alterar Foto do Perfil
                    </button>
                    <button onclick="showSection('settings')" class="w-full text-left px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-all flex items-center">
                        <span class="mr-3">‚öôÔ∏è</span>Configura√ß√µes
                    </button>
                    <button onclick="toggleDebug()" class="w-full text-left px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-all flex items-center">
                        <span class="mr-3">üêõ</span>Debug Console
                    </button>
                    <div class="border-t border-gray-200 my-2"></div>
                    <button onclick="signOutAdmin()" class="w-full text-left px-6 py-3 text-sm text-red-600 hover:bg-red-50 transition-all flex items-center">
                        <span class="mr-3">üö™</span>Sair do Sistema
                    </button>
                </div>
            `;
            
            // Update profile info in settings
            document.getElementById('adminProfileInfo').innerHTML = `
                <div class="text-center mb-4">
                    <h4 class="font-bold text-gray-800 text-lg">${currentUser.displayName || 'Admin'}</h4>
                    <p class="text-gray-500">${currentUser.email}</p>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">UID:</span>
                        <span class="font-mono text-xs">${currentUser.uid}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Email Verificado:</span>
                        <span class="${currentUser.emailVerified ? 'text-green-600' : 'text-red-600'}">${currentUser.emailVerified ? '‚úÖ Sim' : '‚ùå N√£o'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">√öltimo Login:</span>
                        <span>${new Date().toLocaleDateString('pt-BR')}</span>
                    </div>
                </div>
            `;
        }

        // Data loading system
        function loadAllData() {
            addDebugLog('Loading all data from Firebase...');
            
            // Load categories
            const categoriesRef = ref(database, 'categories');
            onValue(categoriesRef, (snapshot) => {
                categories = snapshot.val() || {};
                addDebugLog(`Categories loaded: ${Object.keys(categories).length}`);
                renderCategories();
                updateProductCategorySelect();
                updateStats();
            }, (error) => {
                addDebugLog('Error loading categories: ' + error.message);
            });
            
            // Load products
            const productsRef = ref(database, 'products');
            onValue(productsRef, (snapshot) => {
                products = snapshot.val() || {};
                addDebugLog(`Products loaded: ${Object.keys(products).length}`);
                renderProducts();
                updateStats();
            }, (error) => {
                addDebugLog('Error loading products: ' + error.message);
            });

            // Load orders
            const ordersRef = ref(database, 'orders');
            onValue(ordersRef, (snapshot) => {
                orders = snapshot.val() || {};
                addDebugLog(`Orders loaded: ${Object.keys(orders).length}`);
                renderOrders();
                renderRecentOrders();
                updateStats();
            }, (error) => {
                addDebugLog('Error loading orders: ' + error.message);
            });

            // Load users
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                users = snapshot.val() || {};
                addDebugLog(`Users loaded: ${Object.keys(users).length}`);
                renderUsers();
                renderUsersListForChat();
                updateStats();
            }, (error) => {
                addDebugLog('Error loading users: ' + error.message);
            });
        }

        function updateStats() {
            const productsCount = Object.keys(products).length;
            const categoriesCount = Object.keys(categories).length;
            const usersCount = Object.keys(users).length;
            const ordersArray = Object.values(orders);
            const pendingCount = ordersArray.filter(order => order.status === 'pending').length;
            
            // Today's data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            
            const todayOrders = ordersArray.filter(order => order.createdAt >= todayTimestamp);
            const todaySales = todayOrders.length;
            const todaySalesAmount = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            
            // Update dashboard stats
            document.getElementById('totalProducts').textContent = productsCount;
            document.getElementById('totalCategories').textContent = categoriesCount;
            document.getElementById('totalUsers').textContent = usersCount;
            document.getElementById('pendingOrders').textContent = pendingCount;
            document.getElementById('todaySales').textContent = todaySales;
            document.getElementById('todaySalesAmount').textContent = formatPrice(todaySalesAmount);
            
            // Update user stats
            const activeToday = Object.values(users).filter(user => {
                const lastActive = user.lastActive || user.createdAt || 0;
                return lastActive >= todayTimestamp;
            }).length;
            
            const newThisWeek = Object.values(users).filter(user => {
                const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                return (user.createdAt || 0) >= weekAgo;
            }).length;
            
            const usersWithOrders = Object.values(users).filter(user => 
                ordersArray.some(order => order.customer?.userId === user.id)
            ).length;
            
            if (document.getElementById('usersStatsTotal')) {
                document.getElementById('usersStatsTotal').textContent = usersCount;
                document.getElementById('usersStatsActiveToday').textContent = activeToday;
                document.getElementById('usersStatsNewWeek').textContent = newThisWeek;
                document.getElementById('usersStatsWithOrders').textContent = usersWithOrders;
            }
            
            // Update changes indicators
            document.getElementById('productsChange').textContent = `+${productsCount} total`;
            document.getElementById('categoriesChange').textContent = `+${categoriesCount} total`;
            document.getElementById('pendingChange').textContent = pendingCount > 0 ? 'Requer aten√ß√£o' : 'Tudo em dia';
            document.getElementById('usersChange').textContent = `+${usersCount} total`;
            document.getElementById('unreadMessages').textContent = '0'; // Placeholder
            document.getElementById('messagesChange').textContent = 'Nenhuma nova';
            
            addDebugLog(`Stats updated - Products: ${productsCount}, Categories: ${categoriesCount}, Users: ${usersCount}, Orders: ${ordersArray.length}`);
        }

        // Navigation system
        function showSection(section) {
            addDebugLog(`Navigating to section: ${section}`);
            currentSection = section;
            
            // Hide all sections
            ['dashboard', 'products', 'categories', 'orders', 'chat', 'notifications', 'users', 'reports', 'settings'].forEach(sec => {
                document.getElementById(`${sec}Section`).classList.add('hidden');
            });
            
            // Show target section
            document.getElementById(`${section}Section`).classList.remove('hidden');
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('text-gray-700');
            });
            
            // Activate current section button
            const btn = document.getElementById(`${section}Btn`);
            const mobileBtn = document.getElementById(`mobile${section.charAt(0).toUpperCase() + section.slice(1)}Btn`);
            
            if (btn) {
                btn.classList.add('bg-primary', 'text-white');
                btn.classList.remove('text-gray-700');
            }
            
            if (mobileBtn) {
                mobileBtn.classList.add('bg-primary', 'text-white');
                mobileBtn.classList.remove('text-gray-600');
            }
            
            // Load section-specific data
            switch (section) {
                case 'categories':
                    renderCategories();
                    break;
                case 'products':
                    renderProducts();
                    break;
                case 'orders':
                    renderOrders();
                    break;
                case 'users':
                    renderUsers();
                    break;
                case 'reports':
                    loadReports();
                    break;
            }
        }

        // Categories Management
        function renderCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            const categoriesArray = Object.entries(categories).map(([id, category]) => ({ id, ...category }));
            
            if (categoriesArray.length === 0) {
                categoriesGrid.innerHTML = `
                    <div class="col-span-full text-center py-16 animate-fade-in">
                        <div class="text-6xl mb-6">üìÇ</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhuma categoria cadastrada</h3>
                        <p class="text-gray-600 mb-6">Comece criando sua primeira categoria para organizar os produtos</p>
                        <button onclick="openCategoryModal()" class="px-8 py-4 bg-secondary text-white rounded-xl hover:bg-secondary-dark transition-all font-bold text-lg shadow-lg">
                            ‚ûï Criar Primeira Categoria
                        </button>
                    </div>
                `;
                return;
            }

            categoriesGrid.innerHTML = categoriesArray.map(category => {
                const productCount = Object.values(products).filter(p => p.category === category.name).length;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-all transform hover:scale-105 animate-fade-in">
                        <div class="p-6 text-center">
                            <div class="text-5xl mb-4">${category.icon || 'üìÇ'}</div>
                            <h3 class="font-bold text-xl text-gray-800 mb-2">${category.name}</h3>
                            <p class="text-sm text-gray-600 mb-4 line-clamp-2">${category.description || 'Sem descri√ß√£o'}</p>
                            <div class="flex items-center justify-center space-x-2 mb-6">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                    ${productCount} produtos
                                </span>
                            </div>
                            
                            <div class="flex space-x-3 justify-center">
                                <button onclick="editCategory('${category.id}')" class="flex-1 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-semibold">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button 
                                    data-original="üóëÔ∏è Excluir"
                                    onmousedown="startLongPressDelete('${category.id}', this, 'category')" 
                                    onmouseup="cancelLongPressDelete(this)" 
                                    onmouseleave="cancelLongPressDelete(this)"
                                    ontouchstart="startLongPressDelete('${category.id}', this, 'category')" 
                                    ontouchend="cancelLongPressDelete(this)"
                                    class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all font-semibold">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCategoryModal(categoryId = null) {
            addDebugLog(`Opening category modal. Edit ID: ${categoryId}`);
            editingCategoryId = categoryId;
            
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const form = document.getElementById('categoryForm');
            
            // Reset form
            form.reset();
            document.getElementById('categoryIcon').value = 'üìÇ';
            document.getElementById('selectedIcon').textContent = 'üìÇ';
            
            // Reset icon buttons
            document.querySelectorAll('.icon-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('hover:bg-gray-100');
            });
            
            // Set default icon as selected
            const defaultIconBtn = document.querySelector('[data-icon="üìÇ"]');
            if (defaultIconBtn) {
                defaultIconBtn.classList.add('bg-primary', 'text-white');
                defaultIconBtn.classList.remove('hover:bg-gray-100');
            }
            
            if (categoryId && categories[categoryId]) {
                // Edit mode
                title.textContent = 'Editar Categoria';
                const category = categories[categoryId];
                
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryIcon').value = category.icon || 'üìÇ';
                document.getElementById('selectedIcon').textContent = category.icon || 'üìÇ';
                
                // Highlight selected icon
                document.querySelectorAll('.icon-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('hover:bg-gray-100');
                });
                
                const selectedBtn = document.querySelector(`[data-icon="${category.icon}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('bg-primary', 'text-white');
                    selectedBtn.classList.remove('hover:bg-gray-100');
                }
            } else {
                // Add mode
                title.textContent = 'Adicionar Categoria';
            }
            
            modal.classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
            editingCategoryId = null;
        }

        // Enhanced category form submission
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            addDebugLog('Category form submitted');
            
            const saveBtn = document.getElementById('saveCategoryBtn');
            const saveText = document.getElementById('saveCategoryText');
            const saveLoader = document.getElementById('saveCategoryLoader');
            
            // Enhanced validation - garantir que estamos pegando strings v√°lidas
            const nameInput = document.getElementById('categoryName');
            const iconInput = document.getElementById('categoryIcon');
            const descriptionInput = document.getElementById('categoryDescription');
            
            if (!nameInput || !iconInput || !descriptionInput) {
                addDebugLog('Form inputs not found');
                showNotificationToast('Erro', 'Erro no formul√°rio. Recarregue a p√°gina.', 'error');
                return;
            }
            
            const name = nameInput.value ? nameInput.value.trim() : '';
            const icon = iconInput.value || 'üìÇ';
            const description = descriptionInput.value ? descriptionInput.value.trim() : '';
            
            addDebugLog(`Category form data - Name: "${name}", Icon: "${icon}", Description: "${description}"`);
            
            if (!name) {
                showNotificationToast('Erro', 'Por favor, insira o nome da categoria.', 'error');
                return;
            }
            
            if (name.length < 2) {
                showNotificationToast('Erro', 'O nome da categoria deve ter pelo menos 2 caracteres.', 'error');
                return;
            }
            
            // Validar que name √© uma string v√°lida
            if (typeof name !== 'string') {
                addDebugLog('Category name is not a string: ' + typeof name);
                showNotificationToast('Erro', 'Nome da categoria inv√°lido.', 'error');
                return;
            }
            
            // Show loading state
            saveText.classList.add('hidden');
            saveLoader.classList.remove('hidden');
            saveBtn.disabled = true;
            
            try {
                let categoryId;
                
                if (editingCategoryId) {
                    // Garantir que editingCategoryId √© uma string v√°lida
                    categoryId = String(editingCategoryId).trim();
                    addDebugLog(`Editing existing category: ${categoryId}`);
                } else {
                    // Gerar um ID completamente novo e seguro
                    const timestamp = Date.now();
                    const randomId = Math.random().toString(36).substr(2, 9);
                    const safeName = String(name).toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]/g, '_')
                        .replace(/_+/g, '_')
                        .replace(/^_|_$/g, '')
                        .slice(0, 20);
                    
                    categoryId = `${safeName}_${timestamp}_${randomId}`;
                    addDebugLog(`Generated category ID: ${categoryId}`);
                }
                
                // Valida√ß√£o extra robusta do categoryId
                if (!categoryId || typeof categoryId !== 'string' || categoryId.includes('[object') || categoryId.length < 3) {
                    addDebugLog('Invalid category ID detected, generating fallback: ' + categoryId);
                    // Fallback para ID completamente seguro
                    categoryId = `category_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    addDebugLog('Using fallback category ID: ' + categoryId);
                }
                
                // Sanitizar o categoryId final
                categoryId = String(categoryId).replace(/[^a-zA-Z0-9_-]/g, '_');
                
                const categoryData = {
                    id: categoryId,
                    name: name,
                    icon: icon,
                    description: description,
                    updatedAt: Date.now()
                };

                if (!editingCategoryId) {
                    categoryData.createdAt = Date.now();
                }

                addDebugLog(`Saving category to path: categories/${categoryId}`);
                addDebugLog('Category data: ' + JSON.stringify(categoryData));

                // Save to database - garantir que categoryId √© string v√°lida
                const categoryPath = `categories/${categoryId}`;
                addDebugLog(`Firebase path: ${categoryPath}`);
                
                await set(ref(database, categoryPath), categoryData);
                
                // Try to save to Firestore as backup
                try {
                    await setDoc(doc(firestore, 'categories', categoryId), categoryData);
                    addDebugLog('Category saved to Firestore successfully');
                } catch (firestoreError) {
                    addDebugLog('Firestore save failed (non-critical): ' + firestoreError.message);
                }

                const action = editingCategoryId ? 'atualizada' : 'adicionada';
                showNotificationToast('Sucesso', `Categoria "${name}" ${action} com sucesso!`, 'success');
                
                closeCategoryModal();
                
            } catch (error) {
                addDebugLog('Error saving category: ' + error.message);
                showNotificationToast('Erro', 'Erro ao salvar categoria: ' + error.message, 'error');
            } finally {
                saveText.classList.remove('hidden');
                saveLoader.classList.add('hidden');
                saveBtn.disabled = false;
            }
        });

        // Products Management
        function renderProducts() {
            const productsGrid = document.getElementById('productsGrid');
            const productsArray = Object.entries(products).map(([id, product]) => ({ id, ...product }));
            
            if (productsArray.length === 0) {
                productsGrid.innerHTML = `
                    <div class="col-span-full text-center py-16 animate-fade-in">
                        <div class="text-6xl mb-6">üì¶</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhum produto cadastrado</h3>
                        <p class="text-gray-600 mb-6">Comece adicionando produtos para vender em sua loja</p>
                        <button onclick="openProductModal()" class="px-8 py-4 bg-primary text-white rounded-xl hover:bg-primary-dark transition-all font-bold text-lg shadow-lg">
                            ‚ûï Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = productsArray.map(product => {
                const hasDiscount = product.oldPrice && product.oldPrice > product.price;
                const discountPercent = hasDiscount ? Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100) : 0;
                const categoryName = product.category;
                const isLowStock = product.stock <= 5;
                const isOutOfStock = product.stock === 0;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-all transform hover:scale-105 animate-fade-in">
                        <div class="relative aspect-w-1 aspect-h-1 w-full h-48 bg-gray-200">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full flex items-center justify-center">
                                    <div class="text-4xl text-gray-400">üñºÔ∏è</div>
                                </div>`
                            }
                            
                            <!-- Status Badges -->
                            <div class="absolute top-2 left-2 space-y-1">
                                ${hasDiscount ? `
                                    <div class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce-in">
                                        -${discountPercent}%
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Stock Status -->
                            ${isOutOfStock ? `
                                <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center">
                                    <span class="text-white font-bold text-lg">Esgotado</span>
                                </div>
                            ` : isLowStock ? `
                                <div class="absolute top-2 right-2">
                                    <div class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                                        ‚ö†Ô∏è Baixo Estoque
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="p-6">
                            <h3 class="font-bold text-lg text-gray-800 mb-2 line-clamp-2">${product.name}</h3>
                            <p class="text-sm text-gray-600 mb-3">${categoryName || 'Sem categoria'}</p>
                            
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="text-xl font-bold text-primary">${formatPrice(product.price)}</span>
                                ${hasDiscount ? `<span class="text-sm text-gray-400 line-through">${formatPrice(product.oldPrice)}</span>` : ''}
                            </div>
                            
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm ${isOutOfStock ? 'text-red-600' : isLowStock ? 'text-orange-600' : 'text-green-600'} font-medium">
                                    üì¶ ${product.stock} em estoque
                                </span>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button onclick="editProduct('${product.id}')" class="flex-1 bg-blue-50 text-blue-600 py-2 px-3 rounded-lg hover:bg-blue-100 transition-all font-semibold">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button 
                                    data-original="üóëÔ∏è"
                                    onmousedown="startLongPressDelete('${product.id}', this, 'product')" 
                                    onmouseup="cancelLongPressDelete(this)" 
                                    onmouseleave="cancelLongPressDelete(this)"
                                    ontouchstart="startLongPressDelete('${product.id}', this, 'product')" 
                                    ontouchend="cancelLongPressDelete(this)"
                                    class="bg-red-50 text-red-600 py-2 px-3 rounded-lg hover:bg-red-100 transition-all">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openProductModal(productId = null) {
            addDebugLog(`Opening product modal. Edit ID: ${productId}`);
            editingProductId = productId;
            uploadedImageUrl = null;
            
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            const imagePreview = document.getElementById('imagePreview');
            
            // Reset form
            form.reset();
            imagePreview.innerHTML = `
                <div class="w-40 h-40 mx-auto bg-gray-200 rounded-xl flex items-center justify-center">
                    <div class="text-4xl text-gray-400">üì∑</div>
                </div>
            `;
            
            // Update category options
            updateProductCategorySelect();
            
            if (productId && products[productId]) {
                // Edit mode
                title.textContent = 'Editar Produto';
                const product = products[productId];
                
                document.getElementById('productName').value = product.name;
                // Buscar categoria pelo nome
                const categoryId = Object.entries(categories).find(([id, cat]) => cat.name === product.category)?.[0];
                document.getElementById('productCategory').value = categoryId || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productOldPrice').value = product.oldPrice || '';
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productDescription').value = product.description || '';
                
                if (product.image) {
                    imagePreview.innerHTML = `<img src="${product.image}" alt="Preview" class="w-40 h-40 mx-auto rounded-xl object-cover">`;
                    uploadedImageUrl = product.image;
                }
            } else {
                // Add mode
                title.textContent = 'Adicionar Produto';
            }
            
            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            editingProductId = null;
            uploadedImageUrl = null;
        }

        function updateProductCategorySelect() {
            const select = document.getElementById('productCategory');
            const filterSelect = document.getElementById('productCategoryFilter');
            if (!select) return;
            
            const categoriesArray = Object.entries(categories).map(([id, category]) => ({ id, ...category }));
            
            const options = `
                <option value="">Selecione uma categoria</option>
                ${categoriesArray.map(category => 
                    `<option value="${category.id}">${category.icon} ${category.name}</option>`
                ).join('')}
            `;
            
            select.innerHTML = options;
            
            if (filterSelect) {
                filterSelect.innerHTML = `
                    <option value="">Todas as categorias</option>
                    ${categoriesArray.map(category => 
                        `<option value="${category.id}">${category.icon} ${category.name}</option>`
                    ).join('')}
                `;
            }
        }

        // Enhanced product image upload
        document.getElementById('productImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            addDebugLog(`Product image upload started. File: ${file.name}, Size: ${file.size}`);

            // Validation
            if (file.size > 5 * 1024 * 1024) {
                showNotificationToast('Erro', 'Imagem muito grande. O tamanho m√°ximo √© 5MB.', 'error');
                e.target.value = '';
                return;
            }

            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showNotificationToast('Erro', 'Formato n√£o suportado. Use JPG, PNG ou WebP.', 'error');
                e.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-40 h-40 mx-auto rounded-xl object-cover">`;
            };
            reader.readAsDataURL(file);

            // Upload to ImgBB
            try {
                showNotificationToast('Upload', 'Fazendo upload da imagem...', 'info');
                
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeyImgBB}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    uploadedImageUrl = result.data.url;
                    addDebugLog('Product image uploaded successfully: ' + uploadedImageUrl);
                    showNotificationToast('Sucesso', 'Imagem carregada com sucesso!', 'success');
                } else {
                    throw new Error(result.error?.message || 'Upload falhou');
                }
            } catch (error) {
                addDebugLog('Product image upload error: ' + error.message);
                showNotificationToast('Erro', 'Erro no upload: ' + error.message, 'error');
                e.target.value = '';
                // Reset preview
                document.getElementById('imagePreview').innerHTML = `
                    <div class="w-40 h-40 mx-auto bg-gray-200 rounded-xl flex items-center justify-center">
                        <div class="text-4xl text-gray-400">üì∑</div>
                    </div>
                `;
            }
        });

        // Enhanced product form submission - CORRIGIDO
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            addDebugLog('Product form submitted');
            
            const saveBtn = document.getElementById('saveProductBtn');
            const saveText = document.getElementById('saveProductText');
            const saveLoader = document.getElementById('saveProductLoader');
            
            // Get and validate form data
            const nameInput = document.getElementById('productName');
            const categoryInput = document.getElementById('productCategory');
            const priceInput = document.getElementById('productPrice');
            const oldPriceInput = document.getElementById('productOldPrice');
            const stockInput = document.getElementById('productStock');
            const descriptionInput = document.getElementById('productDescription');
            
            if (!nameInput || !categoryInput || !priceInput || !stockInput || !descriptionInput) {
                addDebugLog('Product form inputs not found');
                showNotificationToast('Erro', 'Erro no formul√°rio. Recarregue a p√°gina.', 'error');
                return;
            }
            
            const name = nameInput.value ? nameInput.value.trim() : '';
            const categoryId = categoryInput.value ? String(categoryInput.value).trim() : '';
            const price = priceInput.value ? parseFloat(priceInput.value) : 0;
            const oldPrice = oldPriceInput.value ? parseFloat(oldPriceInput.value) : null;
            const stock = stockInput.value ? parseInt(stockInput.value) : 0;
            const description = descriptionInput.value ? descriptionInput.value.trim() : '';
            
            // üî• CORRE√á√ÉO PRINCIPAL: Obter o nome da categoria ao inv√©s do ID
            const categoryName = categories[categoryId] ? categories[categoryId].name : '';
            
            addDebugLog(`Product form data - Name: "${name}", Category ID: "${categoryId}", Category Name: "${categoryName}", Price: ${price}, Stock: ${stock}`);
            
            // Validation
            if (!name) {
                showNotificationToast('Erro', 'Por favor, insira o nome do produto.', 'error');
                return;
            }
            
            if (!categoryId) {
                showNotificationToast('Erro', 'Por favor, selecione uma categoria.', 'error');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                showNotificationToast('Erro', 'Por favor, insira um pre√ßo v√°lido.', 'error');
                return;
            }
            
            if (oldPrice && (isNaN(oldPrice) || oldPrice <= price)) {
                showNotificationToast('Erro', 'O pre√ßo antigo deve ser maior que o pre√ßo atual.', 'error');
                return;
            }
            
            if (isNaN(stock) || stock < 0) {
                showNotificationToast('Erro', 'Por favor, insira um estoque v√°lido.', 'error');
                return;
            }
            
            // Show loading state
            saveText.classList.add('hidden');
            saveLoader.classList.remove('hidden');
            saveBtn.disabled = true;
            
            try {
                let productId;
                
                if (editingProductId) {
                    // Garantir que editingProductId √© uma string v√°lida
                    productId = String(editingProductId).trim();
                    addDebugLog(`Editing existing product: ${productId}`);
                } else {
                    // Gerar um ID completamente novo e seguro
                    const timestamp = Date.now();
                    const randomId = Math.random().toString(36).substr(2, 9);
                    const safeName = String(name).toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]/g, '_')
                        .replace(/_+/g, '_')
                        .replace(/^_|_$/g, '')
                        .slice(0, 20);
                    
                    productId = `${safeName}_${timestamp}_${randomId}`;
                    addDebugLog(`Generated product ID: ${productId}`);
                }
                
                // Valida√ß√£o extra robusta do productId
                if (!productId || typeof productId !== 'string' || productId.includes('[object') || productId.length < 3) {
                    addDebugLog('Invalid product ID detected, generating fallback: ' + productId);
                    // Fallback para ID completamente seguro
                    productId = `product_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    addDebugLog('Using fallback product ID: ' + productId);
                }
                
                // Sanitizar o productId final
                productId = String(productId).replace(/[^a-zA-Z0-9_-]/g, '_');
                
                const productData = {
                    id: productId,
                    name: name,
                    category: categoryName, // üî• SALVANDO O NOME DA CATEGORIA, N√ÉO O ID
                    price: price,
                    oldPrice: oldPrice,
                    stock: stock,
                    description: description,
                    image: uploadedImageUrl || (editingProductId ? products[editingProductId]?.image : null),
                    updatedAt: Date.now()
                };

                if (editingProductId) {
                    // Update existing product
                    addDebugLog(`Updating product at path: products/${productId}`);
                    await update(ref(database, `products/${productId}`), productData);
                    addDebugLog('Product updated successfully');
                    showNotificationToast('Sucesso', 'Produto atualizado com sucesso!', 'success');
                } else {
                    // Create new product
                    productData.createdAt = Date.now();
                    addDebugLog(`Creating product at path: products/${productId}`);
                    addDebugLog('Product data: ' + JSON.stringify(productData));
                    await set(ref(database, `products/${productId}`), productData);
                    addDebugLog('Product created successfully with ID: ' + productId);
                    showNotificationToast('Sucesso', 'Produto adicionado com sucesso! Agora o app usu√°rio receber√° apenas o nome da categoria.', 'success');
                }

                closeProductModal();
                
            } catch (error) {
                addDebugLog('Error saving product: ' + error.message);
                showNotificationToast('Erro', 'Erro ao salvar produto: ' + error.message, 'error');
            } finally {
                saveText.classList.remove('hidden');
                saveLoader.classList.add('hidden');
                saveBtn.disabled = false;
            }
        });

        // Orders Management
        function renderOrders() {
            const ordersGrid = document.getElementById('ordersGrid');
            const ordersArray = Object.entries(orders).map(([id, order]) => ({ id, ...order }));
            
            // Apply current filter
            let filteredOrders = ordersArray;
            if (currentOrderFilter !== 'all') {
                filteredOrders = ordersArray.filter(order => order.status === currentOrderFilter);
            }
            
            // Sort by creation date (newest first)
            filteredOrders.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            if (filteredOrders.length === 0) {
                ordersGrid.innerHTML = `
                    <div class="text-center py-16 animate-fade-in">
                        <div class="text-6xl mb-6">üõí</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhum pedido encontrado</h3>
                        <p class="text-gray-600">
                            ${currentOrderFilter === 'all' ? 'Aguarde os primeiros pedidos chegarem' : `Nenhum pedido ${getOrderStatusText(currentOrderFilter).toLowerCase()} encontrado`}
                        </p>
                    </div>
                `;
                return;
            }

            ordersGrid.innerHTML = filteredOrders.map(order => {
                const statusColor = getOrderStatusColor(order.status);
                const statusText = getOrderStatusText(order.status);
                
                return `
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-all animate-fade-in">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Pedido #${order.id.slice(-6)}</h3>
                                <p class="text-sm text-gray-600">${new Date(order.createdAt || Date.now()).toLocaleString('pt-BR')}</p>
                            </div>
                            <span class="px-4 py-2 rounded-full text-sm font-bold ${statusColor}">
                                ${statusText}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">üë§ Cliente</h4>
                                <div class="space-y-2 text-sm">
                                    <p class="text-gray-600">üìß ${order.customer?.email || 'N/A'}</p>
                                    <p class="text-gray-600">üë§ ${order.customer?.name || 'N/A'}</p>
                                    <p class="text-gray-600">üìû ${order.customer?.phone || 'N/A'}</p>
                                    <p class="text-gray-600">üìç ${order.customer?.location || 'N/A'}</p>
                                    ${order.customer?.message ? `<p class="text-gray-600">üí¨ ${order.customer.message}</p>` : ''}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">üì¶ Itens (${(order.items || []).length})</h4>
                                <div class="space-y-2 max-h-32 overflow-y-auto">
                                    ${(order.items || []).map(item => `
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">${item.quantity}x ${item.name}</span>
                                            <span class="font-medium">${formatPrice(item.price * item.quantity)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 border-t border-gray-200 mb-6">
                            <span class="text-lg font-bold text-gray-800">Total:</span>
                            <span class="text-2xl font-bold text-primary">${formatPrice(order.total || 0)}</span>
                        </div>
                        
                        <div class="flex flex-wrap gap-3">
                            <button onclick="showOrderDetail('${order.id}')" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-semibold">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            ${order.status === 'pending' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'approved')" class="px-4 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-semibold">
                                    ‚úÖ Aprovar
                                </button>
                                <button onclick="updateOrderStatus('${order.id}', 'rejected')" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-all font-semibold">
                                    ‚ùå Rejeitar
                                </button>
                            ` : ''}
                            ${order.status === 'approved' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'delivered')" class="px-4 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-semibold">
                                    üéâ Marcar Entregue
                                </button>
                            ` : ''}
                            ${order.customer?.userId ? `
                                <button onclick="startChatWithUser('${order.customer.userId}')" class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-all font-semibold">
                                    üí¨ Chat
                                </button>
                            ` : ''}
                            <button 
                                data-original="üóëÔ∏è"
                                onmousedown="startLongPressDelete('${order.id}', this, 'order')" 
                                onmouseup="cancelLongPressDelete(this)" 
                                onmouseleave="cancelLongPressDelete(this)"
                                ontouchstart="startLongPressDelete('${order.id}', this, 'order')" 
                                ontouchend="cancelLongPressDelete(this)"
                                class="px-4 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentOrders() {
            const recentOrdersList = document.getElementById('recentOrdersList');
            const ordersArray = Object.entries(orders).map(([id, order]) => ({ id, ...order }));
            
            // Get 5 most recent orders
            const recentOrders = ordersArray
                .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
                .slice(0, 5);
            
            if (recentOrders.length === 0) {
                recentOrdersList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-3xl mb-2">üì≠</div>
                        <p>Nenhum pedido recente</p>
                    </div>
                `;
                return;
            }

            recentOrdersList.innerHTML = recentOrders.map(order => `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-lg transition-all cursor-pointer" onclick="showOrderDetail('${order.id}')">
                    <div>
                        <p class="font-medium text-gray-800">Pedido #${order.id.slice(-6)}</p>
                        <p class="text-sm text-gray-600">${order.customer?.name || 'Cliente'}</p>
                        <p class="text-xs text-gray-500">${new Date(order.createdAt || Date.now()).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-primary">${formatPrice(order.total || 0)}</p>
                        <span class="px-2 py-1 rounded-full text-xs ${getOrderStatusColor(order.status)}">
                            ${getOrderStatusText(order.status)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Users Management - CORRIGIDO COM TEMPO ATIVO
        function renderUsers() {
            const usersGrid = document.getElementById('usersGrid');
            const usersArray = Object.entries(users).map(([id, user]) => ({ 
                id, 
                ...user,
                uid: id // Garantir que temos o uid correto
            }));
            
            if (usersArray.length === 0) {
                usersGrid.innerHTML = `
                    <div class="col-span-full text-center py-16 animate-fade-in">
                        <div class="text-6xl mb-6">üë•</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Nenhum usu√°rio registrado</h3>
                        <p class="text-gray-600">Os usu√°rios aparecer√£o aqui quando se registrarem na loja</p>
                    </div>
                `;
                return;
            }

            usersGrid.innerHTML = usersArray.map(user => {
                const userUID = user.uid || user.id;
                const orderCount = Object.values(orders).filter(order => order.customer?.userId === userUID).length;
                const totalSpent = Object.values(orders)
                    .filter(order => order.customer?.userId === userUID && order.status === 'delivered')
                    .reduce((sum, order) => sum + (order.total || 0), 0);
                
                const isActive = user.lastActive && (Date.now() - user.lastActive) < (24 * 60 * 60 * 1000);
                const isNew = user.createdAt && (Date.now() - user.createdAt) < (7 * 24 * 60 * 60 * 1000);
                
                // Determinar tipo de login (Google ou Email/Senha)
                const loginType = user.photoURL && user.photoURL.includes('googleusercontent.com') ? 'Google' : 'Email';
                const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email?.charAt(0) || 'U')}&background=5D5CDE&color=fff`;
                
                return `
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-all animate-fade-in">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="relative">
                                <img src="${avatarUrl}" 
                                     alt="${user.name || user.email}" class="w-16 h-16 rounded-full border-2 border-primary">
                                <span class="absolute -bottom-1 -right-1 px-2 py-1 text-xs rounded-full ${loginType === 'Google' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'} border border-white">
                                    ${loginType === 'Google' ? 'üîó Google' : 'üìß Email'}
                                </span>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-800">${user.name || 'Usu√°rio'}</h3>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <div class="flex space-x-2 mt-2">
                                    ${isActive ? `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">üü¢ Online</span>` : ''}
                                    ${isNew ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">üÜï Novo</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <p class="text-2xl font-bold text-blue-600">${orderCount}</p>
                                <p class="text-sm text-blue-600">Pedidos</p>
                            </div>
                            <div class="text-center p-3 bg-green-50 rounded-lg">
                                <p class="text-lg font-bold text-green-600">${formatPrice(totalSpent)}</p>
                                <p class="text-sm text-green-600">Gasto Total</p>
                            </div>
                        </div>
                        
                        <div class="text-sm text-gray-600 space-y-1 mb-4">
                            <p><strong>Registrado:</strong> ${new Date(user.createdAt || Date.now()).toLocaleDateString('pt-BR')}</p>
                            <p><strong>√öltimo acesso:</strong> ${user.lastActive ? getTimeAgo(user.lastActive) : 'Nunca'}</p>
                            <p><strong>Login via:</strong> ${loginType}</p>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="startChatWithUser('${userUID}')" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all font-semibold">
                                üí¨ Chat
                            </button>
                            <button onclick="sendNotificationToUser('${userUID}')" class="px-4 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all">
                                üîî Notificar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Atualizar lista de usu√°rios para chat tamb√©m
            renderUsersListForChat();
        }

        // Fun√ß√£o para calcular tempo que ficou ativo - IMPLEMENTADA
        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Nunca';
            
            const now = Date.now();
            const diffMs = now - timestamp;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) {
                return 'Agora mesmo';
            } else if (diffMins < 60) {
                return `${diffMins} min atr√°s`;
            } else if (diffHours < 24) {
                return `${diffHours}h atr√°s`;
            } else if (diffDays < 7) {
                return `${diffDays} dias atr√°s`;
            } else {
                return new Date(timestamp).toLocaleDateString('pt-BR');
            }
        }

        // Renderizar lista de usu√°rios para chat - CORRIGIDO
        function renderUsersListForChat() {
            const usersList = document.getElementById('usersList');
            const usersArray = Object.entries(users).map(([id, user]) => ({ 
                id, 
                ...user,
                uid: id 
            }));
            
            if (usersArray.length === 0) {
                usersList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-3xl mb-4">üë•</div>
                        <p>Nenhum usu√°rio dispon√≠vel</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = usersArray.map(user => {
                const userUID = user.uid || user.id;
                const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email?.charAt(0) || 'U')}&background=5D5CDE&color=fff`;
                const loginType = user.photoURL && user.photoURL.includes('googleusercontent.com') ? 'Google' : 'Email';
                
                return `
                    <div class="flex items-center p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition-all" onclick="startChatWithUser('${userUID}')">
                        <div class="relative mr-3">
                            <img src="${avatarUrl}" alt="${user.name || user.email}" class="w-10 h-10 rounded-full border border-gray-300">
                            <span class="absolute -bottom-1 -right-1 text-xs ${loginType === 'Google' ? 'text-red-500' : 'text-blue-500'}">
                                ${loginType === 'Google' ? 'üîó' : 'üìß'}
                            </span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${user.name || 'Usu√°rio'}</p>
                            <p class="text-xs text-gray-500 truncate">${user.email}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Chat system initialization - CORRIGIDO
        async function initializeChat() {
            try {
                addDebugLog('Initializing chat system...');
                renderUsersListForChat();
            } catch (error) {
                addDebugLog('Error initializing chat: ' + error.message);
            }
        }

        // Fun√ß√£o para iniciar chat com usu√°rio - IMPLEMENTADA
        async function startChatWithUser(userId) {
            addDebugLog(`Starting chat with user: ${userId}`);
            
            try {
                selectedUserId = userId;
                const user = users[userId];
                
                if (!user) {
                    showNotificationToast('Erro', 'Usu√°rio n√£o encontrado', 'error');
                    return;
                }

                // Criar ou ativar chat
                currentChatId = `chat_${currentUser.uid}_${userId}`;
                
                // Configurar o chat como ativo no banco de dados
                await set(ref(database, `chats/users/${userId}`), {
                    chatId: currentChatId,
                    active: true,
                    adminId: currentUser.uid,
                    startedAt: Date.now()
                });

                // Atualizar a interface
                updateChatHeader(user);
                loadChatMessages();
                
                // Mostrar se√ß√£o de chat se n√£o estiver vis√≠vel
                if (currentSection !== 'chat') {
                    showSection('chat');
                }
                
                showNotificationToast('Chat', `Chat iniciado com ${user.name || user.email}`, 'success');
                
            } catch (error) {
                addDebugLog('Error starting chat: ' + error.message);
                showNotificationToast('Erro', 'Erro ao iniciar chat: ' + error.message, 'error');
            }
        }

        function updateChatHeader(user) {
            const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email?.charAt(0) || 'U')}&background=5D5CDE&color=fff`;
            const loginType = user.photoURL && user.photoURL.includes('googleusercontent.com') ? 'Google' : 'Email';
            
            document.getElementById('chatHeader').innerHTML = `
                <img src="${avatarUrl}" alt="${user.name}" class="w-12 h-12 rounded-full border-2 border-primary">
                <div>
                    <h4 class="font-bold text-gray-800">${user.name || 'Usu√°rio'}</h4>
                    <p class="text-sm text-gray-500">${user.email} ‚Ä¢ Login via ${loginType}</p>
                </div>
            `;
            
            document.getElementById('closeChatBtn').classList.remove('hidden');
            document.getElementById('chatInputContainer').classList.remove('hidden');
        }

        function loadChatMessages() {
            if (!currentChatId) return;

            const messagesRef = ref(database, `chats/messages/${currentChatId}`);
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val() || {};
                const messagesList = Object.entries(messages)
                    .map(([id, msg]) => ({ id, ...msg }))
                    .sort((a, b) => a.timestamp - b.timestamp);

                displayChatMessages(messagesList);
            });
        }

        function displayChatMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <div class="text-6xl mb-4">üí¨</div>
                        <p class="text-lg">Chat iniciado</p>
                        <p class="text-sm mt-2">Digite sua primeira mensagem abaixo</p>
                    </div>
                `;
                return;
            }

            const messagesHTML = messages.map(msg => {
                const isAdmin = msg.senderId === currentUser.uid;
                let messageContent = '';
                
                if (msg.type === 'image') {
                    messageContent = `
                        <img src="${msg.imageUrl}" alt="Imagem" class="max-w-full h-auto rounded-lg cursor-pointer" 
                             onclick="window.open('${msg.imageUrl}', '_blank')">
                        ${msg.text ? `<p class="text-sm mt-2">${msg.text}</p>` : ''}
                    `;
                } else {
                    messageContent = `<p class="text-sm">${msg.text}</p>`;
                }
                
                return `
                    <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'} mb-3 animate-fade-in">
                        <div class="${isAdmin ? 'bg-primary text-white' : 'bg-gray-200 text-gray-800'} 
                                    rounded-lg px-3 py-2 max-w-xs lg:max-w-md">
                            ${messageContent}
                            <p class="${isAdmin ? 'text-blue-100' : 'text-gray-500'} text-xs mt-1">
                                ${new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            chatMessages.innerHTML = messagesHTML;
            
            // Scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        async function sendChatMessage(messageText = null, imageUrl = null) {
            if (!currentChatId || (!messageText && !imageUrl)) return;

            try {
                const messageData = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    timestamp: Date.now(),
                    read: false
                };

                if (imageUrl) {
                    messageData.type = 'image';
                    messageData.imageUrl = imageUrl;
                    messageData.text = messageText || '';
                } else {
                    messageData.type = 'text';
                    messageData.text = messageText;
                }

                await push(ref(database, `chats/messages/${currentChatId}`), messageData);
            } catch (error) {
                console.error('Error sending message:', error);
                showNotificationToast('Erro', 'Erro ao enviar mensagem. Tente novamente.', 'error');
            }
        }

        // Event handlers para chat
        document.getElementById('sendChatBtn').addEventListener('click', () => {
            const messageText = document.getElementById('chatInput').value.trim();
            if (messageText) {
                sendChatMessage(messageText);
                document.getElementById('chatInput').value = '';
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const messageText = document.getElementById('chatInput').value.trim();
                if (messageText) {
                    sendChatMessage(messageText);
                    document.getElementById('chatInput').value = '';
                }
            }
        });

        document.getElementById('closeChatBtn').addEventListener('click', () => {
            currentChatId = null;
            selectedUserId = null;
            
            document.getElementById('chatHeader').innerHTML = `
                <div class="text-2xl">üí¨</div>
                <div>
                    <h4 class="font-bold text-gray-800">Selecione um usu√°rio</h4>
                    <p class="text-sm text-gray-500">Para iniciar uma conversa</p>
                </div>
            `;
            document.getElementById('closeChatBtn').classList.add('hidden');
            document.getElementById('chatInputContainer').classList.add('hidden');
            document.getElementById('chatMessages').innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="text-6xl mb-4">üí¨</div>
                    <p class="text-lg">Selecione um usu√°rio para come√ßar a conversar</p>
                    <p class="text-sm mt-2">Suporte em tempo real para seus clientes</p>
                </div>
            `;
        });

        // Fun√ß√£o para enviar notifica√ß√£o para usu√°rio espec√≠fico - IMPLEMENTADA
        async function sendNotificationToUser(userId) {
            addDebugLog(`Sending notification to user: ${userId}`);
            
            const user = users[userId];
            if (!user) {
                showNotificationToast('Erro', 'Usu√°rio n√£o encontrado', 'error');
                return;
            }

            // Abrir modal de notifica√ß√£o com usu√°rio pr√©-selecionado
            showSection('notifications');
            
            // Pr√©-configurar o formul√°rio
            document.getElementById('notificationTarget').value = 'specific';
            document.getElementById('specificUserContainer').classList.remove('hidden');
            
            // Carregar usu√°rios e selecionar o espec√≠fico
            loadUsersForNotification();
            setTimeout(() => {
                document.getElementById('specificUser').value = userId;
            }, 100);
            
            showNotificationToast('Info', `Formul√°rio preparado para ${user.name || user.email}`, 'info');
        }

        // Reports and Analytics
        function loadReports() {
            addDebugLog('Loading reports...');
            
            const ordersArray = Object.values(orders);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            
            const thisMonth = new Date();
            thisMonth.setDate(1);
            thisMonth.setHours(0, 0, 0, 0);
            const monthTimestamp = thisMonth.getTime();
            
            // Today's sales
            const todayOrders = ordersArray.filter(order => order.createdAt >= todayTimestamp);
            const todaySalesAmount = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            
            // This month's sales
            const monthOrders = ordersArray.filter(order => order.createdAt >= monthTimestamp);
            const monthSalesAmount = monthOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            
            // Update sales report
            document.getElementById('salesTodayAmount').textContent = formatPrice(todaySalesAmount);
            document.getElementById('salesMonthAmount').textContent = formatPrice(monthSalesAmount);
            
            // Top products
            const productSales = {};
            ordersArray.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        if (!productSales[item.name]) {
                            productSales[item.name] = { quantity: 0, revenue: 0 };
                        }
                        productSales[item.name].quantity += item.quantity;
                        productSales[item.name].revenue += item.price * item.quantity;
                    });
                }
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1].quantity - a[1].quantity)
                .slice(0, 5);
            
            const topProductsList = document.getElementById('topProductsList');
            if (topProducts.length === 0) {
                topProductsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Sem dados de vendas ainda</p>
                    </div>
                `;
            } else {
                topProductsList.innerHTML = topProducts.map(([productName, data], index) => `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </span>
                            <div>
                                <p class="font-medium text-gray-800">${productName}</p>
                                <p class="text-sm text-gray-600">${data.quantity} vendidos</p>
                            </div>
                        </div>
                        <p class="font-bold text-primary">${formatPrice(data.revenue)}</p>
                    </div>
                `).join('');
            }
        }

        // Event listeners setup
        function setupEventListeners() {
            addDebugLog('Setting up event listeners...');
            
            // Navigation
            document.getElementById('dashboardBtn').addEventListener('click', () => showSection('dashboard'));
            document.getElementById('productsBtn').addEventListener('click', () => showSection('products'));
            document.getElementById('categoriesBtn').addEventListener('click', () => showSection('categories'));
            document.getElementById('ordersBtn').addEventListener('click', () => showSection('orders'));
            document.getElementById('chatBtn').addEventListener('click', () => showSection('chat'));
            document.getElementById('notificationsBtn').addEventListener('click', () => showSection('notifications'));
            document.getElementById('usersBtn').addEventListener('click', () => showSection('users'));
            document.getElementById('reportsBtn').addEventListener('click', () => showSection('reports'));
            document.getElementById('settingsBtn').addEventListener('click', () => showSection('settings'));

            // Mobile navigation
            document.getElementById('mobileDashboardBtn').addEventListener('click', () => showSection('dashboard'));
            document.getElementById('mobileProductsBtn').addEventListener('click', () => showSection('products'));
            document.getElementById('mobileCategoriesBtn').addEventListener('click', () => showSection('categories'));
            document.getElementById('mobileOrdersBtn').addEventListener('click', () => showSection('orders'));
            document.getElementById('mobileChatBtn').addEventListener('click', () => showSection('chat'));
            document.getElementById('mobileNotificationsBtn').addEventListener('click', () => showSection('notifications'));
            document.getElementById('mobileUsersBtn').addEventListener('click', () => showSection('users'));
            document.getElementById('mobileReportsBtn').addEventListener('click', () => showSection('reports'));
            document.getElementById('mobileSettingsBtn').addEventListener('click', () => showSection('settings'));

            // Quick actions
            document.getElementById('addProductBtn').addEventListener('click', () => {
                showSection('products');
                setTimeout(() => openProductModal(), 500);
            });
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                showSection('categories');
                setTimeout(() => openCategoryModal(), 500);
            });
            document.getElementById('viewOrdersBtn').addEventListener('click', () => showSection('orders'));
            document.getElementById('sendNotificationBtn').addEventListener('click', () => showSection('notifications'));
            document.getElementById('openChatBtn').addEventListener('click', () => showSection('chat'));
            document.getElementById('viewReportsBtn').addEventListener('click', () => showSection('reports'));
            document.getElementById('addProductModalBtn').addEventListener('click', openProductModal);
            document.getElementById('manageCategoriesBtn').addEventListener('click', () => showSection('categories'));
            document.getElementById('addCategoryModalBtn').addEventListener('click', openCategoryModal);

            // Order filters
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.order-filter-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    
                    currentOrderFilter = btn.dataset.status;
                    renderOrders();
                });
            });

            // Icon selection
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('icon-btn')) {
                    e.preventDefault();
                    
                    document.querySelectorAll('.icon-btn').forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('hover:bg-gray-100');
                    });
                    
                    e.target.classList.add('bg-primary', 'text-white');
                    e.target.classList.remove('hover:bg-gray-100');
                    
                    const icon = e.target.dataset.icon;
                    document.getElementById('categoryIcon').value = icon;
                    document.getElementById('selectedIcon').textContent = icon;
                }
            });

            // Admin menu toggle
            document.getElementById('adminMenuBtn').addEventListener('click', () => {
                document.getElementById('adminMenu').classList.toggle('hidden');
            });

            // Close admin menu when clicking outside
            document.addEventListener('click', (e) => {
                const adminMenuBtn = document.getElementById('adminMenuBtn');
                const adminMenu = document.getElementById('adminMenu');
                if (!adminMenuBtn.contains(e.target) && !adminMenu.contains(e.target)) {
                    adminMenu.classList.add('hidden');
                }
            });

            // Notification form
            document.getElementById('notificationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await sendNotification();
            });

            document.getElementById('notificationTarget').addEventListener('change', () => {
                const target = document.getElementById('notificationTarget').value;
                const container = document.getElementById('specificUserContainer');
                if (target === 'specific') {
                    container.classList.remove('hidden');
                    loadUsersForNotification();
                } else {
                    container.classList.add('hidden');
                }
            });
        }

        // Filters and search setup
        function setupFiltersAndSearch() {
            addDebugLog('Setting up filters and search functionality...');
            
            // Product search and filters
            const productSearch = document.getElementById('productSearch');
            const productCategoryFilter = document.getElementById('productCategoryFilter');
            const productStockFilter = document.getElementById('productStockFilter');
            const productSortBy = document.getElementById('productSortBy');

            if (productSearch) {
                productSearch.addEventListener('input', debounce(() => {
                    filterAndRenderProducts();
                }, 300));
            }

            if (productCategoryFilter) {
                productCategoryFilter.addEventListener('change', filterAndRenderProducts);
            }

            if (productStockFilter) {
                productStockFilter.addEventListener('change', filterAndRenderProducts);
            }

            if (productSortBy) {
                productSortBy.addEventListener('change', filterAndRenderProducts);
            }

            // User search and filters
            const userSearch = document.getElementById('userSearch');
            const userStatusFilter = document.getElementById('userStatusFilter');
            const userSortBy = document.getElementById('userSortBy');

            if (userSearch) {
                userSearch.addEventListener('input', debounce(() => {
                    filterAndRenderUsers();
                }, 300));
            }

            if (userStatusFilter) {
                userStatusFilter.addEventListener('change', filterAndRenderUsers);
            }

            if (userSortBy) {
                userSortBy.addEventListener('change', filterAndRenderUsers);
            }

            // Order search and filters
            const orderSearch = document.getElementById('orderSearch');
            const orderDateFilter = document.getElementById('orderDateFilter');
            const orderSortBy = document.getElementById('orderSortBy');

            if (orderSearch) {
                orderSearch.addEventListener('input', debounce(() => {
                    filterAndRenderOrders();
                }, 300));
            }

            if (orderDateFilter) {
                orderDateFilter.addEventListener('change', filterAndRenderOrders);
            }

            if (orderSortBy) {
                orderSortBy.addEventListener('change', filterAndRenderOrders);
            }
        }

        // Filtering functions
        function filterAndRenderProducts() {
            renderProducts();
        }

        function filterAndRenderUsers() {
            renderUsers();
        }

        function filterAndRenderOrders() {
            renderOrders();
        }

        // Delete functions
        async function deleteCategory(categoryId) {
            try {
                addDebugLog(`Deleting category: ${categoryId}`);
                
                const category = categories[categoryId];
                const productCount = Object.values(products).filter(p => p.category === category?.name).length;
                
                await remove(ref(database, `categories/${categoryId}`));
                
                try {
                    await deleteDoc(doc(firestore, 'categories', categoryId));
                } catch (firestoreError) {
                    addDebugLog('Firestore delete failed (non-critical): ' + firestoreError.message);
                }
                
                showNotificationToast('Sucesso', `Categoria "${category?.name}" exclu√≠da com sucesso!`, 'success');
                
                if (productCount > 0) {
                    showNotificationToast('Aviso', `${productCount} produto(s) ficaram sem categoria`, 'warning');
                }
                
            } catch (error) {
                addDebugLog('Error deleting category: ' + error.message);
                showNotificationToast('Erro', 'Erro ao excluir categoria: ' + error.message, 'error');
            }
        }

        async function deleteProduct(productId) {
            try {
                addDebugLog(`Deleting product: ${productId}`);
                
                const product = products[productId];
                
                await remove(ref(database, `products/${productId}`));
                
                try {
                    await deleteDoc(doc(firestore, 'products', productId));
                } catch (firestoreError) {
                    addDebugLog('Firestore delete failed (non-critical): ' + firestoreError.message);
                }
                
                showNotificationToast('Sucesso', `Produto "${product?.name}" exclu√≠do com sucesso!`, 'success');
            } catch (error) {
                addDebugLog('Error deleting product: ' + error.message);
                showNotificationToast('Erro', 'Erro ao excluir produto: ' + error.message, 'error');
            }
        }

        async function deleteOrder(orderId) {
            try {
                addDebugLog(`Deleting order: ${orderId}`);
                
                await remove(ref(database, `orders/${orderId}`));
                
                try {
                    await deleteDoc(doc(firestore, 'orders', orderId));
                } catch (firestoreError) {
                    addDebugLog('Firestore delete failed (non-critical): ' + firestoreError.message);
                }
                
                showNotificationToast('Sucesso', 'Pedido exclu√≠do com sucesso!', 'success');
            } catch (error) {
                addDebugLog('Error deleting order: ' + error.message);
                showNotificationToast('Erro', 'Erro ao excluir pedido: ' + error.message, 'error');
            }
        }

        // Order functions
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const updateData = {
                    status: newStatus,
                    updatedAt: Date.now()
                };

                await update(ref(database, `orders/${orderId}`), updateData);

                const statusText = getOrderStatusText(newStatus);
                showNotificationToast('Sucesso', `Pedido ${statusText.toLowerCase()} com sucesso!`, 'success');

                // Send notification to user
                const order = orders[orderId];
                if (order && order.customer?.userId) {
                    const notificationData = {
                        title: 'üì¶ Atualiza√ß√£o do Pedido',
                        message: `Seu pedido #${orderId.slice(-6)} foi ${statusText.toLowerCase()}.`,
                        type: newStatus === 'delivered' ? 'success' : newStatus === 'approved' ? 'info' : 'warning',
                        timestamp: Date.now(),
                        read: false,
                        adminId: currentUser.uid,
                        adminName: currentUser.displayName || currentUser.email
                    };
                    
                    try {
                        await set(ref(database, `notifications/${order.customer.userId}/${Date.now()}`), notificationData);
                    } catch (notifError) {
                        addDebugLog('Failed to send order notification: ' + notifError.message);
                    }
                }
            } catch (error) {
                addDebugLog('Error updating order status: ' + error.message);
                showNotificationToast('Erro', 'Erro ao atualizar status do pedido: ' + error.message, 'error');
            }
        }

        // Notification system
        async function sendNotification() {
            const sendText = document.getElementById('sendNotificationText');
            const sendLoader = document.getElementById('sendNotificationLoader');
            const sendBtn = document.getElementById('sendNotificationFormBtn');
            
            sendText.classList.add('hidden');
            sendLoader.classList.remove('hidden');
            sendBtn.disabled = true;
            
            try {
                const notificationData = {
                    title: document.getElementById('notificationTitle').value,
                    message: document.getElementById('notificationMessage').value,
                    type: document.getElementById('notificationType').value,
                    timestamp: Date.now(),
                    read: false,
                    adminId: currentUser.uid,
                    adminName: currentUser.displayName || currentUser.email
                };

                const target = document.getElementById('notificationTarget').value;

                if (target === 'all') {
                    // Send to all users
                    const notificationId = `notif_${Date.now()}`;
                    const promises = [];
                    
                    // Global notification
                    promises.push(set(ref(database, `notifications/global/${notificationId}`), notificationData));
                    
                    // Individual notifications
                    Object.keys(users).forEach(userId => {
                        if (userId !== currentUser.uid) {
                            promises.push(set(ref(database, `notifications/${userId}/${notificationId}`), notificationData));
                        }
                    });

                    await Promise.all(promises);
                    showNotificationToast('Sucesso', `Notifica√ß√£o enviada para ${Object.keys(users).length} usu√°rios!`, 'success');
                } else {
                    // Send to specific user
                    const userId = document.getElementById('specificUser').value;
                    if (!userId) {
                        showNotificationToast('Erro', 'Por favor, selecione um usu√°rio.', 'error');
                        return;
                    }

                    const notificationId = `notif_${Date.now()}`;
                    await set(ref(database, `notifications/${userId}/${notificationId}`), notificationData);

                    const user = users[userId];
                    showNotificationToast('Sucesso', `Notifica√ß√£o enviada para ${user?.name || 'usu√°rio selecionado'}!`, 'success');
                }

                // Reset form
                document.getElementById('notificationForm').reset();
                document.getElementById('specificUserContainer').classList.add('hidden');
                
            } catch (error) {
                addDebugLog('Error sending notification: ' + error.message);
                showNotificationToast('Erro', 'Erro ao enviar notifica√ß√£o: ' + error.message, 'error');
            } finally {
                sendText.classList.remove('hidden');
                sendLoader.classList.add('hidden');
                sendBtn.disabled = false;
            }
        }

        function loadUsersForNotification() {
            const usersArray = Object.entries(users).map(([id, user]) => ({ id, ...user }))
                .filter(user => user.email && user.name);
            
            document.getElementById('specificUser').innerHTML = usersArray.map(user => 
                `<option value="${user.id}">${user.name} (${user.email})</option>`
            ).join('');
        }

        // Notification templates
        function useNotificationTemplate(template) {
            const templates = {
                promotion: {
                    title: 'üéâ Promo√ß√£o Especial!',
                    message: 'N√£o perca! Descontos incr√≠veis em produtos selecionados. Aproveite agora e economize muito!',
                    type: 'warning'
                },
                order_update: {
                    title: 'üì¶ Atualiza√ß√£o do Pedido',
                    message: 'Seu pedido foi atualizado. Verifique o novo status na se√ß√£o de pedidos do aplicativo.',
                    type: 'info'
                },
                new_product: {
                    title: '‚ú® Novo Produto Dispon√≠vel',
                    message: 'Acabou de chegar! Confira nosso mais novo produto na loja e seja um dos primeiros a adquirir.',
                    type: 'success'
                },
                maintenance: {
                    title: '‚ö†Ô∏è Manuten√ß√£o Programada',
                    message: 'Sistema em manuten√ß√£o das 02:00 √†s 04:00. Pedimos desculpas pelo inconveniente.',
                    type: 'error'
                },
                welcome: {
                    title: 'üëã Bem-vindo √† Kuia+!',
                    message: 'Seja bem-vindo √† nossa loja! Explore nossos produtos e aproveite ofertas exclusivas.',
                    type: 'success'
                }
            };

            const selectedTemplate = templates[template];
            if (selectedTemplate) {
                document.getElementById('notificationTitle').value = selectedTemplate.title;
                document.getElementById('notificationMessage').value = selectedTemplate.message;
                document.getElementById('notificationType').value = selectedTemplate.type;
            }
        }

        // Backup functions
        async function createBackup() {
            addDebugLog('Creating backup...');
            
            try {
                const backupData = {
                    timestamp: Date.now(),
                    date: new Date().toISOString(),
                    version: '1.0',
                    products: products,
                    categories: categories,
                    orders: orders,
                    users: users
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `kuia_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotificationToast('Sucesso', 'Backup criado com sucesso!', 'success');
                
            } catch (error) {
                addDebugLog('Backup error: ' + error.message);
                showNotificationToast('Erro', 'Erro ao criar backup: ' + error.message, 'error');
            }
        }

        // System check function
        async function runSystemCheck() {
            addDebugLog('Running system check...');
            showNotificationToast('Sistema', 'Verificando todos os componentes...', 'info');
            
            try {
                // Check Firebase connection
                const testRef = ref(database, `system_check/${Date.now()}`);
                await set(testRef, { test: true, timestamp: Date.now() });
                await remove(testRef);
                
                // Check data integrity
                const dataChecks = [
                    { name: 'Produtos', data: products, count: Object.keys(products).length },
                    { name: 'Categorias', data: categories, count: Object.keys(categories).length },
                    { name: 'Pedidos', data: orders, count: Object.keys(orders).length },
                    { name: 'Usu√°rios', data: users, count: Object.keys(users).length }
                ];
                
                let report = 'Relat√≥rio do Sistema:\n\n';
                dataChecks.forEach(check => {
                    report += `${check.name}: ${check.count} registros ‚úÖ\n`;
                });
                
                report += `\nFirebase: Conectado ‚úÖ\nAdmin: Autenticado ‚úÖ\nVers√£o: 1.0.0 ‚úÖ`;
                
                addDebugLog('System check completed successfully');
                addDebugLog(report);
                showNotificationToast('Sistema', 'Verifica√ß√£o conclu√≠da! Tudo funcionando perfeitamente.', 'success');
                
            } catch (error) {
                addDebugLog('System check failed: ' + error.message);
                showNotificationToast('Erro', 'Falha na verifica√ß√£o do sistema: ' + error.message, 'error');
            }
        }

        function showSystemInfo() {
            const info = `
Sistema: Kuia+ Admin
Vers√£o: 1.0.0
Firebase: ${Object.keys(products).length} produtos, ${Object.keys(categories).length} categorias
Pedidos: ${Object.keys(orders).length} total
Usu√°rios: ${Object.keys(users).length} registrados
Admin: ${currentUser.email}
            `.trim();
            
            showNotificationToast('Info do Sistema', info, 'info');
        }

        // Utility functions
        function formatPrice(price) {
            return `${Math.round(price || 0).toLocaleString('pt-AO')} Kz`;
        }

        function generateSafeId(name) {
            return name.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '')
                .slice(0, 50);
        }

        function getOrderStatusColor(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'approved': return 'bg-blue-100 text-blue-800';
                case 'delivered': return 'bg-green-100 text-green-800';
                case 'rejected': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getOrderStatusText(status) {
            switch (status) {
                case 'pending': return 'Pendente';
                case 'approved': return 'Aprovado';
                case 'delivered': return 'Entregue';
                case 'rejected': return 'Rejeitado';
                default: return 'Desconhecido';
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Make functions globally available
        window.openCategoryModal = openCategoryModal;
        window.closeCategoryModal = closeCategoryModal;
        window.editCategory = (categoryId) => openCategoryModal(categoryId);
        window.openProductModal = openProductModal;
        window.closeProductModal = closeProductModal;
        window.editProduct = (productId) => openProductModal(productId);
        window.showSection = showSection;
        window.useNotificationTemplate = useNotificationTemplate;
        window.createBackup = createBackup;
        window.runSystemCheck = runSystemCheck;
        window.showSystemInfo = showSystemInfo;
        window.updateOrderStatus = updateOrderStatus;
        window.showOrderDetail = (orderId) => {}; // Placeholder
        window.closeOrderDetailModal = () => {}; // Placeholder
        window.startChatWithUser = startChatWithUser;
        window.sendNotificationToUser = sendNotificationToUser;
        window.openProfilePictureModal = () => {}; // Placeholder
        window.closeProfilePictureModal = () => {}; // Placeholder
        window.signOutAdmin = async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                addDebugLog('Logout error: ' + error.message);
            }
        };

        addDebugLog('Kuia+ Admin System fully initialized and ready');
    </script>
</body>
</html>