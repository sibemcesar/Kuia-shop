<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuia+ Admin - Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4845BE'
                    },
                    animation: {
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-in': 'bounceIn 0.4s ease-out',
                        'notification-slide': 'notificationSlide 0.5s ease-out',
                        'progress-bar': 'progressBar 5s linear'
                    },
                    keyframes: {
                        slideInRight: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        notificationSlide: {
                            '0%': { transform: 'translateX(100%) scale(0.8)', opacity: '0' },
                            '100%': { transform: 'translateX(0) scale(1)', opacity: '1' }
                        },
                        progressBar: {
                            '0%': { width: '100%' },
                            '100%': { width: '0%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .delete-progress {
            background: linear-gradient(90deg, #ef4444 var(--progress, 0%), transparent var(--progress, 0%));
            transition: background 0.1s ease;
        }
        
        .section-transition {
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .notification-badge {
            animation: pulse 2s infinite;
        }
        
        .toast-progress {
            animation: progressBar 5s linear;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .notification-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-history::-webkit-scrollbar {
            width: 4px;
        }

        .notification-history::-webkit-scrollbar-track {
            background: transparent;
        }

        .notification-history::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Kuia+ Admin</h2>
            <p id="loadingStatus" class="text-gray-600 dark:text-gray-400">Verificando acesso...</p>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-40 hidden">
        <div class="text-center max-w-md animate-scale-in">
            <div class="text-6xl mb-6">üö´</div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Acesso Negado</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Voc√™ n√£o tem permiss√£o para acessar o painel administrativo.</p>
            <button onclick="location.reload()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105">
                Tentar Novamente
            </button>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen">
        <!-- Enhanced Notification Area -->
        <div id="notificationArea" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

        <!-- Real-time Status Indicator -->
        <div id="realTimeStatus" class="fixed top-4 left-4 z-40 hidden">
            <div class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium animate-pulse">
                üü¢ Sistema em Tempo Real Ativo
            </div>
        </div>

        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-primary">‚öôÔ∏è Kuia+ Admin</h1>
                        <nav class="hidden md:flex space-x-6">
                            <button id="dashboardBtn" class="nav-btn text-primary px-3 py-2 rounded-md text-sm font-medium transition-all">
                                üìä Dashboard
                            </button>
                            <button id="productsBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all">
                                üì¶ Produtos
                            </button>
                            <button id="ordersBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all">
                                üõí Pedidos
                            </button>
                            <button id="chatBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium relative transition-all">
                                üí¨ Chat
                                <span id="chatNotification" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden notification-badge">0</span>
                            </button>
                            <button id="notificationsBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium relative transition-all">
                                üîî Notifica√ß√µes
                                <span id="notificationHistoryBadge" class="absolute -top-1 -right-1 bg-purple-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden notification-badge">0</span>
                            </button>
                        </nav>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="adminMenuBtn" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all">
                                <img id="adminAvatar" src="" alt="Admin" class="w-8 h-8 rounded-full">
                                <span id="adminName" class="text-sm font-medium text-gray-700 dark:text-gray-300 hidden sm:block">Admin</span>
                            </button>
                            <div id="adminMenu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 animate-scale-in">
                                <div id="adminMenuContent">
                                    <!-- Content will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        <button id="logoutBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-all transform hover:scale-105">
                            üö™ Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Mobile Navigation -->
        <div class="md:hidden bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="flex overflow-x-auto px-4 py-2 space-x-4">
                <button id="mobileDashboardBtn" class="mobile-nav-btn whitespace-nowrap px-3 py-2 text-sm text-primary bg-primary bg-opacity-10 rounded-lg transition-all">
                    üìä Dashboard
                </button>
                <button id="mobileProductsBtn" class="mobile-nav-btn whitespace-nowrap px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-primary rounded-lg transition-all">
                    üì¶ Produtos
                </button>
                <button id="mobileOrdersBtn" class="mobile-nav-btn whitespace-nowrap px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-primary rounded-lg transition-all">
                    üõí Pedidos
                </button>
                <button id="mobileChatBtn" class="mobile-nav-btn whitespace-nowrap px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-primary rounded-lg relative transition-all">
                    üí¨ Chat
                    <span id="mobileChatNotification" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden notification-badge">0</span>
                </button>
                <button id="mobileNotificationsBtn" class="mobile-nav-btn whitespace-nowrap px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-primary rounded-lg relative transition-all">
                    üîî Notifica√ß√µes
                    <span id="mobileNotificationHistoryBadge" class="absolute -top-1 -right-1 bg-purple-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden notification-badge">0</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section-transition">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Dashboard</h2>
                    <p class="text-gray-600 dark:text-gray-400">Vis√£o geral da sua loja</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in transform hover:scale-105 transition-all">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <div class="text-2xl">üì¶</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total de Produtos</p>
                                <p id="totalProducts" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in transform hover:scale-105 transition-all">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                                <div class="text-2xl">‚è≥</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pedidos Pendentes</p>
                                <p id="pendingOrders" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in transform hover:scale-105 transition-all">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <div class="text-2xl">‚úÖ</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pedidos Aprovados</p>
                                <p id="approvedOrders" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in transform hover:scale-105 transition-all">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg">
                                <div class="text-2xl">üéâ</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pedidos Entregues</p>
                                <p id="deliveredOrders" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in transform hover:scale-105 transition-all">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg">
                                <div class="text-2xl">üí¨</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Usu√°rios Ativos</p>
                                <p id="activeUsers" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">A√ß√µes R√°pidas</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button id="addProductBtn" class="flex items-center p-4 bg-primary bg-opacity-10 hover:bg-opacity-20 rounded-lg transition-all transform hover:scale-105">
                            <div class="text-2xl mr-3">‚ûï</div>
                            <div class="text-left">
                                <p class="font-medium text-primary">Adicionar Produto</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Cadastrar novo produto</p>
                            </div>
                        </button>
                        <button id="viewPendingOrdersBtn" class="flex items-center p-4 bg-yellow-50 dark:bg-yellow-900 hover:bg-yellow-100 dark:hover:bg-yellow-800 rounded-lg transition-all transform hover:scale-105">
                            <div class="text-2xl mr-3">‚è≥</div>
                            <div class="text-left">
                                <p class="font-medium text-yellow-700 dark:text-yellow-300">Ver Pedidos Pendentes</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Revisar novos pedidos</p>
                            </div>
                        </button>
                        <button id="openChatBtn" class="flex items-center p-4 bg-green-50 dark:bg-green-900 hover:bg-green-100 dark:hover:bg-green-800 rounded-lg transition-all transform hover:scale-105">
                            <div class="text-2xl mr-3">üí¨</div>
                            <div class="text-left">
                                <p class="font-medium text-green-700 dark:text-green-300">Abrir Chat</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Conversar com clientes</p>
                            </div>
                        </button>
                        <button id="sendNotificationBtn" class="flex items-center p-4 bg-purple-50 dark:bg-purple-900 hover:bg-purple-100 dark:hover:bg-purple-800 rounded-lg transition-all transform hover:scale-105">
                            <div class="text-2xl mr-3">üîî</div>
                            <div class="text-left">
                                <p class="font-medium text-purple-700 dark:text-purple-300">Enviar Notifica√ß√£o</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Notificar usu√°rios</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="hidden section-transition">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 space-y-4 sm:space-y-0">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Gest√£o de Produtos</h2>
                        <p class="text-gray-600 dark:text-gray-400">Gerencie o cat√°logo da sua loja</p>
                    </div>
                    <button id="addProductModalBtn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all flex items-center transform hover:scale-105">
                        <span class="mr-2">‚ûï</span>Adicionar Produto
                    </button>
                </div>

                <!-- Products Grid -->
                <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="text-center py-12 col-span-full">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-600 dark:text-gray-400">Carregando produtos...</p>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="ordersSection" class="hidden section-transition">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Gest√£o de Pedidos</h2>
                    <p class="text-gray-600 dark:text-gray-400">Gerencie os pedidos dos clientes</p>
                </div>

                <!-- Order Filters -->
                <div class="mb-6 flex flex-wrap gap-2">
                    <button class="order-filter-btn bg-primary text-white px-4 py-2 rounded-full text-sm font-medium transition-all transform hover:scale-105" data-status="all">
                        Todos
                    </button>
                    <button class="order-filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium transition-all transform hover:scale-105" data-status="pending">
                        Pendentes
                    </button>
                    <button class="order-filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium transition-all transform hover:scale-105" data-status="approved">
                        Aprovados
                    </button>
                    <button class="order-filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium transition-all transform hover:scale-105" data-status="delivered">
                        Entregues
                    </button>
                    <button class="order-filter-btn bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium transition-all transform hover:scale-105" data-status="rejected">
                        Rejeitados
                    </button>
                </div>

                <!-- Orders Grid -->
                <div id="ordersGrid" class="space-y-6">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-600 dark:text-gray-400">Carregando pedidos...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection" class="hidden section-transition">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Central de Chat</h2>
                    <p class="text-gray-600 dark:text-gray-400">Converse com os clientes em tempo real</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Users List -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 animate-fade-in">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Usu√°rios Registrados</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Clique para iniciar conversa</p>
                        </div>
                        <div id="usersList" class="p-4 max-h-96 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2"></div>
                                <p>Carregando usu√°rios...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col h-96 animate-fade-in">
                        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
                            <div id="chatHeader" class="flex items-center space-x-3">
                                <div class="text-lg">üí¨</div>
                                <div>
                                    <h4 class="font-semibold text-gray-800 dark:text-gray-200">Selecione um usu√°rio</h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Para iniciar uma conversa</p>
                                </div>
                            </div>
                            <button id="closeChatBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hidden transition-all transform hover:scale-110">
                                ‚ùå
                            </button>
                        </div>
                        
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-900">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-12 animate-fade-in">
                                <div class="text-4xl mb-4">üí¨</div>
                                <p>Selecione um usu√°rio para come√ßar a conversar</p>
                            </div>
                        </div>
                        
                        <div id="chatInputContainer" class="p-4 border-t border-gray-200 dark:border-gray-700 hidden">
                            <div class="flex space-x-2 mb-2">
                                <input type="text" id="chatInput" placeholder="Digite sua mensagem..." 
                                       class="flex-1 px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                <input type="file" id="chatImageInput" accept="image/*" class="hidden">
                                <button id="chatImageBtn" class="px-3 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all transform hover:scale-105">
                                    üì∑
                                </button>
                                <button id="sendChatBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105">
                                    üì§
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Pressione Enter para enviar ‚Ä¢ Clique em üì∑ para enviar imagem</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Notifications Section -->
            <div id="notificationsSection" class="hidden section-transition">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Central de Notifica√ß√µes</h2>
                    <p class="text-gray-600 dark:text-gray-400">Envie notifica√ß√µes e gerencie o sistema de comunica√ß√£o</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Send Notification Form -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Enviar Notifica√ß√£o</h3>
                        
                        <form id="notificationForm">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Destinat√°rios</label>
                                    <select id="notificationTarget" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                        <option value="all">Todos os usu√°rios</option>
                                        <option value="specific">Usu√°rio espec√≠fico</option>
                                    </select>
                                </div>

                                <div id="specificUserContainer" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selecionar Usu√°rio</label>
                                    <select id="specificUser" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                        <option value="">Carregando usu√°rios...</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo</label>
                                    <select id="notificationType" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                        <option value="info">Informa√ß√£o</option>
                                        <option value="success">Sucesso</option>
                                        <option value="warning">Aviso</option>
                                        <option value="error">Erro</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">T√≠tulo *</label>
                                    <input type="text" id="notificationTitle" required placeholder="Ex: Nova Promo√ß√£o!" 
                                           class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mensagem *</label>
                                    <textarea id="notificationMessage" required rows="4" placeholder="Digite sua mensagem..." 
                                              class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"></textarea>
                                </div>

                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="autoNotification" class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                                    <label for="autoNotification" class="text-sm text-gray-700 dark:text-gray-300">Enviar automaticamente para novos pedidos similares</label>
                                </div>

                                <button type="submit" id="sendNotificationFormBtn" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105">
                                    <span id="sendNotificationText">üì§ Enviar Notifica√ß√£o</span>
                                    <span id="sendNotificationLoader" class="hidden">
                                        <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                        Enviando...
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Enhanced Quick Templates and History -->
                    <div class="space-y-6">
                        <!-- Quick Templates -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Templates R√°pidos</h3>
                            
                            <div class="space-y-3">
                                <button onclick="useNotificationTemplate('promotion')" class="w-full text-left p-3 bg-yellow-50 dark:bg-yellow-900 hover:bg-yellow-100 dark:hover:bg-yellow-800 rounded-lg transition-all transform hover:scale-105">
                                    <h4 class="font-medium text-yellow-800 dark:text-yellow-200">üéâ Promo√ß√£o</h4>
                                    <p class="text-sm text-yellow-600 dark:text-yellow-400">Anunciar ofertas especiais</p>
                                </button>

                                <button onclick="useNotificationTemplate('order_update')" class="w-full text-left p-3 bg-blue-50 dark:bg-blue-900 hover:bg-blue-100 dark:hover:bg-blue-800 rounded-lg transition-all transform hover:scale-105">
                                    <h4 class="font-medium text-blue-800 dark:text-blue-200">üì¶ Atualiza√ß√£o de Pedido</h4>
                                    <p class="text-sm text-blue-600 dark:text-blue-400">Status do pedido alterado</p>
                                </button>

                                <button onclick="useNotificationTemplate('new_product')" class="w-full text-left p-3 bg-green-50 dark:bg-green-900 hover:bg-green-100 dark:hover:bg-green-800 rounded-lg transition-all transform hover:scale-105">
                                    <h4 class="font-medium text-green-800 dark:text-green-200">‚ú® Novo Produto</h4>
                                    <p class="text-sm text-green-600 dark:text-green-400">Lan√ßamento de produtos</p>
                                </button>

                                <button onclick="useNotificationTemplate('maintenance')" class="w-full text-left p-3 bg-red-50 dark:bg-red-900 hover:bg-red-100 dark:hover:bg-red-800 rounded-lg transition-all transform hover:scale-105">
                                    <h4 class="font-medium text-red-800 dark:text-red-200">‚ö†Ô∏è Manuten√ß√£o</h4>
                                    <p class="text-sm text-red-600 dark:text-red-400">Aviso de manuten√ß√£o</p>
                                </button>
                            </div>

                            <!-- Test and Real-time Controls -->
                            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-600 space-y-3">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">üß™ Controles do Sistema</h4>
                                
                                <button onclick="testNotificationSystem()" class="w-full p-3 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-all transform hover:scale-105 border border-gray-200 dark:border-gray-600">
                                    <h4 class="font-medium text-gray-800 dark:text-gray-200">üîß Testar Notifica√ß√µes</h4>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Enviar notifica√ß√£o de teste</p>
                                </button>

                                <button onclick="toggleRealTimeNotifications()" id="realTimeToggle" class="w-full p-3 bg-green-50 dark:bg-green-700 hover:bg-green-100 dark:hover:bg-green-600 rounded-lg transition-all transform hover:scale-105 border border-green-200 dark:border-green-600">
                                    <h4 class="font-medium text-green-800 dark:text-green-200">üîÑ Tempo Real: <span id="realTimeStatus">Ativo</span></h4>
                                    <p class="text-sm text-green-600 dark:text-green-400">Notifica√ß√µes autom√°ticas</p>
                                </button>
                            </div>
                        </div>

                        <!-- Notification History -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Hist√≥rico</h3>
                                <button onclick="clearNotificationHistory()" class="text-sm text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition-all">
                                    üóëÔ∏è Limpar
                                </button>
                            </div>
                            
                            <div id="notificationHistoryList" class="notification-history space-y-2">
                                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                                    <p class="text-sm">Nenhum hist√≥rico ainda</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Profile Picture Modal -->
    <div id="profilePictureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full animate-scale-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Alterar Foto do Perfil</h3>
                    <button id="closeProfilePictureBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl transition-all">
                        ‚ùå
                    </button>
                </div>
                
                <div class="text-center">
                    <div class="relative inline-block mb-4">
                        <img id="profilePicturePreview" src="" alt="Preview" class="w-32 h-32 rounded-full object-cover border-4 border-gray-300 dark:border-gray-600">
                        <label for="newProfilePicture" class="absolute bottom-2 right-2 bg-primary text-white rounded-full p-2 cursor-pointer hover:bg-primary-dark transition-all transform hover:scale-110">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </label>
                        <input type="file" id="newProfilePicture" accept="image/*" class="hidden">
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Clique no √≠cone da c√¢mera para escolher uma nova foto</p>
                    
                    <div class="flex space-x-3">
                        <button id="cancelProfilePictureBtn" class="flex-1 px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                            Cancelar
                        </button>
                        <button id="saveProfilePictureBtn" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105" disabled>
                            <span id="saveProfilePictureText">Salvar</span>
                            <span id="saveProfilePictureLoader" class="hidden">
                                <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                Salvando...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto animate-scale-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="productModalTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-200">Adicionar Produto</h3>
                    <button id="closeProductModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl transition-all">
                        ‚ùå
                    </button>
                </div>
                
                <form id="productForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Image Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Imagem do Produto</label>
                                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-primary transition-all">
                                    <input type="file" id="productImage" accept="image/*" class="hidden">
                                    <div id="imagePreview" class="mb-4">
                                        <div class="w-32 h-32 mx-auto bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                            <div class="text-3xl text-gray-400">üì∑</div>
                                        </div>
                                    </div>
                                    <button type="button" onclick="document.getElementById('productImage').click()" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark transition-all transform hover:scale-105">
                                        Escolher Imagem
                                    </button>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">PNG, JPG at√© 5MB</p>
                                </div>
                            </div>

                            <!-- Basic Info -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome do Produto *</label>
                                <input type="text" id="productName" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria *</label>
                                <select id="productCategory" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="eletronicos">Eletr√¥nicos</option>
                                    <option value="roupas">Roupas</option>
                                    <option value="casa">Casa e Jardim</option>
                                    <option value="livros">Livros</option>
                                    <option value="esportes">Esportes</option>
                                    <option value="beleza">Beleza</option>
                                    <option value="acessorios">Acess√≥rios & Joias</option>
                                    <option value="calcados">Cal√ßados</option>
                                    <option value="alimentacao">Alimenta√ß√£o & Bebidas</option>
                                    <option value="saude">Sa√∫de & Bem-estar</option>
                                    <option value="automotivo">Automotivo</option>
                                    <option value="brinquedos">Brinquedos & Jogos</option>
                                    <option value="musica">M√∫sica & Instrumentos</option>
                                    <option value="arte">Arte & Artesanato</option>
                                    <option value="pets">Pets</option>
                                    <option value="servicos">Servi√ßos</option>
                                </select>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Pricing -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pre√ßo *</label>
                                    <input type="number" id="productPrice" required min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pre√ßo Antigo</label>
                                    <input type="number" id="productOldPrice" min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estoque *</label>
                                <input type="number" id="productStock" required min="0" value="1" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descri√ß√£o</label>
                                <textarea id="productDescription" rows="4" placeholder="Descri√ß√£o detalhada do produto..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancelProductBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all">
                            Cancelar
                        </button>
                        <button type="submit" id="saveProductBtn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105">
                            <span id="saveProductText">Salvar Produto</span>
                            <span id="saveProductLoader" class="hidden">
                                <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                Salvando...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto animate-scale-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="orderDetailTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-200">Detalhes do Pedido</h3>
                    <button id="closeOrderDetailBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xl transition-all">
                        ‚ùå
                    </button>
                </div>
                
                <div id="orderDetailContent" class="space-y-6">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and Main JavaScript -->
    <script type="module">
        console.log('üöÄ Iniciando Kuia+ Admin...');
        document.getElementById('loadingStatus').textContent = 'Carregando Firebase...';

        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getDatabase, ref, onValue, push, set, remove, update } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        console.log('‚úÖ Firebase modules loaded');
        document.getElementById('loadingStatus').textContent = 'Conectando ao Firebase...';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArmhNnjraGaY017AP5uRcM8w0WWditrIs",
            authDomain: "kuia-shop.firebaseapp.com",
            projectId: "kuia-shop",
            storageBucket: "kuia-shop.appspot.com",
            messagingSenderId: "53786495493",
            appId: "1:53786495493:web:85fa67bd5de1d351b1ea6c",
            measurementId: "G-LTZ8VLN3LN"
        };

        // Initialize Firebase
        let app, auth, database, firestore;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);
            firestore = getFirestore(app);
            console.log('‚úÖ Firebase initialized successfully');
            document.getElementById('loadingStatus').textContent = 'Firebase conectado!';
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            document.getElementById('loadingStatus').textContent = 'Erro na conex√£o com Firebase';
            showAccessDenied();
        }

        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let products = {};
        let orders = {};
        let users = {};
        let currentSection = 'dashboard';
        let currentOrderFilter = 'all';
        let editingProductId = null;
        let uploadedImageUrl = null;
        let uploadedPhotoURL = null;
        let currentChatId = null;
        let selectedUserId = null;
        let chatMessages = {};
        let realTimeNotificationsEnabled = true;
        let notificationHistory = [];
        let realTimeListeners = [];

        // API Key for image upload
        const apiKeyImgBB = 'e073e02267a1f0259cd69c562e780659';

        // DOM elements
        const loadingScreen = document.getElementById('loadingScreen');
        const accessDeniedScreen = document.getElementById('accessDeniedScreen');
        const adminPanel = document.getElementById('adminPanel');

        // Navigation elements
        const dashboardBtn = document.getElementById('dashboardBtn');
        const productsBtn = document.getElementById('productsBtn');
        const ordersBtn = document.getElementById('ordersBtn');
        const chatBtn = document.getElementById('chatBtn');
        const notificationsBtn = document.getElementById('notificationsBtn');
        const chatNotification = document.getElementById('chatNotification');

        // Mobile navigation
        const mobileDashboardBtn = document.getElementById('mobileDashboardBtn');
        const mobileProductsBtn = document.getElementById('mobileProductsBtn');
        const mobileOrdersBtn = document.getElementById('mobileOrdersBtn');
        const mobileChatBtn = document.getElementById('mobileChatBtn');
        const mobileNotificationsBtn = document.getElementById('mobileNotificationsBtn');
        const mobileChatNotification = document.getElementById('mobileChatNotification');

        // Section elements
        const dashboardSection = document.getElementById('dashboardSection');
        const productsSection = document.getElementById('productsSection');
        const ordersSection = document.getElementById('ordersSection');
        const chatSection = document.getElementById('chatSection');
        const notificationsSection = document.getElementById('notificationsSection');

        // Modal elements
        const productModal = document.getElementById('productModal');
        const orderDetailModal = document.getElementById('orderDetailModal');
        const profilePictureModal = document.getElementById('profilePictureModal');

        // Chat elements
        const usersList = document.getElementById('usersList');
        const chatMessages_dom = document.getElementById('chatMessages');
        const chatInputContainer = document.getElementById('chatInputContainer');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatImageBtn = document.getElementById('chatImageBtn');
        const chatImageInput = document.getElementById('chatImageInput');
        const chatHeader = document.getElementById('chatHeader');
        const closeChatBtn = document.getElementById('closeChatBtn');

        // Notification elements
        const notificationArea = document.getElementById('notificationArea');
        const notificationForm = document.getElementById('notificationForm');
        const notificationTarget = document.getElementById('notificationTarget');
        const specificUserContainer = document.getElementById('specificUserContainer');
        const specificUser = document.getElementById('specificUser');

        // Profile picture elements
        const profilePicturePreview = document.getElementById('profilePicturePreview');
        const newProfilePicture = document.getElementById('newProfilePicture');
        const saveProfilePictureBtn = document.getElementById('saveProfilePictureBtn');
        const saveProfilePictureText = document.getElementById('saveProfilePictureText');
        const saveProfilePictureLoader = document.getElementById('saveProfilePictureLoader');

        // Admin menu elements
        const adminMenuBtn = document.getElementById('adminMenuBtn');
        const adminMenu = document.getElementById('adminMenu');
        const adminMenuContent = document.getElementById('adminMenuContent');

        // Enhanced real-time notification system
        function showNotificationToast(title, message, type = 'info', persistent = false) {
            const toast = document.createElement('div');
            const typeColors = {
                info: 'bg-blue-500 border-blue-400',
                success: 'bg-green-500 border-green-400',
                warning: 'bg-yellow-500 border-yellow-400',
                error: 'bg-red-500 border-red-400'
            };
            
            const typeIcons = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå'
            };
            
            toast.className = `${typeColors[type]} text-white p-4 rounded-lg shadow-lg border-l-4 animate-notification-slide relative overflow-hidden`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-xl">${typeIcons[type]}</span>
                        <div>
                            <h4 class="font-semibold">${title}</h4>
                            <p class="text-sm opacity-90">${message}</p>
                        </div>
                    </div>
                    <button onclick="this.closest('.fixed').querySelector('.animate-notification-slide').remove()" class="text-white hover:opacity-75 ml-4 transition-all transform hover:scale-110 flex-shrink-0">
                        ‚úï
                    </button>
                </div>
                ${!persistent ? '<div class="absolute bottom-0 left-0 h-1 bg-white opacity-30 toast-progress"></div>' : ''}
            `;
            
            notificationArea.appendChild(toast);
            
            // Store in history
            addNotificationToHistory(title, message, type);
            
            if (!persistent) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(100%)';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            }
            
            // Add sound notification for important messages
            if (type === 'error' || type === 'warning') {
                playNotificationSound();
            }
        }

        function addNotificationToHistory(title, message, type) {
            notificationHistory.unshift({
                title,
                message,
                type,
                timestamp: Date.now(),
                id: Date.now()
            });
            
            // Keep only last 50 notifications
            if (notificationHistory.length > 50) {
                notificationHistory = notificationHistory.slice(0, 50);
            }
            
            updateNotificationHistoryDisplay();
            updateNotificationBadge();
        }

        function updateNotificationHistoryDisplay() {
            const historyList = document.getElementById('notificationHistoryList');
            
            if (notificationHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <p class="text-sm">Nenhum hist√≥rico ainda</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = notificationHistory.slice(0, 10).map(notif => {
                const typeColors = {
                    info: 'text-blue-600 dark:text-blue-400',
                    success: 'text-green-600 dark:text-green-400', 
                    warning: 'text-yellow-600 dark:text-yellow-400',
                    error: 'text-red-600 dark:text-red-400'
                };
                
                return `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg animate-fade-in">
                        <div class="flex items-start space-x-2">
                            <span class="${typeColors[notif.type]} text-sm font-medium">${notif.type.toUpperCase()}</span>
                            <div class="flex-1 min-w-0">
                                <h5 class="text-sm font-medium text-gray-800 dark:text-gray-200 truncate">${notif.title}</h5>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1 line-clamp-2">${notif.message}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                    ${new Date(notif.timestamp).toLocaleString('pt-BR')}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationHistoryBadge');
            const mobileBadge = document.getElementById('mobileNotificationHistoryBadge');
            const count = notificationHistory.length;
            
            if (count > 0) {
                const displayCount = count > 99 ? '99+' : count.toString();
                badge.textContent = displayCount;
                badge.classList.remove('hidden');
                mobileBadge.textContent = displayCount;
                mobileBadge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                mobileBadge.classList.add('hidden');
            }
        }

        function playNotificationSound() {
            // Create audio context for notification sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Audio notification not available');
            }
        }

        // Real-time notification system
        function initializeRealTimeNotifications() {
            if (!realTimeNotificationsEnabled) return;
            
            console.log('üîÑ Initializing real-time notification system...');
            
            // Listen for new orders
            const ordersRef = ref(database, 'orders');
            const orderListener = onValue(ordersRef, (snapshot) => {
                const newOrders = snapshot.val() || {};
                
                // Check for new pending orders
                Object.entries(newOrders).forEach(([orderId, order]) => {
                    if (order.status === 'pending' && !orders[orderId]) {
                        // New pending order detected
                        showNotificationToast(
                            'üõí Novo Pedido!', 
                            `Pedido #${orderId.slice(-6)} recebido de ${order.customer.name}`,
                            'warning',
                            true
                        );
                        
                        // Automatically send notification to customer
                        setTimeout(() => {
                            sendAutoOrderNotification(orderId, order);
                        }, 1000);
                    }
                });
                
                orders = newOrders;
                renderOrders();
                updateDashboardStats();
            });
            
            realTimeListeners.push(orderListener);
            
            // Listen for low stock alerts
            const productsRef = ref(database, 'products');
            const productListener = onValue(productsRef, (snapshot) => {
                const newProducts = snapshot.val() || {};
                
                Object.entries(newProducts).forEach(([productId, product]) => {
                    if (product.stock <= 5 && product.stock > 0) {
                        if (!products[productId] || products[productId].stock > 5) {
                            showNotificationToast(
                                '‚ö†Ô∏è Estoque Baixo',
                                `${product.name} tem apenas ${product.stock} unidades restantes`,
                                'warning'
                            );
                        }
                    } else if (product.stock === 0) {
                        if (!products[productId] || products[productId].stock > 0) {
                            showNotificationToast(
                                'üö´ Produto Esgotado',
                                `${product.name} est√° fora de estoque`,
                                'error'
                            );
                        }
                    }
                });
                
                products = newProducts;
                renderProducts();
                updateDashboardStats();
            });
            
            realTimeListeners.push(productListener);
            
            // Show real-time status
            document.getElementById('realTimeStatus').classList.remove('hidden');
            
            console.log('‚úÖ Real-time notifications initialized');
        }

        async function sendAutoOrderNotification(orderId, order) {
            try {
                if (!order.customer.userId) return;
                
                const notificationData = {
                    title: 'üì¶ Pedido Recebido',
                    message: `Seu pedido #${orderId.slice(-6)} foi recebido e est√° sendo processado. Total: ${formatPrice(order.total)}`,
                    type: 'info',
                    timestamp: Date.now(),
                    read: false,
                    adminId: currentUser.uid,
                    adminName: 'Sistema Autom√°tico',
                    isAuto: true
                };
                
                const notificationId = `auto_notif_${Date.now()}`;
                await Promise.all([
                    set(ref(database, `notifications/${order.customer.userId}/${notificationId}`), notificationData),
                    setDoc(doc(firestore, 'notifications', order.customer.userId, 'messages', notificationId), notificationData)
                ]);
                
                console.log('üì§ Auto notification sent for order:', orderId);
                
            } catch (error) {
                console.error('‚ùå Auto notification error:', error);
            }
        }

        // Toggle real-time notifications
        window.toggleRealTimeNotifications = function() {
            realTimeNotificationsEnabled = !realTimeNotificationsEnabled;
            const toggle = document.getElementById('realTimeToggle');
            const status = document.getElementById('realTimeStatus');
            
            if (realTimeNotificationsEnabled) {
                initializeRealTimeNotifications();
                toggle.className = toggle.className.replace('bg-red', 'bg-green');
                status.textContent = 'Ativo';
                showNotificationToast('Sistema', 'Notifica√ß√µes em tempo real ativadas', 'success');
            } else {
                // Stop all listeners
                realTimeListeners.forEach(unsubscribe => unsubscribe());
                realTimeListeners = [];
                document.getElementById('realTimeStatus').classList.add('hidden');
                toggle.className = toggle.className.replace('bg-green', 'bg-red');
                status.textContent = 'Inativo';
                showNotificationToast('Sistema', 'Notifica√ß√µes em tempo real desativadas', 'warning');
            }
        };

        // Clear notification history
        window.clearNotificationHistory = function() {
            showConfirmDialog(
                'Tem certeza que deseja limpar todo o hist√≥rico de notifica√ß√µes?',
                () => {
                    notificationHistory = [];
                    updateNotificationHistoryDisplay();
                    updateNotificationBadge();
                    showNotificationToast('Sucesso', 'Hist√≥rico de notifica√ß√µes limpo', 'success');
                }
            );
        };

        // Notification templates
        function useNotificationTemplate(template) {
            const templates = {
                promotion: {
                    title: 'üéâ Promo√ß√£o Especial!',
                    message: 'N√£o perca! Descontos de at√© 50% em produtos selecionados. Aproveite agora!',
                    type: 'warning'
                },
                order_update: {
                    title: 'üì¶ Atualiza√ß√£o do Pedido',
                    message: 'Seu pedido foi atualizado. Verifique o status na se√ß√£o de pedidos.',
                    type: 'info'
                },
                new_product: {
                    title: '‚ú® Novo Produto Dispon√≠vel',
                    message: 'Acabou de chegar! Confira nosso mais novo produto na loja.',
                    type: 'success'
                },
                maintenance: {
                    title: '‚ö†Ô∏è Manuten√ß√£o Programada',
                    message: 'Sistema em manuten√ß√£o das 02:00 √†s 04:00. Pedimos desculpas pelo inconveniente.',
                    type: 'error'
                }
            };

            const selectedTemplate = templates[template];
            if (selectedTemplate) {
                document.getElementById('notificationTitle').value = selectedTemplate.title;
                document.getElementById('notificationMessage').value = selectedTemplate.message;
                document.getElementById('notificationType').value = selectedTemplate.type;
            }
        }

        // Make function globally available
        window.useNotificationTemplate = useNotificationTemplate;

        // Profile picture functionality
        function openProfilePictureModal() {
            profilePicturePreview.src = currentUser.photoURL || 'https://via.placeholder.com/128?text=üë§';
            uploadedPhotoURL = null;
            saveProfilePictureBtn.disabled = true;
            profilePictureModal.classList.remove('hidden');
        }

        newProfilePicture.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                profilePicturePreview.src = e.target.result;
                profilePicturePreview.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    profilePicturePreview.style.transform = 'scale(1)';
                }, 200);
                saveProfilePictureBtn.disabled = false;
            };
            reader.readAsDataURL(file);

            // Upload to ImgBB
            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeyImgBB}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    uploadedPhotoURL = result.data.url;
                    console.log('Profile image uploaded successfully:', uploadedPhotoURL);
                } else {
                    showCustomAlert('Erro ao fazer upload da imagem.');
                    saveProfilePictureBtn.disabled = true;
                }
            } catch (error) {
                console.error('Image upload error:', error);
                showCustomAlert('Erro ao fazer upload da imagem.');
                saveProfilePictureBtn.disabled = true;
            }
        });

        saveProfilePictureBtn.addEventListener('click', async () => {
            if (!uploadedPhotoURL || !currentUser) return;

            // Show loading state
            saveProfilePictureText.classList.add('hidden');
            saveProfilePictureLoader.classList.remove('hidden');
            saveProfilePictureBtn.disabled = true;

            try {
                // Update profile photo in Firebase Auth
                await updateProfile(currentUser, {
                    photoURL: uploadedPhotoURL
                });

                // Update in Firestore
                await setDoc(doc(firestore, 'users', currentUser.uid), {
                    photoURL: uploadedPhotoURL,
                    updatedAt: new Date()
                }, { merge: true });

                // Update in Realtime Database
                await update(ref(database, `users/${currentUser.uid}`), {
                    photoURL: uploadedPhotoURL,
                    updatedAt: Date.now()
                });

                // Update UI
                document.getElementById('adminAvatar').src = uploadedPhotoURL;

                showNotificationToast('Sucesso', 'Foto de perfil atualizada com sucesso!', 'success');
                closeProfilePictureModal();
            } catch (error) {
                console.error('Error updating profile picture:', error);
                showCustomAlert('Erro ao atualizar foto de perfil. Tente novamente.');
            } finally {
                // Reset loading state
                saveProfilePictureText.classList.remove('hidden');
                saveProfilePictureLoader.classList.add('hidden');
                saveProfilePictureBtn.disabled = false;
            }
        });

        function closeProfilePictureModal() {
            profilePictureModal.classList.add('hidden');
            uploadedPhotoURL = null;
        }

        document.getElementById('closeProfilePictureBtn').addEventListener('click', closeProfilePictureModal);
        document.getElementById('cancelProfilePictureBtn').addEventListener('click', closeProfilePictureModal);

        // Notification form handlers
        notificationTarget.addEventListener('change', () => {
            if (notificationTarget.value === 'specific') {
                specificUserContainer.classList.remove('hidden');
                loadUsersForNotification();
            } else {
                specificUserContainer.classList.add('hidden');
            }
        });

        function loadUsersForNotification() {
            const usersArray = Object.entries(users).map(([id, user]) => ({ id, ...user }))
                .filter(user => user.email && user.name && user.id !== currentUser.uid); // Don't include admin
            
            if (usersArray.length === 0) {
                specificUser.innerHTML = '<option value="">Nenhum usu√°rio encontrado</option>';
                return;
            }
            
            specificUser.innerHTML = [
                '<option value="">Selecione um usu√°rio</option>',
                ...usersArray.map(user => 
                    `<option value="${user.id}">${user.name} (${user.email})</option>`
                )
            ].join('');
            
            console.log('üìã Users loaded for notifications:', usersArray.length);
        }

        notificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const sendText = document.getElementById('sendNotificationText');
            const sendLoader = document.getElementById('sendNotificationLoader');
            const sendBtn = document.getElementById('sendNotificationFormBtn');
            
            // Show loading state
            sendText.classList.add('hidden');
            sendLoader.classList.remove('hidden');
            sendBtn.disabled = true;
            
            try {
                const notificationData = {
                    title: document.getElementById('notificationTitle').value.trim(),
                    message: document.getElementById('notificationMessage').value.trim(),
                    type: document.getElementById('notificationType').value,
                    timestamp: Date.now(),
                    read: false,
                    adminId: currentUser.uid,
                    adminName: currentUser.displayName || currentUser.email
                };

                // Validate inputs
                if (!notificationData.title || !notificationData.message) {
                    showCustomAlert('Por favor, preencha o t√≠tulo e a mensagem.');
                    return;
                }

                console.log('Sending notification:', notificationData);

                if (notificationTarget.value === 'all') {
                    // Send to all users - save in both databases
                    const notificationId = `notif_${Date.now()}`;
                    
                    const promises = [];
                    
                    // Save in Realtime Database (global notifications)
                    promises.push(set(ref(database, `notifications/global/${notificationId}`), notificationData));
                    
                    // Save in Firestore (global notifications)
                    promises.push(setDoc(doc(firestore, 'notifications', 'global', 'messages', notificationId), notificationData));
                    
                    // Also send to each individual user in Realtime Database
                    const usersArray = Object.keys(users);
                    console.log('Sending to users:', usersArray.length);
                    
                    usersArray.forEach(userId => {
                        if (userId !== currentUser.uid) { // Don't send to admin
                            promises.push(set(ref(database, `notifications/${userId}/${notificationId}`), notificationData));
                        }
                    });

                    await Promise.all(promises);
                    console.log('‚úÖ Global notification sent successfully');
                    showNotificationToast('Sucesso', `Notifica√ß√£o enviada para ${usersArray.length} usu√°rios!`, 'success');
                } else {
                    // Send to specific user
                    const userId = specificUser.value;
                    if (!userId) {
                        showCustomAlert('Por favor, selecione um usu√°rio.');
                        return;
                    }

                    const notificationId = `notif_${Date.now()}`;
                    const user = users[userId];
                    
                    console.log('Sending to specific user:', userId, user);

                    const promises = [
                        // Save in Realtime Database
                        set(ref(database, `notifications/${userId}/${notificationId}`), notificationData),
                        // Save in Firestore
                        setDoc(doc(firestore, 'notifications', userId, 'messages', notificationId), notificationData)
                    ];

                    await Promise.all(promises);
                    console.log('‚úÖ User-specific notification sent successfully');
                    showNotificationToast('Sucesso', `Notifica√ß√£o enviada para ${user?.name || 'usu√°rio selecionado'}!`, 'success');
                }

                // Reset form
                notificationForm.reset();
                specificUserContainer.classList.add('hidden');
                
            } catch (error) {
                console.error('‚ùå Error sending notification:', error);
                showCustomAlert(`Erro ao enviar notifica√ß√£o: ${error.message}. Verifique sua conex√£o e tente novamente.`);
            } finally {
                // Reset loading state
                sendText.classList.remove('hidden');
                sendLoader.classList.add('hidden');
                sendBtn.disabled = false;
            }
        });

        // Authentication check
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed:', user);
            currentUser = user;
            
            if (user) {
                await checkAdminAccess();
            } else {
                // Trigger Google login
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('Login error:', error);
                    showAccessDenied();
                }
            }
        });

        async function checkAdminAccess() {
            try {
                document.getElementById('loadingStatus').textContent = 'Verificando permiss√µes...';
                
                // Check if user is admin
                const adminDoc = await getDoc(doc(firestore, 'admins', currentUser.uid));
                
                if (adminDoc.exists() || currentUser.email === 'sibemcesar@gmail.com') {
                    isAdmin = true;
                    updateAdminUI();
                    showAdminPanel();
                    loadData();
                    initializeChat();
                    initializeRealTimeNotifications();
                } else {
                    console.log('‚ùå Access denied - user is not admin');
                    showAccessDenied();
                }
            } catch (error) {
                console.error('Error checking admin access:', error);
                showAccessDenied();
            }
        }

        function updateAdminUI() {
            document.getElementById('adminAvatar').src = currentUser.photoURL || 'https://via.placeholder.com/32?text=' + (currentUser.displayName?.charAt(0) || 'A');
            document.getElementById('adminName').textContent = currentUser.displayName || currentUser.email;
            
            adminMenuContent.innerHTML = `
                <button onclick="openProfilePictureModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-600 transition-all">
                    <span class="mr-2">üë§</span>Alterar Foto
                </button>
                <button onclick="showSection('notifications')" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-600 transition-all">
                    <span class="mr-2">üîî</span>Notifica√ß√µes
                </button>
                <button onclick="signOutAdmin()" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-lg transition-all">
                    <span class="mr-2">üö™</span>Sair
                </button>
            `;
        }

        // Make functions globally available
        window.openProfilePictureModal = openProfilePictureModal;
        window.signOutAdmin = async function() {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Admin menu toggle
        adminMenuBtn.addEventListener('click', () => {
            adminMenu.classList.toggle('hidden');
            if (!adminMenu.classList.contains('hidden')) {
                adminMenu.style.transform = 'scale(0.95)';
                adminMenu.style.opacity = '0';
                setTimeout(() => {
                    adminMenu.style.transform = 'scale(1)';
                    adminMenu.style.opacity = '1';
                }, 50);
            }
        });

        // Close admin menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!adminMenuBtn.contains(e.target) && !adminMenu.contains(e.target)) {
                adminMenu.classList.add('hidden');
            }
        });

        function showAdminPanel() {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                accessDeniedScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                adminPanel.style.opacity = '0';
                setTimeout(() => {
                    adminPanel.style.opacity = '1';
                }, 50);
            }, 300);
        }

        function showAccessDenied() {
            loadingScreen.classList.add('hidden');
            adminPanel.classList.add('hidden');
            accessDeniedScreen.classList.remove('hidden');
        }

        // Enhanced navigation with smooth transitions
        function showSection(section) {
            // Add fade out animation to current section
            const currentSectionElement = document.querySelector('.section-transition:not(.hidden)');
            if (currentSectionElement) {
                currentSectionElement.style.opacity = '0';
                currentSectionElement.style.transform = 'translateX(-20px)';
            }

            setTimeout(() => {
                currentSection = section;
                
                // Hide all sections
                dashboardSection.classList.add('hidden');
                productsSection.classList.add('hidden');
                ordersSection.classList.add('hidden');
                chatSection.classList.add('hidden');
                notificationsSection.classList.add('hidden');
                
                // Update navigation buttons
                document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                    btn.classList.remove('text-primary', 'bg-primary', 'bg-opacity-10');
                    btn.classList.add('text-gray-700', 'dark:text-gray-300');
                });
                
                let targetSection;
                // Show selected section and update nav
                switch (section) {
                    case 'dashboard':
                        targetSection = dashboardSection;
                        dashboardBtn.classList.add('text-primary');
                        mobileDashboardBtn.classList.add('text-primary', 'bg-primary', 'bg-opacity-10');
                        mobileDashboardBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                        break;
                    case 'products':
                        targetSection = productsSection;
                        productsBtn.classList.add('text-primary');
                        mobileProductsBtn.classList.add('text-primary', 'bg-primary', 'bg-opacity-10');
                        mobileProductsBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                        break;
                    case 'orders':
                        targetSection = ordersSection;
                        ordersBtn.classList.add('text-primary');
                        mobileOrdersBtn.classList.add('text-primary', 'bg-primary', 'bg-opacity-10');
                        mobileOrdersBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                        break;
                    case 'chat':
                        targetSection = chatSection;
                        chatBtn.classList.add('text-primary');
                        mobileChatBtn.classList.add('text-primary', 'bg-primary', 'bg-opacity-10');
                        mobileChatBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                        break;
                    case 'notifications':
                        targetSection = notificationsSection;
                        notificationsBtn.classList.add('text-primary');
                        mobileNotificationsBtn.classList.add('text-primary', 'bg-primary', 'bg-opacity-10');
                        mobileNotificationsBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                        loadUsersForNotification();
                        break;
                }

                // Show target section with animation
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.style.opacity = '0';
                    targetSection.style.transform = 'translateX(20px)';
                    
                    setTimeout(() => {
                        targetSection.style.opacity = '1';
                        targetSection.style.transform = 'translateX(0)';
                    }, 50);
                }
            }, 150);
        }

        // Make showSection globally available
        window.showSection = showSection;

        // Navigation event listeners
        dashboardBtn.addEventListener('click', () => showSection('dashboard'));
        productsBtn.addEventListener('click', () => showSection('products'));
        ordersBtn.addEventListener('click', () => showSection('orders'));
        chatBtn.addEventListener('click', () => showSection('chat'));
        notificationsBtn.addEventListener('click', () => showSection('notifications'));

        mobileDashboardBtn.addEventListener('click', () => showSection('dashboard'));
        mobileProductsBtn.addEventListener('click', () => showSection('products'));
        mobileOrdersBtn.addEventListener('click', () => showSection('orders'));
        mobileChatBtn.addEventListener('click', () => showSection('chat'));
        mobileNotificationsBtn.addEventListener('click', () => showSection('notifications'));

        // Quick action buttons
        document.getElementById('addProductBtn').addEventListener('click', () => {
            showSection('products');
            openProductModal();
        });
        document.getElementById('addProductModalBtn').addEventListener('click', openProductModal);
        document.getElementById('viewPendingOrdersBtn').addEventListener('click', () => {
            showSection('orders');
            filterOrders('pending');
        });
        document.getElementById('openChatBtn').addEventListener('click', () => showSection('chat'));
        document.getElementById('sendNotificationBtn').addEventListener('click', () => showSection('notifications'));

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Enhanced chat functionality with corrected user loading
        async function initializeChat() {
            try {
                console.log('Initializing chat system...');
                
                // Load all users from Firestore first
                const usersQuery = query(collection(firestore, 'users'));
                const usersSnapshot = await getDocs(usersQuery);
                
                users = {};
                usersSnapshot.docs.forEach(doc => {
                    users[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                console.log('‚úÖ Users loaded from Firestore:', Object.keys(users).length);
                renderUsersList();

                // Also check Realtime Database for additional users
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const realtimeUsers = snapshot.val() || {};
                    // Merge with existing users
                    Object.keys(realtimeUsers).forEach(userId => {
                        if (!users[userId]) {
                            users[userId] = { id: userId, ...realtimeUsers[userId] };
                        }
                    });
                    console.log('üë• Total users after merge:', Object.keys(users).length);
                    renderUsersList();
                });

                // Listen for new chat messages to update notifications
                const chatsRef = ref(database, 'chats/messages');
                onValue(chatsRef, (snapshot) => {
                    const allMessages = snapshot.val() || {};
                    updateChatNotifications(allMessages);
                });

            } catch (error) {
                console.error('Error initializing chat:', error);
                // Fallback to just Realtime Database
                const usersRef = ref(database, 'users');
                onValue(usersRef, (snapshot) => {
                    const usersData = snapshot.val() || {};
                    users = {};
                    Object.keys(usersData).forEach(userId => {
                        users[userId] = { id: userId, ...usersData[userId] };
                    });
                    console.log('üì± Fallback: Users loaded from Realtime Database:', Object.keys(users).length);
                    renderUsersList();
                });

                // Listen for chat messages
                const chatsRef = ref(database, 'chats/messages');
                onValue(chatsRef, (snapshot) => {
                    const allMessages = snapshot.val() || {};
                    updateChatNotifications(allMessages);
                });
            }
        }

        function renderUsersList() {
            const usersArray = Object.entries(users).map(([id, user]) => ({ id, ...user }))
                .filter(user => user.email && user.name); // Only show users with email and name
            
            if (usersArray.length === 0) {
                usersList.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400 animate-fade-in">
                        <div class="text-3xl mb-2">üë§</div>
                        <p class="text-sm">Nenhum usu√°rio registrado encontrado</p>
                        <p class="text-xs mt-1">Usu√°rios aparecer√£o aqui ap√≥s se registrarem na loja</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = usersArray.map(user => `
                <div class="flex items-center space-x-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-all user-item animate-fade-in transform hover:scale-105"
                     data-user-id="${user.id}">
                    <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name || 'U') + '&background=5D5CDE&color=fff'}" 
                         alt="${user.name}" class="w-10 h-10 rounded-full">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">${user.name || 'Usu√°rio'}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${user.email}</p>
                        ${user.isActive ? '<span class="inline-block w-2 h-2 bg-green-400 rounded-full"></span>' : ''}
                    </div>
                    <button class="start-chat-btn px-3 py-1 text-xs bg-primary text-white rounded hover:bg-primary-dark transition-all transform hover:scale-105"
                            data-user-id="${user.id}">
                        üí¨ Chat
                    </button>
                </div>
            `).join('');

            // Add event listeners for chat buttons
            document.querySelectorAll('.start-chat-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = btn.dataset.userId;
                    console.log('Starting chat with user:', userId);
                    startChat(userId);
                });
            });

            // Update active users count
            document.getElementById('activeUsers').textContent = usersArray.length;
        }

        async function startChat(userId) {
            try {
                console.log('Starting chat with user ID:', userId);
                selectedUserId = userId;
                const user = users[userId];
                
                if (!user) {
                    console.error('User not found:', userId);
                    showCustomAlert('Usu√°rio n√£o encontrado. Verifique se o usu√°rio ainda est√° registrado.');
                    return;
                }
                
                console.log('Found user:', user);
                
                // Create or get existing chat
                currentChatId = `admin_${currentUser.uid}_user_${userId}`;
                
                // Set up chat for user
                await set(ref(database, `chats/users/${userId}`), {
                    chatId: currentChatId,
                    active: true,
                    adminId: currentUser.uid,
                    startedAt: Date.now()
                });

                // Update chat header
                chatHeader.innerHTML = `
                    <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name || 'U') + '&background=5D5CDE&color=fff'}" 
                         alt="${user.name}" class="w-8 h-8 rounded-full">
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">${user.name || 'Usu√°rio'}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${user.email}</p>
                    </div>
                `;
                
                closeChatBtn.classList.remove('hidden');
                chatInputContainer.classList.remove('hidden');
                
                loadChatMessages();
                
                showNotificationToast('Chat', `Conversa iniciada com ${user.name}`, 'success');
                
                console.log('‚úÖ Chat started successfully');
                
            } catch (error) {
                console.error('Error starting chat:', error);
                showCustomAlert('Erro ao iniciar chat: ' + error.message);
            }
        }

        function loadChatMessages() {
            if (!currentChatId) return;

            console.log('Loading chat messages for:', currentChatId);
            const messagesRef = ref(database, `chats/messages/${currentChatId}`);
            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val() || {};
                const messagesList = Object.entries(messages)
                    .map(([id, msg]) => ({ id, ...msg }))
                    .sort((a, b) => a.timestamp - b.timestamp);

                displayChatMessages(messagesList);
            });
        }

        function displayChatMessages(messages) {
            if (messages.length === 0) {
                chatMessages_dom.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-12 animate-fade-in">
                        <div class="text-4xl mb-4">üí¨</div>
                        <p>Converse com o cliente</p>
                        <p class="text-sm mt-2">Digite sua primeira mensagem abaixo</p>
                    </div>
                `;
                return;
            }

            chatMessages_dom.innerHTML = messages.map(msg => {
                const isAdmin = msg.senderId === currentUser.uid;
                let messageContent = '';
                
                if (msg.type === 'image') {
                    messageContent = `
                        <img src="${msg.imageUrl}" alt="Imagem" class="max-w-full h-auto rounded-lg cursor-pointer mb-2" 
                             onclick="window.open('${msg.imageUrl}', '_blank')">
                        ${msg.text ? `<p class="text-sm">${msg.text}</p>` : ''}
                    `;
                } else {
                    messageContent = `<p class="text-sm">${msg.text}</p>`;
                }
                
                return `
                    <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'} mb-3 animate-fade-in">
                        <div class="${isAdmin ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'} 
                                    rounded-lg px-3 py-2 max-w-xs lg:max-w-md">
                            ${messageContent}
                            <p class="${isAdmin ? 'text-blue-100' : 'text-gray-500 dark:text-gray-400'} text-xs mt-1">
                                ${new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            setTimeout(() => {
                chatMessages_dom.scrollTop = chatMessages_dom.scrollHeight;
            }, 100);
        }

        async function sendChatMessage(messageText = null, imageUrl = null) {
            if (!currentChatId || !selectedUserId || (!messageText && !imageUrl)) return;

            try {
                const messageData = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    timestamp: Date.now(),
                    read: false
                };

                if (imageUrl) {
                    messageData.type = 'image';
                    messageData.imageUrl = imageUrl;
                    messageData.text = messageText || '';
                } else {
                    messageData.type = 'text';
                    messageData.text = messageText;
                }

                await push(ref(database, `chats/messages/${currentChatId}`), messageData);
                console.log('‚úÖ Message sent successfully');
            } catch (error) {
                console.error('Error sending message:', error);
                showCustomAlert('Erro ao enviar mensagem. Tente novamente.');
            }
        }

        function updateChatNotifications(allMessages) {
            // Count unread messages from users (not from admin)
            let unreadCount = 0;
            Object.values(allMessages).forEach(chatMessages => {
                Object.values(chatMessages).forEach(msg => {
                    if (msg.senderId !== currentUser.uid && !msg.read) {
                        unreadCount++;
                    }
                });
            });

            if (unreadCount > 0) {
                chatNotification.textContent = unreadCount > 99 ? '99+' : unreadCount;
                chatNotification.classList.remove('hidden');
                mobileChatNotification.textContent = unreadCount > 99 ? '99+' : unreadCount;
                mobileChatNotification.classList.remove('hidden');
            } else {
                chatNotification.classList.add('hidden');
                mobileChatNotification.classList.add('hidden');
            }
        }

        // Chat image upload
        chatImageBtn.addEventListener('click', () => {
            chatImageInput.click();
        });

        chatImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Show loading state
            chatImageBtn.innerHTML = '‚è≥';
            chatImageBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeyImgBB}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    await sendChatMessage(null, result.data.url);
                } else {
                    showCustomAlert('Erro ao fazer upload da imagem.');
                }
            } catch (error) {
                console.error('Image upload error:', error);
                showCustomAlert('Erro ao fazer upload da imagem.');
            } finally {
                // Reset button state
                chatImageBtn.innerHTML = 'üì∑';
                chatImageBtn.disabled = false;
                chatImageInput.value = '';
            }
        });

        // Chat event listeners
        sendChatBtn.addEventListener('click', () => {
            const messageText = chatInput.value.trim();
            if (messageText) {
                sendChatMessage(messageText);
                chatInput.value = '';
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const messageText = chatInput.value.trim();
                if (messageText) {
                    sendChatMessage(messageText);
                    chatInput.value = '';
                }
            }
        });

        // Enhanced chat input with focus animations
        chatInput.addEventListener('focus', function() {
            this.style.transform = 'scale(1.02)';
        });

        chatInput.addEventListener('blur', function() {
            this.style.transform = 'scale(1)';
        });

        closeChatBtn.addEventListener('click', async () => {
            if (selectedUserId) {
                // End chat for user
                await set(ref(database, `chats/users/${selectedUserId}`), {
                    active: false,
                    endedAt: Date.now()
                });
                
                showNotificationToast('Chat', 'Conversa encerrada', 'info');
            }
            
            currentChatId = null;
            selectedUserId = null;
            
            chatHeader.innerHTML = `
                <div class="text-lg">üí¨</div>
                <div>
                    <h4 class="font-semibold text-gray-800 dark:text-gray-200">Selecione um usu√°rio</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Para iniciar uma conversa</p>
                </div>
            `;
            
            closeChatBtn.classList.add('hidden');
            chatInputContainer.classList.add('hidden');
            
            chatMessages_dom.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-12 animate-fade-in">
                    <div class="text-4xl mb-4">üí¨</div>
                    <p>Selecione um usu√°rio para come√ßar a conversar</p>
                </div>
            `;
        });

        // Load data from Firebase
        function loadData() {
            // Load products
            const productsRef = ref(database, 'products');
            onValue(productsRef, (snapshot) => {
                products = snapshot.val() || {};
                console.log('Products loaded:', Object.keys(products).length);
                renderProducts();
                updateDashboardStats();
            });

            // Load orders
            const ordersRef = ref(database, 'orders');
            onValue(ordersRef, (snapshot) => {
                orders = snapshot.val() || {};
                console.log('Orders loaded:', Object.keys(orders).length);
                renderOrders();
                updateDashboardStats();
            });
        }

        function updateDashboardStats() {
            const productsCount = Object.keys(products).length;
            const ordersArray = Object.values(orders);
            const pendingCount = ordersArray.filter(order => order.status === 'pending').length;
            const approvedCount = ordersArray.filter(order => order.status === 'approved').length;
            const deliveredCount = ordersArray.filter(order => order.status === 'delivered').length;
            const usersCount = Object.keys(users).length;

            document.getElementById('totalProducts').textContent = productsCount;
            document.getElementById('pendingOrders').textContent = pendingCount;
            document.getElementById('approvedOrders').textContent = approvedCount;
            document.getElementById('deliveredOrders').textContent = deliveredCount;
            document.getElementById('activeUsers').textContent = usersCount;
        }

        // Products functions
        function renderProducts() {
            const productsGrid = document.getElementById('productsGrid');
            const productsArray = Object.entries(products).map(([id, product]) => ({ id, ...product }));
            
            if (productsArray.length === 0) {
                productsGrid.innerHTML = `
                    <div class="col-span-full text-center py-12 animate-fade-in">
                        <div class="text-4xl mb-4">üì¶</div>
                        <p class="text-gray-500 dark:text-gray-400">Nenhum produto cadastrado</p>
                        <button onclick="openProductModal()" class="mt-4 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all transform hover:scale-105">
                            Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = productsArray.map(product => {
                const hasDiscount = product.oldPrice && product.oldPrice > product.price;
                const discountPercent = hasDiscount ? Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100) : 0;
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden animate-fade-in hover:shadow-lg transition-all transform hover:scale-105">
                        <div class="relative aspect-w-1 aspect-h-1 w-full h-48 bg-gray-200 dark:bg-gray-700">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">` :
                                `<div class="w-full h-full flex items-center justify-center">
                                    <div class="text-3xl text-gray-400">üñºÔ∏è</div>
                                </div>`
                            }
                            ${hasDiscount ? `
                                <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded text-xs font-bold animate-bounce-in">
                                    -${discountPercent}%
                                </div>
                            ` : ''}
                            ${product.stock === 0 ? `
                                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                                    <span class="text-white font-bold">Esgotado</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-2 line-clamp-2">${product.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2 capitalize">${getCategoryName(product.category)}</p>
                            
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-lg font-bold text-primary">${formatPrice(product.price)}</span>
                                ${hasDiscount ? `<span class="text-sm text-gray-400 line-through">${formatPrice(product.oldPrice)}</span>` : ''}
                            </div>
                            
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-xs text-gray-500 dark:text-gray-400">
                                    üì¶ ${product.stock} em estoque
                                </span>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button onclick="editProduct('${product.id}')" class="flex-1 bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-400 py-2 px-3 rounded text-sm hover:bg-blue-100 dark:hover:bg-blue-800 transition-all transform hover:scale-105">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="confirmDeleteProduct('${product.id}')" 
                                        onmousedown="startDeleteTimer('${product.id}', this, 'product')" 
                                        onmouseup="cancelDeleteTimer(this)" 
                                        onmouseleave="cancelDeleteTimer(this)"
                                        ontouchstart="startDeleteTimer('${product.id}', this, 'product')" 
                                        ontouchend="cancelDeleteTimer(this)"
                                        class="bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-400 py-2 px-3 rounded text-sm hover:bg-red-100 dark:hover:bg-red-800 transition-all">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Product modal functions
        function openProductModal(productId = null) {
            editingProductId = productId;
            uploadedImageUrl = null;
            
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            const imagePreview = document.getElementById('imagePreview');
            
            // Reset form
            form.reset();
            imagePreview.innerHTML = `
                <div class="w-32 h-32 mx-auto bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                    <div class="text-3xl text-gray-400">üì∑</div>
                </div>
            `;
            
            if (productId) {
                // Edit mode
                title.textContent = 'Editar Produto';
                const product = products[productId];
                if (product) {
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productOldPrice').value = product.oldPrice || '';
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productDescription').value = product.description || '';
                    
                    if (product.image) {
                        imagePreview.innerHTML = `<img src="${product.image}" alt="Preview" class="w-32 h-32 mx-auto rounded-lg object-cover">`;
                        uploadedImageUrl = product.image;
                    }
                }
            } else {
                // Add mode
                title.textContent = 'Adicionar Produto';
            }
            
            modal.classList.remove('hidden');
        }

        // Make functions globally available
        window.openProductModal = openProductModal;
        window.editProduct = openProductModal;

        // Enhanced delete system with long press
        let deleteTimer = null;
        let deleteProgress = 0;
        let deleteProgressInterval = null;

        window.startDeleteTimer = function(itemId, element, type) {
            // Visual feedback
            element.style.position = 'relative';
            element.style.overflow = 'hidden';
            element.innerHTML = 'üóëÔ∏è Segure...';
            
            // Start progress animation
            deleteProgress = 0;
            deleteProgressInterval = setInterval(() => {
                deleteProgress += 5; // 5% every 100ms = 2 seconds total
                element.style.setProperty('--progress', deleteProgress + '%');
                element.classList.add('delete-progress');
                
                if (deleteProgress >= 100) {
                    clearInterval(deleteProgressInterval);
                    if (type === 'product') {
                        deleteProduct(itemId);
                    } else if (type === 'order') {
                        deleteOrder(itemId);
                    }
                    cancelDeleteTimer(element);
                }
            }, 100);
            
            // Backup timer
            deleteTimer = setTimeout(() => {
                if (type === 'product') {
                    deleteProduct(itemId);
                } else if (type === 'order') {
                    deleteOrder(itemId);
                }
                cancelDeleteTimer(element);
            }, 2000);
        };

        window.cancelDeleteTimer = function(element) {
            if (deleteTimer) {
                clearTimeout(deleteTimer);
                deleteTimer = null;
            }
            if (deleteProgressInterval) {
                clearInterval(deleteProgressInterval);
                deleteProgressInterval = null;
            }
            deleteProgress = 0;
            element.style.removeProperty('--progress');
            element.classList.remove('delete-progress');
            element.style.removeProperty('position');
            element.style.removeProperty('overflow');
            element.innerHTML = 'üóëÔ∏è';
        };

        // Delete product with confirmation
        window.confirmDeleteProduct = function(productId) {
            showConfirmDialog(
                `Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.`,
                () => deleteProduct(productId)
            );
        };

        async function deleteProduct(productId) {
            try {
                // Delete from both Realtime Database and Firestore
                await Promise.all([
                    remove(ref(database, `products/${productId}`)),
                    deleteDoc(doc(firestore, 'products', productId))
                ]);
                
                showNotificationToast('Sucesso', 'Produto exclu√≠do com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting product:', error);
                showCustomAlert('Erro ao excluir produto. Tente novamente.');
            }
        }

        // Product form handlers
        document.getElementById('productImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-32 h-32 mx-auto rounded-lg object-cover">`;
                preview.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    preview.style.transform = 'scale(1)';
                }, 200);
            };
            reader.readAsDataURL(file);

            // Upload to ImgBB
            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKeyImgBB}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    uploadedImageUrl = result.data.url;
                    console.log('Image uploaded successfully:', uploadedImageUrl);
                } else {
                    showCustomAlert('Erro ao fazer upload da imagem.');
                }
            } catch (error) {
                console.error('Image upload error:', error);
                showCustomAlert('Erro ao fazer upload da imagem.');
            }
        });

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveProductBtn');
            const saveText = document.getElementById('saveProductText');
            const saveLoader = document.getElementById('saveProductLoader');
            
            // Show loading state
            saveText.classList.add('hidden');
            saveLoader.classList.remove('hidden');
            saveBtn.disabled = true;
            
            try {
                const productData = {
                    name: document.getElementById('productName').value,
                    category: document.getElementById('productCategory').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    oldPrice: parseFloat(document.getElementById('productOldPrice').value) || null,
                    stock: parseInt(document.getElementById('productStock').value),
                    description: document.getElementById('productDescription').value || '',
                    image: uploadedImageUrl || (editingProductId ? products[editingProductId]?.image : null),
                    updatedAt: Date.now()
                };

                if (!editingProductId) {
                    productData.createdAt = Date.now();
                }

                if (editingProductId) {
                    // Update existing product
                    await Promise.all([
                        update(ref(database, `products/${editingProductId}`), productData),
                        setDoc(doc(firestore, 'products', editingProductId), productData, { merge: true })
                    ]);
                    showNotificationToast('Sucesso', 'Produto atualizado com sucesso!', 'success');
                } else {
                    // Create new product
                    const newProductRef = push(ref(database, 'products'));
                    await Promise.all([
                        set(newProductRef, productData),
                        setDoc(doc(firestore, 'products', newProductRef.key), productData)
                    ]);
                    showNotificationToast('Sucesso', 'Produto adicionado com sucesso!', 'success');
                }

                closeProductModal();
            } catch (error) {
                console.error('Error saving product:', error);
                showCustomAlert('Erro ao salvar produto. Tente novamente.');
            } finally {
                // Reset loading state
                saveText.classList.remove('hidden');
                saveLoader.classList.add('hidden');
                saveBtn.disabled = false;
            }
        });

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            editingProductId = null;
            uploadedImageUrl = null;
        }

        document.getElementById('closeProductModalBtn').addEventListener('click', closeProductModal);
        document.getElementById('cancelProductBtn').addEventListener('click', closeProductModal);

        // Orders functions
        function renderOrders() {
            const ordersGrid = document.getElementById('ordersGrid');
            const ordersArray = Object.entries(orders).map(([id, order]) => ({ id, ...order }));
            
            // Apply filter
            let filteredOrders = ordersArray;
            if (currentOrderFilter !== 'all') {
                filteredOrders = ordersArray.filter(order => order.status === currentOrderFilter);
            }
            
            // Sort by creation date (newest first)
            filteredOrders.sort((a, b) => b.createdAt - a.createdAt);
            
            if (filteredOrders.length === 0) {
                ordersGrid.innerHTML = `
                    <div class="text-center py-12 animate-fade-in">
                        <div class="text-4xl mb-4">üì¶</div>
                        <p class="text-gray-500 dark:text-gray-400">
                            ${currentOrderFilter === 'all' ? 'Nenhum pedido encontrado' : `Nenhum pedido ${getStatusText(currentOrderFilter)} encontrado`}
                        </p>
                    </div>
                `;
                return;
            }

            ordersGrid.innerHTML = filteredOrders.map(order => {
                const statusColor = getOrderStatusColor(order.status);
                const statusText = getOrderStatusText(order.status);
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 animate-fade-in hover:shadow-lg transition-all transform hover:scale-105">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Pedido #${order.id.slice(-6)}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${new Date(order.createdAt).toLocaleString('pt-BR')}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                ${statusText}
                            </span>
                        </div>
                        
                        <div class="space-y-3 mb-4">
                            <div>
                                <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">Cliente</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">üìß ${order.customer.email}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">üë§ ${order.customer.name}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">üìû ${order.customer.phone}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">üìç ${order.customer.location}</p>
                                ${order.customer.message ? `<p class="text-sm text-gray-600 dark:text-gray-400">üí¨ ${order.customer.message}</p>` : ''}
                            </div>
                            
                            <div>
                                <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">Itens (${order.items.length})</h4>
                                <div class="space-y-1">
                                    ${order.items.slice(0, 3).map(item => `
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            ${item.quantity}x ${item.name} - ${formatPrice(item.price)}
                                        </p>
                                    `).join('')}
                                    ${order.items.length > 3 ? `<p class="text-sm text-gray-500 dark:text-gray-500">+${order.items.length - 3} mais...</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="pt-2 border-t border-gray-200 dark:border-gray-600">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-800 dark:text-gray-200">Total:</span>
                                    <span class="text-lg font-bold text-primary">${formatPrice(order.total)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2">
                            <button onclick="showOrderDetail('${order.id}')" class="px-3 py-2 bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded text-sm hover:bg-blue-100 dark:hover:bg-blue-800 transition-all transform hover:scale-105">
                                üëÅÔ∏è Ver Detalhes
                            </button>
                            ${order.status === 'pending' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'approved')" class="px-3 py-2 bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded text-sm hover:bg-blue-100 dark:hover:bg-blue-800 transition-all transform hover:scale-105">
                                    ‚úÖ Aprovar
                                </button>
                                <button onclick="updateOrderStatus('${order.id}', 'rejected')" class="px-3 py-2 bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-400 rounded text-sm hover:bg-red-100 dark:hover:bg-red-800 transition-all transform hover:scale-105">
                                    ‚ùå Rejeitar
                                </button>
                            ` : ''}
                            ${order.status === 'approved' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'delivered')" class="px-3 py-2 bg-green-50 dark:bg-green-900 text-green-600 dark:text-green-400 rounded text-sm hover:bg-green-100 dark:hover:bg-green-800 transition-all transform hover:scale-105">
                                    üéâ Marcar como Entregue
                                </button>
                            ` : ''}
                            <button onclick="startChatWithCustomer('${order.customer.userId}')" class="px-3 py-2 bg-purple-50 dark:bg-purple-900 text-purple-600 dark:text-purple-400 rounded text-sm hover:bg-purple-100 dark:hover:bg-purple-800 transition-all transform hover:scale-105">
                                üí¨ Chat
                            </button>
                            <button onclick="confirmDeleteOrder('${order.id}')" 
                                    onmousedown="startDeleteTimer('${order.id}', this, 'order')" 
                                    onmouseup="cancelDeleteTimer(this)" 
                                    onmouseleave="cancelDeleteTimer(this)"
                                    ontouchstart="startDeleteTimer('${order.id}', this, 'order')" 
                                    ontouchend="cancelDeleteTimer(this)"
                                    class="px-3 py-2 bg-gray-50 dark:bg-gray-900 text-gray-600 dark:text-gray-400 rounded text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Order filter functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners to order filter buttons
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update filter buttons
                    document.querySelectorAll('.order-filter-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    
                    currentOrderFilter = btn.dataset.status;
                    renderOrders();
                });
            });
        });

        function filterOrders(status) {
            currentOrderFilter = status;
            
            // Update filter buttons
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            
            const activeBtn = document.querySelector(`.order-filter-btn[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-primary', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            }
            
            renderOrders();
        }

        // Make order functions globally available
        window.showOrderDetail = function(orderId) {
            const order = orders[orderId];
            if (!order) return;
            
            const modal = document.getElementById('orderDetailModal');
            const title = document.getElementById('orderDetailTitle');
            const content = document.getElementById('orderDetailContent');
            
            title.textContent = `Pedido #${orderId.slice(-6)}`;
            
            const statusColor = getOrderStatusColor(order.status);
            const statusText = getOrderStatusText(order.status);
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Informa√ß√µes do Cliente</h4>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-2">
                                <p class="text-sm"><span class="font-medium">Nome:</span> ${order.customer.name}</p>
                                <p class="text-sm"><span class="font-medium">Email:</span> ${order.customer.email}</p>
                                <p class="text-sm"><span class="font-medium">Telefone:</span> ${order.customer.phone}</p>
                                <p class="text-sm"><span class="font-medium">Localiza√ß√£o:</span> ${order.customer.location}</p>
                                ${order.customer.message ? `<p class="text-sm"><span class="font-medium">Mensagem:</span> ${order.customer.message}</p>` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Status do Pedido</h4>
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                    ${statusText}
                                </span>
                                <span class="text-sm text-gray-500 dark:text-gray-400">
                                    ${new Date(order.createdAt).toLocaleString('pt-BR')}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Itens do Pedido</h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="space-y-3">
                                ${order.items.map(item => `
                                    <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-600 last:border-b-0">
                                        <div class="flex-1">
                                            <p class="font-medium text-gray-800 dark:text-gray-200">${item.name}</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Quantidade: ${item.quantity}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-medium text-gray-800 dark:text-gray-200">${formatPrice(item.price * item.quantity)}</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">${formatPrice(item.price)} cada</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="border-t border-gray-200 dark:border-gray-600 pt-3 mt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-bold text-gray-800 dark:text-gray-200">Total:</span>
                                    <span class="text-xl font-bold text-primary">${formatPrice(order.total)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3 pt-6 border-t border-gray-200 dark:border-gray-600">
                    ${order.status === 'pending' ? `
                        <button onclick="updateOrderStatus('${orderId}', 'approved'); closeOrderDetail();" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-all transform hover:scale-105">
                            ‚úÖ Aprovar Pedido
                        </button>
                        <button onclick="updateOrderStatus('${orderId}', 'rejected'); closeOrderDetail();" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-all transform hover:scale-105">
                            ‚ùå Rejeitar Pedido
                        </button>
                    ` : ''}
                    ${order.status === 'approved' ? `
                        <button onclick="updateOrderStatus('${orderId}', 'delivered'); closeOrderDetail();" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-all transform hover:scale-105">
                            üéâ Marcar como Entregue
                        </button>
                    ` : ''}
                    <button onclick="startChatWithCustomer('${order.customer.userId}'); closeOrderDetail();" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-all transform hover:scale-105">
                        üí¨ Conversar com Cliente
                    </button>
                    <button onclick="confirmDeleteOrder('${orderId}'); closeOrderDetail();" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-all transform hover:scale-105">
                        üóëÔ∏è Excluir Pedido
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        };

        window.updateOrderStatus = async function(orderId, newStatus) {
            try {
                const updateData = {
                    status: newStatus,
                    updatedAt: Date.now()
                };

                await Promise.all([
                    update(ref(database, `orders/${orderId}`), updateData),
                    setDoc(doc(firestore, 'orders', orderId), updateData, { merge: true })
                ]);

                const statusText = getOrderStatusText(newStatus);
                showNotificationToast('Sucesso', `Pedido ${statusText.toLowerCase()} com sucesso!`, 'success');

                // Send notification to user
                const order = orders[orderId];
                if (order && order.customer.userId) {
                    const notificationData = {
                        title: 'üì¶ Atualiza√ß√£o do Pedido',
                        message: `Seu pedido #${orderId.slice(-6)} foi ${statusText.toLowerCase()}.`,
                        type: newStatus === 'delivered' ? 'success' : newStatus === 'approved' ? 'info' : 'warning',
                        timestamp: Date.now(),
                        read: false,
                        adminId: currentUser.uid,
                        adminName: currentUser.displayName || currentUser.email
                    };
                    
                    const notificationId = `notif_${Date.now()}`;
                    await Promise.all([
                        set(ref(database, `notifications/${order.customer.userId}/${notificationId}`), notificationData),
                        setDoc(doc(firestore, 'notifications', order.customer.userId, 'messages', notificationId), notificationData)
                    ]);
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showCustomAlert('Erro ao atualizar status do pedido.');
            }
        };

        window.startChatWithCustomer = function(userId) {
            console.log('Starting chat with customer:', userId);
            showSection('chat');
            setTimeout(() => {
                startChat(userId);
            }, 500);
        };

        // Delete order with confirmation and long press
        window.confirmDeleteOrder = function(orderId) {
            showConfirmDialog(
                `Tem certeza que deseja excluir este pedido? Esta a√ß√£o n√£o pode ser desfeita.`,
                () => deleteOrder(orderId)
            );
        };

        async function deleteOrder(orderId) {
            try {
                // Delete from both Realtime Database and Firestore
                await Promise.all([
                    remove(ref(database, `orders/${orderId}`)),
                    deleteDoc(doc(firestore, 'orders', orderId))
                ]);
                
                showNotificationToast('Sucesso', 'Pedido exclu√≠do com sucesso!', 'success');
            } catch (error) {
                console.error('Error deleting order:', error);
                showCustomAlert('Erro ao excluir pedido. Tente novamente.');
            }
        }

        function closeOrderDetail() {
            document.getElementById('orderDetailModal').classList.add('hidden');
        }

        document.getElementById('closeOrderDetailBtn').addEventListener('click', closeOrderDetail);

        // Utility functions
        function formatPrice(price) {
            return `${Math.round(price).toLocaleString('pt-AO')} Kz`;
        }

        function getCategoryName(category) {
            const categoryNames = {
                'eletronicos': 'Eletr√¥nicos',
                'roupas': 'Roupas',
                'casa': 'Casa e Jardim',
                'livros': 'Livros',
                'esportes': 'Esportes',
                'beleza': 'Beleza',
                'acessorios': 'Acess√≥rios & Joias',
                'calcados': 'Cal√ßados',
                'alimentacao': 'Alimenta√ß√£o & Bebidas',
                'saude': 'Sa√∫de & Bem-estar',
                'automotivo': 'Automotivo',
                'brinquedos': 'Brinquedos & Jogos',
                'musica': 'M√∫sica & Instrumentos',
                'arte': 'Arte & Artesanato',
                'pets': 'Pets',
                'servicos': 'Servi√ßos'
            };
            return categoryNames[category] || category;
        }

        function getOrderStatusColor(status) {
            switch (status) {
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                case 'approved':
                    return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                case 'delivered':
                    return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                case 'rejected':
                    return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                default:
                    return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
            }
        }

        function getOrderStatusText(status) {
            switch (status) {
                case 'pending':
                    return 'Pendente';
                case 'approved':
                    return 'Aprovado';
                case 'delivered':
                    return 'Entregue';
                case 'rejected':
                    return 'Rejeitado';
                default:
                    return 'Desconhecido';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'pending':
                    return 'pendente';
                case 'approved':
                    return 'aprovado';
                case 'delivered':
                    return 'entregue';
                case 'rejected':
                    return 'rejeitado';
                default:
                    return '';
            }
        }

        // Enhanced custom alert function
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full animate-scale-in">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-all transform hover:scale-105" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Custom confirm dialog function
        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full animate-scale-in">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Confirmar A√ß√£o</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-all" onclick="this.closest('.fixed').remove()">Cancelar</button>
                        <button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition-all transform hover:scale-105" onclick="this.closest('.fixed').remove(); onConfirm()">Confirmar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Enhanced test notification system function
        window.testNotificationSystem = async function() {
            console.log('üß™ Testing enhanced notification system...');
            
            if (!currentUser) {
                showCustomAlert('Erro: Usu√°rio n√£o autenticado.');
                return;
            }

            try {
                const testNotificationData = {
                    title: 'üß™ Teste do Sistema Aprimorado',
                    message: 'Sistema de notifica√ß√µes em tempo real funcionando! Notifica√ß√µes autom√°ticas, hist√≥rico e sons ativados.',
                    type: 'success',
                    timestamp: Date.now(),
                    read: false,
                    adminId: currentUser.uid,
                    adminName: currentUser.displayName || currentUser.email,
                    isTest: true
                };

                const notificationId = `test_notif_${Date.now()}`;
                const promises = [];
                
                // Send test notification to all available users
                const testUsers = Object.keys(users).filter(userId => userId !== currentUser.uid);
                console.log('üì§ Sending enhanced test notification to users:', testUsers.length);
                
                if (testUsers.length === 0) {
                    showNotificationToast('Aviso', 'Nenhum usu√°rio encontrado para teste. Sistema funcionando, mas sem destinat√°rios.', 'warning');
                    return;
                }

                // Send to Realtime Database for each user
                testUsers.forEach(userId => {
                    promises.push(set(ref(database, `notifications/${userId}/${notificationId}`), testNotificationData));
                });

                // Also send to global notifications
                promises.push(set(ref(database, `notifications/global/${notificationId}`), testNotificationData));

                await Promise.all(promises);
                
                console.log('‚úÖ Enhanced test notification sent successfully');
                showNotificationToast('Sucesso', `Sistema aprimorado! Notifica√ß√£o enviada para ${testUsers.length} usu√°rios com hist√≥rico e sons.`, 'success');
                
                // Show real-time capabilities
                setTimeout(() => {
                    showNotificationToast('Demo', 'Esta √© uma notifica√ß√£o de demonstra√ß√£o do sistema em tempo real!', 'info');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Enhanced test notification failed:', error);
                showCustomAlert(`Falha no teste aprimorado: ${error.message}`);
            }
        };

        // Initialize the app
        setTimeout(() => {
            if (!currentUser) {
                // Trigger Google login
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(error => {
                    console.error('Login error:', error);
                    showAccessDenied();
                });
            }
        }, 2000);
    </script>
</body>
</html>