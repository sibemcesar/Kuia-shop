<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuia+ Admin - Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4845BE',
                        secondary: '#10B981',
                        'secondary-dark': '#059669'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-in': 'bounceIn 0.4s ease-out',
                        'progress': 'progress 2s linear'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        progress: {
                            '0%': { width: '0%' },
                            '100%': { width: '100%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .delete-progress {
            position: relative;
            overflow: hidden;
        }
        
        .delete-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--progress, 0%);
            background: linear-gradient(90deg, #ef4444, #dc2626);
            transition: width 0.1s ease;
            z-index: -1;
        }

        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .debug-panel::-webkit-scrollbar {
            width: 4px;
        }

        .debug-panel::-webkit-scrollbar-track {
            background: #333;
        }

        .debug-panel::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div class="flex justify-between items-center mb-2 border-b border-gray-600 pb-2">
            <strong class="text-yellow-400">üêõ Debug Console</strong>
            <button onclick="toggleDebug()" class="text-red-400 hover:text-red-300">‚ùå</button>
        </div>
        <div id="debugContent" class="text-xs"></div>
        <div class="mt-2 pt-2 border-t border-gray-600">
            <button onclick="clearDebugLogs()" class="text-blue-400 hover:text-blue-300 text-xs">üóëÔ∏è Limpar</button>
            <button onclick="exportDebugLogs()" class="ml-2 text-green-400 hover:text-green-300 text-xs">üìã Copiar</button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">Kuia+ Admin</h2>
            <p id="loadingStatus" class="text-gray-600 dark:text-gray-400">Verificando acesso...</p>
            <button onclick="toggleDebug()" class="mt-4 text-xs text-gray-500 hover:text-gray-700 px-3 py-1 border rounded">üêõ Debug Mode</button>
        </div>
    </div>

    <!-- Access Denied Screen -->
    <div id="accessDeniedScreen" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-40 hidden">
        <div class="text-center max-w-md animate-scale-in">
            <div class="text-6xl mb-6">üö´</div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Acesso Negado</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Voc√™ n√£o tem permiss√£o para acessar o painel administrativo.</p>
            <div class="space-y-3">
                <button onclick="forceAdminAccess()" class="block w-full px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-all">
                    üîì For√ßar Acesso (sibemcesar@gmail.com)
                </button>
                <button onclick="location.reload()" class="block w-full px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all">
                    üîÑ Tentar Novamente
                </button>
                <button onclick="toggleDebug()" class="block w-full px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-all">
                    üêõ Ver Debug
                </button>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen">
        <!-- Notification Area -->
        <div id="notificationArea" class="fixed top-4 right-4 z-40 space-y-2 max-w-sm"></div>

        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-primary">‚öôÔ∏è Kuia+ Admin</h1>
                        <nav class="hidden md:flex space-x-6">
                            <button id="dashboardBtn" class="nav-btn text-primary px-3 py-2 rounded-md text-sm font-medium">
                                üìä Dashboard
                            </button>
                            <button id="productsBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">
                                üì¶ Produtos
                            </button>
                            <button id="categoriesBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">
                                üìÇ Categorias
                            </button>
                            <button id="notificationsBtn" class="nav-btn text-gray-700 dark:text-gray-300 hover:text-primary px-3 py-2 rounded-md text-sm font-medium">
                                üîî Notifica√ß√µes
                            </button>
                        </nav>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleDebug()" class="px-3 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
                            üêõ
                        </button>
                        <div class="text-xs text-gray-500" id="userInfo"></div>
                        <button id="logoutBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                            üö™ Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Dashboard</h2>
                    <p class="text-gray-600 dark:text-gray-400">Painel administrativo da Kuia+</p>
                </div>

                <!-- Connection Status -->
                <div id="connectionStatus" class="mb-6 p-4 rounded-lg border"></div>

                <!-- User Info Card -->
                <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Informa√ß√µes do Usu√°rio</h3>
                    <div id="userInfoDetails" class="space-y-2 text-sm">
                        <!-- Will be populated -->
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <div class="text-2xl">üì¶</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Produtos</p>
                                <p id="totalProducts" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg">
                                <div class="text-2xl">üìÇ</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Categorias</p>
                                <p id="totalCategories" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                                <div class="text-2xl">üë•</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Usu√°rios</p>
                                <p id="totalUsers" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 dark:bg-red-900 rounded-lg">
                                <div class="text-2xl">üî•</div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Admin Status</p>
                                <p id="adminStatus" class="text-lg font-bold text-gray-900 dark:text-gray-100">Verificando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Tools -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Ferramentas de Teste</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button onclick="testConnection()" class="flex items-center p-4 bg-blue-50 dark:bg-blue-900 hover:bg-blue-100 dark:hover:bg-blue-800 rounded-lg transition-all">
                            <div class="text-2xl mr-3">üîó</div>
                            <div class="text-left">
                                <p class="font-medium text-blue-700 dark:text-blue-300">Testar Conex√£o</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Firebase</p>
                            </div>
                        </button>
                        
                        <button onclick="testAdminAccess()" class="flex items-center p-4 bg-green-50 dark:bg-green-900 hover:bg-green-100 dark:hover:bg-green-800 rounded-lg transition-all">
                            <div class="text-2xl mr-3">üîê</div>
                            <div class="text-left">
                                <p class="font-medium text-green-700 dark:text-green-300">Testar Admin</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Permiss√µes</p>
                            </div>
                        </button>
                        
                        <button onclick="testCategoryCreation()" class="flex items-center p-4 bg-yellow-50 dark:bg-yellow-900 hover:bg-yellow-100 dark:hover:bg-yellow-800 rounded-lg transition-all">
                            <div class="text-2xl mr-3">üìÇ</div>
                            <div class="text-left">
                                <p class="font-medium text-yellow-700 dark:text-yellow-300">Testar Categoria</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Cria√ß√£o</p>
                            </div>
                        </button>
                        
                        <button onclick="openCategoryModal()" class="flex items-center p-4 bg-purple-50 dark:bg-purple-900 hover:bg-purple-100 dark:hover:bg-purple-800 rounded-lg transition-all">
                            <div class="text-2xl mr-3">‚ûï</div>
                            <div class="text-left">
                                <p class="font-medium text-purple-700 dark:text-purple-300">Nova Categoria</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Criar agora</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="productsSection" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Produtos</h2>
                        <p class="text-gray-600 dark:text-gray-400">Gerencie os produtos da loja</p>
                    </div>
                    <button onclick="openProductModal()" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark">
                        ‚ûï Adicionar Produto
                    </button>
                </div>

                <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Products will be rendered here -->
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categoriesSection" class="hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Categorias</h2>
                        <p class="text-gray-600 dark:text-gray-400">Organize os produtos por categoria</p>
                    </div>
                    <button onclick="openCategoryModal()" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-secondary-dark">
                        ‚ûï Adicionar Categoria
                    </button>
                </div>

                <div id="categoriesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Categories will be rendered here -->
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notificationsSection" class="hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">Notifica√ß√µes</h2>
                    <p class="text-gray-600 dark:text-gray-400">Envie notifica√ß√µes para os usu√°rios</p>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Teste de Notifica√ß√£o</h3>
                    <button onclick="sendTestNotification()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                        üîî Enviar Teste
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full animate-scale-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="categoryModalTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-200">Adicionar Categoria</h3>
                    <button onclick="closeCategoryModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚ùå</button>
                </div>
                
                <form id="categoryForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome da Categoria *</label>
                            <input type="text" id="categoryName" required placeholder="Ex: Eletr√¥nicos, Roupas..." 
                                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">√çcone</label>
                            <div class="grid grid-cols-8 gap-2 p-3 border border-gray-300 dark:border-gray-600 rounded-lg">
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded bg-primary text-white" data-icon="üìÇ">üìÇ</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="üì±">üì±</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="üëï">üëï</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="üè†">üè†</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="üìö">üìö</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="‚öΩ">‚öΩ</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="üíÑ">üíÑ</button>
                                <button type="button" class="icon-btn p-2 text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-icon="üçî">üçî</button>
                            </div>
                            <input type="hidden" id="categoryIcon" value="üìÇ">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">√çcone selecionado: <span id="selectedIcon">üìÇ</span></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descri√ß√£o</label>
                            <textarea id="categoryDescription" rows="3" placeholder="Descri√ß√£o opcional da categoria..." 
                                      class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Cancelar
                        </button>
                        <button type="submit" id="saveCategoryBtn" class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-dark">
                            <span id="saveCategoryText">Salvar Categoria</span>
                            <span id="saveCategoryLoader" class="hidden">Salvando...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto animate-scale-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="productModalTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-200">Adicionar Produto</h3>
                    <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700 text-xl">‚ùå</button>
                </div>
                
                <form id="productForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome do Produto *</label>
                            <input type="text" id="productName" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria *</label>
                            <select id="productCategory" required class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Selecione uma categoria</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pre√ßo *</label>
                                <input type="number" id="productPrice" required min="0" step="0.01" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estoque *</label>
                                <input type="number" id="productStock" required min="0" value="1" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descri√ß√£o</label>
                            <textarea id="productDescription" rows="3" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeProductModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Cancelar
                        </button>
                        <button type="submit" id="saveProductBtn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark">
                            <span id="saveProductText">Salvar Produto</span>
                            <span id="saveProductLoader" class="hidden">Salvando...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and Main JavaScript -->
    <script type="module">
        console.log('üöÄ Iniciando Kuia+ Admin...');

        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getDatabase, ref, onValue, push, set, remove, update } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArmhNnjraGaY017AP5uRcM8w0WWditrIs",
            authDomain: "kuia-shop.firebaseapp.com",
            projectId: "kuia-shop",
            storageBucket: "kuia-shop.appspot.com",
            messagingSenderId: "53786495493",
            appId: "1:53786495493:web:85fa67bd5de1d351b1ea6c",
            measurementId: "G-LTZ8VLN3LN"
        };

        // Initialize Firebase
        let app, auth, database, firestore;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);
            firestore = getFirestore(app);
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            addDebugLog('Firebase Init Error: ' + error.message);
        }

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let products = {};
        let categories = {};
        let users = {};
        let editingCategoryId = null;
        let editingProductId = null;

        // Debug system
        let debugLogs = [];
        
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push(logEntry);
            console.log(`üêõ ${message}`);
            
            if (debugLogs.length > 100) {
                debugLogs = debugLogs.slice(-100);
            }
            
            updateDebugPanel();
        }

        function updateDebugPanel() {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugLogs.slice(-20).map(log => 
                    `<div class="text-green-300 mb-1">${log}</div>`
                ).join('');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('hidden');
        }

        function clearDebugLogs() {
            debugLogs = [];
            updateDebugPanel();
            addDebugLog('Debug logs cleared');
        }

        function exportDebugLogs() {
            const logsText = debugLogs.join('\n');
            navigator.clipboard.writeText(logsText).then(() => {
                addDebugLog('Debug logs copied to clipboard');
            }).catch(err => {
                addDebugLog('Failed to copy logs: ' + err.message);
            });
        }

        // Make functions globally available
        window.toggleDebug = toggleDebug;
        window.clearDebugLogs = clearDebugLogs;
        window.exportDebugLogs = exportDebugLogs;

        addDebugLog('Debug system initialized');

        // Enhanced notification system
        function showNotificationToast(title, message, type = 'info') {
            addDebugLog(`Notification: ${type} - ${title}: ${message}`);
            
            const toast = document.createElement('div');
            const typeColors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            
            toast.className = `${typeColors[type]} text-white p-4 rounded-lg shadow-lg animate-bounce-in`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold">${title}</h4>
                        <p class="text-sm opacity-90">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:opacity-75 ml-4">‚ùå</button>
                </div>
            `;
            
            document.getElementById('notificationArea').appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Connection status
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            
            try {
                const testRef = ref(database, '.info/connected');
                onValue(testRef, (snapshot) => {
                    const connected = snapshot.val();
                    addDebugLog(`Firebase connection status: ${connected}`);
                    
                    if (connected) {
                        statusEl.className = 'mb-6 p-4 rounded-lg border bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700';
                        statusEl.innerHTML = `
                            <div class="flex items-center">
                                <div class="text-green-500 mr-2">‚úÖ</div>
                                <div>
                                    <h4 class="font-medium text-green-800 dark:text-green-200">Conex√£o Ativa</h4>
                                    <p class="text-sm text-green-600 dark:text-green-400">Firebase Realtime Database conectado</p>
                                </div>
                            </div>
                        `;
                    } else {
                        statusEl.className = 'mb-6 p-4 rounded-lg border bg-red-50 dark:bg-red-900 border-red-200 dark:border-red-700';
                        statusEl.innerHTML = `
                            <div class="flex items-center">
                                <div class="text-red-500 mr-2">‚ùå</div>
                                <div>
                                    <h4 class="font-medium text-red-800 dark:text-red-200">Sem Conex√£o</h4>
                                    <p class="text-sm text-red-600 dark:text-red-400">Problemas de conectividade</p>
                                </div>
                            </div>
                        `;
                    }
                });
            } catch (error) {
                addDebugLog('Connection test error: ' + error.message);
            }
        }

        // Authentication with enhanced debugging
        onAuthStateChanged(auth, async (user) => {
            addDebugLog(`Auth state changed. User: ${user ? user.email : 'null'}`);
            currentUser = user;
            
            if (user) {
                addDebugLog(`User authenticated: ${user.email}, UID: ${user.uid}`);
                addDebugLog(`User display name: ${user.displayName}`);
                addDebugLog(`User photo URL: ${user.photoURL}`);
                
                // Update user info in UI
                updateUserInfo();
                
                // Check admin access
                await checkAdminAccess();
            } else {
                addDebugLog('No user authenticated, triggering login');
                triggerLogin();
            }
        });

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            const userInfoDetails = document.getElementById('userInfoDetails');
            
            if (userInfo) {
                userInfo.textContent = currentUser.email;
            }
            
            if (userInfoDetails) {
                userInfoDetails.innerHTML = `
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>UID:</strong> ${currentUser.uid}</p>
                    <p><strong>Nome:</strong> ${currentUser.displayName || 'N√£o definido'}</p>
                    <p><strong>Foto:</strong> ${currentUser.photoURL ? 'Sim' : 'N√£o'}</p>
                    <p><strong>Verificado:</strong> ${currentUser.emailVerified ? 'Sim' : 'N√£o'}</p>
                `;
            }
        }

        async function triggerLogin() {
            const provider = new GoogleAuthProvider();
            try {
                addDebugLog('Starting Google sign-in popup');
                const result = await signInWithPopup(auth, provider);
                addDebugLog('Login successful: ' + result.user.email);
            } catch (error) {
                addDebugLog('Login error: ' + error.message);
                showAccessDenied();
            }
        }

        async function checkAdminAccess() {
            try {
                document.getElementById('loadingStatus').textContent = 'Verificando permiss√µes...';
                addDebugLog('Checking admin access...');
                
                // First check if user is super admin by email
                if (currentUser.email === 'sibemcesar@gmail.com') {
                    addDebugLog('Super admin detected by email');
                    isAdmin = true;
                    await ensureAdminAccess();
                    showAdminPanel();
                    return;
                }
                
                // Check admin documents
                await checkAdminDocuments();
                
            } catch (error) {
                addDebugLog('Error checking admin access: ' + error.message);
                showAccessDenied();
            }
        }

        async function checkAdminDocuments() {
            addDebugLog('Checking admin documents...');
            
            try {
                // Check Firestore
                const firestoreAdminDoc = await getDoc(doc(firestore, 'admins', currentUser.uid));
                addDebugLog(`Firestore admin doc exists: ${firestoreAdminDoc.exists()}`);
                
                if (firestoreAdminDoc.exists()) {
                    addDebugLog('Admin access found in Firestore');
                    isAdmin = true;
                    showAdminPanel();
                    return;
                }
                
                // Check Realtime Database
                const realtimeAdminRef = ref(database, `admins/${currentUser.uid}`);
                onValue(realtimeAdminRef, (snapshot) => {
                    const exists = snapshot.exists();
                    addDebugLog(`Realtime Database admin doc exists: ${exists}`);
                    
                    if (exists) {
                        addDebugLog('Admin access found in Realtime Database');
                        isAdmin = true;
                        showAdminPanel();
                    } else {
                        addDebugLog('No admin access found');
                        showAccessDenied();
                    }
                }, { onlyOnce: true });
                
            } catch (error) {
                addDebugLog('Error checking admin documents: ' + error.message);
                showAccessDenied();
            }
        }

        async function ensureAdminAccess() {
            try {
                addDebugLog('Ensuring admin access...');
                
                const adminData = {
                    email: currentUser.email,
                    name: currentUser.displayName || 'Super Admin',
                    role: 'super_admin',
                    createdAt: Date.now(),
                    lastLogin: Date.now()
                };
                
                // Save to both databases
                const promises = [
                    set(ref(database, `admins/${currentUser.uid}`), adminData),
                    setDoc(doc(firestore, 'admins', currentUser.uid), adminData)
                ];
                
                await Promise.all(promises);
                addDebugLog('Admin access ensured in both databases');
                
            } catch (error) {
                addDebugLog('Error ensuring admin access: ' + error.message);
                // Continue anyway for super admin
            }
        }

        // Force admin access function
        async function forceAdminAccess() {
            addDebugLog('Forcing admin access...');
            
            if (!currentUser) {
                addDebugLog('No current user, cannot force access');
                return;
            }
            
            if (currentUser.email !== 'sibemcesar@gmail.com') {
                addDebugLog('User is not super admin, cannot force access');
                showNotificationToast('Erro', 'Apenas sibemcesar@gmail.com pode for√ßar acesso', 'error');
                return;
            }
            
            try {
                await ensureAdminAccess();
                isAdmin = true;
                showAdminPanel();
                showNotificationToast('Sucesso', 'Acesso administrativo for√ßado com sucesso!', 'success');
            } catch (error) {
                addDebugLog('Error forcing admin access: ' + error.message);
                showNotificationToast('Erro', 'Erro ao for√ßar acesso: ' + error.message, 'error');
            }
        }

        window.forceAdminAccess = forceAdminAccess;

        function showAdminPanel() {
            addDebugLog('Showing admin panel...');
            document.getElementById('adminStatus').textContent = 'Ativo ‚úÖ';
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('accessDeniedScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            
            // Load data and initialize
            loadData();
            updateConnectionStatus();
        }

        function showAccessDenied() {
            addDebugLog('Showing access denied screen');
            document.getElementById('adminStatus').textContent = 'Negado ‚ùå';
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('accessDeniedScreen').classList.remove('hidden');
        }

        // Data loading
        function loadData() {
            addDebugLog('Loading data from Firebase...');
            
            // Load categories
            const categoriesRef = ref(database, 'categories');
            onValue(categoriesRef, (snapshot) => {
                categories = snapshot.val() || {};
                addDebugLog(`Categories loaded: ${Object.keys(categories).length}`);
                renderCategories();
                updateStats();
                updateProductCategorySelect();
            }, (error) => {
                addDebugLog('Error loading categories: ' + error.message);
            });
            
            // Load products
            const productsRef = ref(database, 'products');
            onValue(productsRef, (snapshot) => {
                products = snapshot.val() || {};
                addDebugLog(`Products loaded: ${Object.keys(products).length}`);
                renderProducts();
                updateStats();
            }, (error) => {
                addDebugLog('Error loading products: ' + error.message);
            });

            // Load users
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                users = snapshot.val() || {};
                addDebugLog(`Users loaded: ${Object.keys(users).length}`);
                updateStats();
            }, (error) => {
                addDebugLog('Error loading users: ' + error.message);
            });
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = Object.keys(products).length;
            document.getElementById('totalCategories').textContent = Object.keys(categories).length;
            document.getElementById('totalUsers').textContent = Object.keys(users).length;
        }

        // Categories management
        function renderCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            const categoriesArray = Object.entries(categories).map(([id, category]) => ({ id, ...category }));
            
            if (categoriesArray.length === 0) {
                categoriesGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-4xl mb-4">üìÇ</div>
                        <p class="text-gray-500 dark:text-gray-400">Nenhuma categoria cadastrada</p>
                        <button onclick="openCategoryModal()" class="mt-4 px-6 py-3 bg-secondary text-white rounded-lg hover:bg-secondary-dark">
                            Criar Primeira Categoria
                        </button>
                    </div>
                `;
                return;
            }

            categoriesGrid.innerHTML = categoriesArray.map(category => {
                const productCount = Object.values(products).filter(p => p.category === category.id).length;
                
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-all">
                        <div class="p-6 text-center">
                            <div class="text-4xl mb-4">${category.icon || 'üìÇ'}</div>
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">${category.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${category.description || 'Sem descri√ß√£o'}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500 mb-4">${productCount} produtos</p>
                            
                            <div class="flex space-x-2 justify-center">
                                <button onclick="editCategory('${category.id}')" class="px-3 py-2 bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-400 rounded text-sm hover:bg-blue-100 dark:hover:bg-blue-800">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteCategory('${category.id}')" class="px-3 py-2 bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-400 rounded text-sm hover:bg-red-100 dark:hover:bg-red-800">
                                    üóëÔ∏è Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openCategoryModal(categoryId = null) {
            addDebugLog(`Opening category modal. Edit ID: ${categoryId}`);
            editingCategoryId = categoryId;
            
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const form = document.getElementById('categoryForm');
            
            // Reset form
            form.reset();
            document.getElementById('categoryIcon').value = 'üìÇ';
            document.getElementById('selectedIcon').textContent = 'üìÇ';
            
            // Reset icon buttons
            document.querySelectorAll('.icon-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });
            
            // Set default icon as selected
            const defaultIconBtn = document.querySelector('[data-icon="üìÇ"]');
            if (defaultIconBtn) {
                defaultIconBtn.classList.add('bg-primary', 'text-white');
                defaultIconBtn.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            }
            
            if (categoryId && categories[categoryId]) {
                // Edit mode
                title.textContent = 'Editar Categoria';
                const category = categories[categoryId];
                
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryIcon').value = category.icon || 'üìÇ';
                document.getElementById('selectedIcon').textContent = category.icon || 'üìÇ';
                
                // Highlight selected icon
                document.querySelectorAll('.icon-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                });
                
                const selectedBtn = document.querySelector(`[data-icon="${category.icon}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('bg-primary', 'text-white');
                    selectedBtn.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
            } else {
                // Add mode
                title.textContent = 'Adicionar Categoria';
            }
            
            modal.classList.remove('hidden');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
            editingCategoryId = null;
        }

        // Category form submission
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            addDebugLog('Category form submitted');
            
            const saveBtn = document.getElementById('saveCategoryBtn');
            const saveText = document.getElementById('saveCategoryText');
            const saveLoader = document.getElementById('saveCategoryLoader');
            
            // Get form data
            const name = document.getElementById('categoryName').value.trim();
            const icon = document.getElementById('categoryIcon').value;
            const description = document.getElementById('categoryDescription').value.trim();
            
            addDebugLog(`Form data - Name: ${name}, Icon: ${icon}, Description: ${description}`);
            
            // Validation
            if (!name) {
                addDebugLog('Validation error: empty category name');
                showNotificationToast('Erro', 'Por favor, insira o nome da categoria.', 'error');
                return;
            }
            
            if (name.length < 2) {
                addDebugLog('Validation error: category name too short');
                showNotificationToast('Erro', 'O nome da categoria deve ter pelo menos 2 caracteres.', 'error');
                return;
            }
            
            // Show loading state
            saveText.classList.add('hidden');
            saveLoader.classList.remove('hidden');
            saveBtn.disabled = true;
            
            try {
                let categoryId;
                
                if (editingCategoryId) {
                    categoryId = editingCategoryId;
                    addDebugLog(`Editing existing category: ${categoryId}`);
                } else {
                    // Generate a safe category ID
                    categoryId = name.toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]/g, '_')
                        .replace(/_+/g, '_')
                        .replace(/^_|_$/g, '')
                        .slice(0, 50);
                    
                    // Ensure uniqueness
                    if (categories[categoryId]) {
                        categoryId = `${categoryId}_${Date.now()}`;
                    }
                    
                    // Validate final ID
                    if (!categoryId || categoryId.length < 1) {
                        categoryId = `categoria_${Date.now()}`;
                    }
                    
                    addDebugLog(`Generated category ID: ${categoryId}`);
                }
                
                const categoryData = {
                    id: categoryId,
                    name: name,
                    icon: icon,
                    description: description,
                    updatedAt: Date.now()
                };

                if (!editingCategoryId) {
                    categoryData.createdAt = Date.now();
                }

                addDebugLog(`Saving category data to path: categories/${categoryId}`);
                addDebugLog(`Category data: ${JSON.stringify(categoryData)}`);

                // Save to Realtime Database (priority)
                const dbRef = ref(database, `categories/${categoryId}`);
                await set(dbRef, categoryData);
                addDebugLog('Category saved to Realtime Database successfully');

                // Try to save to Firestore (secondary)
                try {
                    await setDoc(doc(firestore, 'categories', categoryId), categoryData);
                    addDebugLog('Category saved to Firestore successfully');
                } catch (firestoreError) {
                    addDebugLog('Firestore save failed (non-critical): ' + firestoreError.message);
                }

                const action = editingCategoryId ? 'atualizada' : 'adicionada';
                showNotificationToast('Sucesso', `Categoria "${name}" ${action} com sucesso!`, 'success');
                
                closeCategoryModal();
                
            } catch (error) {
                addDebugLog('Error saving category: ' + error.message);
                addDebugLog('Error details: ' + JSON.stringify(error));
                showNotificationToast('Erro', 'Erro ao salvar categoria: ' + error.message, 'error');
            } finally {
                // Reset loading state
                saveText.classList.remove('hidden');
                saveLoader.classList.add('hidden');
                saveBtn.disabled = false;
            }
        });

        // Products management
        function renderProducts() {
            const productsGrid = document.getElementById('productsGrid');
            const productsArray = Object.entries(products).map(([id, product]) => ({ id, ...product }));
            
            if (productsArray.length === 0) {
                productsGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-4xl mb-4">üì¶</div>
                        <p class="text-gray-500 dark:text-gray-400">Nenhum produto cadastrado</p>
                        <button onclick="openProductModal()" class="mt-4 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark">
                            Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }

            productsGrid.innerHTML = productsArray.map(product => {
                const category = categories[product.category];
                return `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-all">
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">${product.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${category ? `${category.icon} ${category.name}` : 'Sem categoria'}</p>
                            <p class="text-lg font-bold text-primary mb-2">${formatPrice(product.price || 0)}</p>
                            <p class="text-xs text-gray-500 mb-4">Estoque: ${product.stock || 0}</p>
                            
                            <div class="flex space-x-2">
                                <button onclick="editProduct('${product.id}')" class="flex-1 bg-blue-50 text-blue-600 py-2 px-3 rounded text-sm hover:bg-blue-100">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteProduct('${product.id}')" class="bg-red-50 text-red-600 py-2 px-3 rounded text-sm hover:bg-red-100">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openProductModal(productId = null) {
            addDebugLog(`Opening product modal. Edit ID: ${productId}`);
            editingProductId = productId;
            
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            
            // Reset form
            form.reset();
            
            // Update category options
            updateProductCategorySelect();
            
            if (productId && products[productId]) {
                // Edit mode
                title.textContent = 'Editar Produto';
                const product = products[productId];
                
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productDescription').value = product.description || '';
            } else {
                // Add mode
                title.textContent = 'Adicionar Produto';
            }
            
            modal.classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            editingProductId = null;
        }

        function updateProductCategorySelect() {
            const select = document.getElementById('productCategory');
            if (!select) return;
            
            const categoriesArray = Object.entries(categories).map(([id, category]) => ({ id, ...category }));
            
            select.innerHTML = `
                <option value="">Selecione uma categoria</option>
                ${categoriesArray.map(category => 
                    `<option value="${category.id}">${category.icon} ${category.name}</option>`
                ).join('')}
            `;
            
            addDebugLog(`Product category select updated with ${categoriesArray.length} categories`);
        }

        // Product form submission
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            addDebugLog('Product form submitted');
            
            const saveBtn = document.getElementById('saveProductBtn');
            const saveText = document.getElementById('saveProductText');
            const saveLoader = document.getElementById('saveProductLoader');
            
            // Get form data
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const description = document.getElementById('productDescription').value.trim();
            
            addDebugLog(`Form data - Name: ${name}, Category: ${category}, Price: ${price}, Stock: ${stock}`);
            
            // Validation
            if (!name) {
                addDebugLog('Validation error: empty product name');
                showNotificationToast('Erro', 'Por favor, insira o nome do produto.', 'error');
                return;
            }
            
            if (!category) {
                addDebugLog('Validation error: no category selected');
                showNotificationToast('Erro', 'Por favor, selecione uma categoria.', 'error');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                addDebugLog('Validation error: invalid price');
                showNotificationToast('Erro', 'Por favor, insira um pre√ßo v√°lido.', 'error');
                return;
            }
            
            if (isNaN(stock) || stock < 0) {
                addDebugLog('Validation error: invalid stock');
                showNotificationToast('Erro', 'Por favor, insira um estoque v√°lido.', 'error');
                return;
            }
            
            // Show loading state
            saveText.classList.add('hidden');
            saveLoader.classList.remove('hidden');
            saveBtn.disabled = true;
            
            try {
                const productData = {
                    name: name,
                    category: category,
                    price: price,
                    stock: stock,
                    description: description,
                    updatedAt: Date.now()
                };

                if (editingProductId) {
                    // Update existing product
                    addDebugLog(`Updating product: ${editingProductId}`);
                    
                    await update(ref(database, `products/${editingProductId}`), productData);
                    addDebugLog('Product updated in Realtime Database');
                    
                    showNotificationToast('Sucesso', 'Produto atualizado com sucesso!', 'success');
                } else {
                    // Create new product
                    addDebugLog('Creating new product');
                    productData.createdAt = Date.now();
                    
                    const newProductRef = push(ref(database, 'products'));
                    const productId = newProductRef.key;
                    
                    await set(newProductRef, productData);
                    addDebugLog('Product created in Realtime Database with ID: ' + productId);
                    
                    showNotificationToast('Sucesso', 'Produto adicionado com sucesso!', 'success');
                }

                closeProductModal();
                
            } catch (error) {
                addDebugLog('Error saving product: ' + error.message);
                showNotificationToast('Erro', 'Erro ao salvar produto: ' + error.message, 'error');
            } finally {
                // Reset loading state
                saveText.classList.remove('hidden');
                saveLoader.classList.add('hidden');
                saveBtn.disabled = false;
            }
        });

        // Delete functions
        async function deleteCategory(categoryId) {
            addDebugLog(`Deleting category: ${categoryId}`);
            
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) {
                return;
            }
            
            try {
                await remove(ref(database, `categories/${categoryId}`));
                addDebugLog('Category deleted successfully');
                showNotificationToast('Sucesso', 'Categoria exclu√≠da com sucesso!', 'success');
            } catch (error) {
                addDebugLog('Error deleting category: ' + error.message);
                showNotificationToast('Erro', 'Erro ao excluir categoria: ' + error.message, 'error');
            }
        }

        async function deleteProduct(productId) {
            addDebugLog(`Deleting product: ${productId}`);
            
            if (!confirm('Tem certeza que deseja excluir este produto?')) {
                return;
            }
            
            try {
                await remove(ref(database, `products/${productId}`));
                addDebugLog('Product deleted successfully');
                showNotificationToast('Sucesso', 'Produto exclu√≠do com sucesso!', 'success');
            } catch (error) {
                addDebugLog('Error deleting product: ' + error.message);
                showNotificationToast('Erro', 'Erro ao excluir produto: ' + error.message, 'error');
            }
        }

        // Test functions
        async function testConnection() {
            addDebugLog('Testing Firebase connection...');
            showNotificationToast('Teste', 'Testando conex√£o...', 'info');
            
            try {
                const testRef = ref(database, `test/${Date.now()}`);
                await set(testRef, { test: true, timestamp: Date.now() });
                addDebugLog('Connection test successful');
                
                await remove(testRef);
                addDebugLog('Test data cleaned up');
                
                showNotificationToast('Sucesso', 'Conex√£o funcionando!', 'success');
            } catch (error) {
                addDebugLog('Connection test failed: ' + error.message);
                showNotificationToast('Erro', 'Falha na conex√£o: ' + error.message, 'error');
            }
        }

        async function testAdminAccess() {
            addDebugLog('Testing admin access...');
            showNotificationToast('Teste', 'Testando permiss√µes administrativas...', 'info');
            
            try {
                // Test write to admins path
                const testRef = ref(database, `admins/${currentUser.uid}/test`);
                await set(testRef, { test: true, timestamp: Date.now() });
                addDebugLog('Admin write test successful');
                
                await remove(testRef);
                addDebugLog('Admin test data cleaned up');
                
                showNotificationToast('Sucesso', 'Permiss√µes administrativas funcionando!', 'success');
            } catch (error) {
                addDebugLog('Admin access test failed: ' + error.message);
                showNotificationToast('Erro', 'Falha nas permiss√µes: ' + error.message, 'error');
            }
        }

        async function testCategoryCreation() {
            addDebugLog('Testing category creation...');
            showNotificationToast('Teste', 'Testando cria√ß√£o de categoria...', 'info');
            
            try {
                const testCategoryId = `test_category_${Date.now()}`;
                const testCategoryData = {
                    id: testCategoryId,
                    name: 'Categoria de Teste',
                    icon: 'üß™',
                    description: 'Esta √© uma categoria de teste',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                addDebugLog(`Creating test category with ID: ${testCategoryId}`);
                
                const categoryRef = ref(database, `categories/${testCategoryId}`);
                await set(categoryRef, testCategoryData);
                addDebugLog('Test category created successfully');
                
                // Clean up
                await remove(categoryRef);
                addDebugLog('Test category cleaned up');
                
                showNotificationToast('Sucesso', 'Cria√ß√£o de categoria funcionando!', 'success');
            } catch (error) {
                addDebugLog('Category creation test failed: ' + error.message);
                showNotificationToast('Erro', 'Falha na cria√ß√£o: ' + error.message, 'error');
            }
        }

        async function sendTestNotification() {
            addDebugLog('Sending test notification...');
            showNotificationToast('Teste', 'Esta √© uma notifica√ß√£o de teste!', 'success');
        }

        // Navigation
        function showSection(section) {
            addDebugLog(`Showing section: ${section}`);
            
            // Hide all sections
            ['dashboard', 'products', 'categories', 'notifications'].forEach(sec => {
                document.getElementById(`${sec}Section`).classList.add('hidden');
            });
            
            // Show target section
            document.getElementById(`${section}Section`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary');
                btn.classList.add('text-gray-700', 'dark:text-gray-300');
            });
            
            document.getElementById(`${section}Btn`)?.classList.add('text-primary');
        }

        // Icon selection
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('icon-btn')) {
                e.preventDefault();
                
                // Reset all icon buttons
                document.querySelectorAll('.icon-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                });
                
                // Highlight selected icon
                e.target.classList.add('bg-primary', 'text-white');
                e.target.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                
                // Update form values
                const icon = e.target.dataset.icon;
                document.getElementById('categoryIcon').value = icon;
                document.getElementById('selectedIcon').textContent = icon;
                
                addDebugLog(`Icon selected: ${icon}`);
            }
        });

        // Utility functions
        function formatPrice(price) {
            return `${Math.round(price).toLocaleString('pt-AO')} Kz`;
        }

        // Make functions globally available
        window.openCategoryModal = openCategoryModal;
        window.closeCategoryModal = closeCategoryModal;
        window.editCategory = (categoryId) => openCategoryModal(categoryId);
        window.deleteCategory = deleteCategory;
        window.openProductModal = openProductModal;
        window.closeProductModal = closeProductModal;
        window.editProduct = (productId) => openProductModal(productId);
        window.deleteProduct = deleteProduct;
        window.showSection = showSection;
        window.testConnection = testConnection;
        window.testAdminAccess = testAdminAccess;
        window.testCategoryCreation = testCategoryCreation;
        window.sendTestNotification = sendTestNotification;

        // Event listeners
        document.getElementById('dashboardBtn').addEventListener('click', () => showSection('dashboard'));
        document.getElementById('productsBtn').addEventListener('click', () => showSection('products'));
        document.getElementById('categoriesBtn').addEventListener('click', () => showSection('categories'));
        document.getElementById('notificationsBtn').addEventListener('click', () => showSection('notifications'));

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.reload();
            } catch (error) {
                addDebugLog('Logout error: ' + error.message);
            }
        });

        addDebugLog('Admin panel initialization complete');
    </script>
</body>
</html>